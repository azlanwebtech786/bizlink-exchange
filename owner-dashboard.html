<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BizLink | Owner Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind & Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Razorpay Checkout -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    body{font-family:'Poppins',sans-serif;background:#050816;color:#e5e7eb}
    .card-bg{background:#0f172a;border:1px solid rgba(148,163,184,.35)}
    .button-gradient{background:linear-gradient(90deg,#a855f7 0%,#ec4899 100%)}
    .chip{font-size:.70rem;padding:.15rem .5rem;border-radius:999px}
    .chip-pending{background:#facc15;color:#1f2937}
    .chip-progress{background:#22c55e;color:#022c22}
    .chip-completed{background:#38bdf8;color:#0f172a}
    .chip-paid{background:#4ade80;color:#022c22}
    .chip-locked{background:#a855f7;color:#f9fafb}
    .tab-button{color:#9ca3af;border-bottom:2px solid transparent}
    .tab-button.active{color:#a855f7;border-bottom-color:#a855f7;font-weight:600}
    .scroll-y{max-height:430px;overflow-y:auto}
    .scroll-y::-webkit-scrollbar{width:6px}
    .scroll-y::-webkit-scrollbar-thumb{background:#1f2937;border-radius:999px}

    .req-chip{
      font-size:.65rem;
      padding:.15rem .55rem;
      border-radius:999px;
      font-weight:500;
    }
    .req-pending{
      background:rgba(250,204,21,0.15);
      color:#facc15;
      border:1px solid rgba(250,204,21,0.5);
    }
    .req-accepted{
      background:rgba(34,197,94,0.15);
      color:#bbf7d0;
      border:1px solid rgba(34,197,94,0.5);
    }
    .req-rejected{
      background:rgba(248,113,113,0.15);
      color:#fecaca;
      border:1px solid rgba(248,113,113,0.5);
    }
  </style>
</head>
<body class="min-h-screen">

  <!-- TOP BAR -->
  <header class="border-b border-slate-800 bg-slate-950/95 sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <a href="index.html" class="text-xs text-slate-300 hover:text-white flex items-center">
          ‚Üê Back to Home
        </a>
        <h1 class="text-lg sm:text-2xl font-bold text-white">
          BizLink <span class="text-purple-400">Owner Dashboard</span>
        </h1>
      </div>
      <div class="flex items-center space-x-3 text-xs sm:text-sm">
        <span id="loggedInEmail" class="hidden sm:inline text-slate-300"></span>
        <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-1.5 rounded-md text-xs font-semibold">
          Logout
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">

    <!-- ERROR / STATUS MSG -->
    <div id="pageStatus" class="mb-3 text-xs text-slate-400"></div>

    <!-- STATS -->
    <section class="grid sm:grid-cols-4 gap-4 mb-6">
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">Total Works</p>
        <p id="statTotal" class="text-2xl font-bold text-slate-100">0</p>
      </div>
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">Pending</p>
        <p id="statPending" class="text-2xl font-bold text-yellow-400">0</p>
      </div>
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">In Progress</p>
        <p id="statInProgress" class="text-2xl font-bold text-green-400">0</p>
      </div>
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">Completed</p>
        <p id="statCompleted" class="text-2xl font-bold text-sky-400">0</p>
      </div>
    </section>

    <!-- TABS -->
    <section class="mb-4">
      <nav class="-mb-px flex space-x-6 overflow-x-auto" id="statusTabs">
        <button class="tab-button active whitespace-nowrap py-2 text-sm" data-filter="all">All</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-filter="pending">Pending</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-filter="inprogress">In Progress</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-filter="completed">Completed</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-filter="paid">Paid (coming soon)</button>
      </nav>
    </section>

    <!-- MAIN LAYOUT -->
    <section class="grid lg:grid-cols-2 gap-6">

      <!-- LEFT: WORK LIST -->
      <div class="card-bg rounded-xl p-4">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h2 class="text-sm font-semibold text-slate-200">Your Posted Works</h2>
            <p class="text-xs text-slate-400">
              Yahan sirf wahi works dikhte hain jo <span class="font-semibold">aapke email se Post a Work form</span> se aaye hain.
            </p>
          </div>
          <p id="currentFilterLabel" class="text-xs text-slate-400">Filter: All</p>
        </div>

        <div id="workList" class="space-y-3 scroll-y">
          <div class="py-10 text-center text-xs text-slate-500">
            Loading works‚Ä¶
          </div>
        </div>
      </div>

      <!-- RIGHT: CHAT PANEL -->
      <div class="card-bg rounded-xl p-4 flex flex-col">
        <div id="chatHeader" class="border-b border-slate-800 pb-3 mb-3">
          <p class="text-xs text-slate-400">Chat Panel (Owner ‚Üí Freelancer)</p>
          <h2 id="chatTitle" class="text-sm font-semibold text-slate-100 mt-1">
            Select a work to start chatting
          </h2>
          <p id="chatSubtitle" class="text-xs text-slate-400 mt-1">
            Kisi work card par <span class="font-semibold text-slate-200">‚ÄúOpen Chat‚Äù</span> click karo.
            Yahan se files links bhejo, feedback do, status discuss karo.
          </p>
        </div>

        <div id="chatMessages" class="flex-1 scroll-y space-y-3 text-xs">
          <div class="h-full flex flex-col items-center justify-center text-center text-slate-500">
            <div class="mb-2 text-2xl">üí¨</div>
            <p>No work selected.</p>
          </div>
        </div>

        <form id="chatForm" class="mt-3 flex gap-2 items-center">
          <input
            id="chatInput"
            type="text"
            placeholder="Type a message‚Ä¶ (Owner ‚Üí Freelancer)"
            class="flex-1 text-xs px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
          <button
            id="chatSendBtn"
            type="submit"
            class="button-gradient px-4 py-2 rounded-lg text-xs font-semibold text-white disabled:opacity-50"
          >
            Send
          </button>
        </form>
      </div>
    </section>

    <!-- NEW: FREELANCER REQUESTS SECTION -->
    <section class="mt-6 card-bg rounded-xl p-4">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h2 class="text-sm font-semibold text-slate-200">Freelancer Requests</h2>
          <p class="text-xs text-slate-400">
            Direct Works se freelancers jo kaam ke liye request karte hain, woh yahan dikhte hain.
            Aap unka <span class="font-semibold">profile / portfolio / bid amount</span> dekh kar
            <span class="font-semibold">Accept / Reject</span> kar sakte hain.
          </p>
        </div>
        <p id="requestsStatus" class="text-[11px] text-slate-400"></p>
      </div>

      <div id="requestsList" class="space-y-3 max-h-72 overflow-y-auto">
        <div class="py-8 text-center text-xs text-slate-500">
          Loading requests‚Ä¶
        </div>
      </div>
    </section>
  </main>

  <!-- FIREBASE + OWNER DASHBOARD JS -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script>
    // ---- Firebase config (same as baaki pages) ----
    const firebaseConfig = {
      apiKey: "AIzaSyBtle51gX5kHufuWZ_YVOIQdDR05kbCE5I",
      authDomain: "bizlink-exchange.firebaseapp.com",
      projectId: "bizlink-exchange",
      storageBucket: "bizlink-exchange.firebasestorage.app",
      messagingSenderId: "116213651971",
      appId: "1:116213651971:web:fff60961af0c4da3448c36",
      measurementId: "G-VQ3JM82D1N"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
  </script>

  <script>
    // --------- CONFIG ---------
    // üü£ Main Apps Script = works / chat / payment / requests
    const MAIN_SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbzwpFX2jhH2Ea82wE73VIoQaPuWfXxFUo5LBXqW_lWhmwWqmJh5eu9BtdoHyPJ44fL5iA/exec";

    // üü¢ Users sheet script = signup / profile / roles etc.
    const USERS_SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbztkBN5GcgZdPARgOSrvBvgJcfClCvXzIq0mEk64TpaShqQ4FzpFAjQ742Io70wyzNa/exec";

    // Backward compatibility: purane code me SCRIPT_URL use ho raha hai
    const SCRIPT_URL = MAIN_SCRIPT_URL;

    // Razorpay / commission config (client-side amounts are for display; createRazorOrder should handle paise)
    const COMMISSION_PERCENT = 10; // commission charged by platform on freelancer amount
    const GST_PERCENT = 18;       // gst on (freelancer + commission)

    let ownerEmail = null;
    let allWorks = [];
    let worksById = {};      // map WorkID -> work object
    let currentFilter = "all";
    let currentWorkId = null;

    let ownerRequests = [];  // freelancer requests list

    const statusText = document.getElementById("pageStatus");
    const workListEl = document.getElementById("workList");
    const filterLabel = document.getElementById("currentFilterLabel");

    const statTotal      = document.getElementById("statTotal");
    const statPending    = document.getElementById("statPending");
    const statInProgress = document.getElementById("statInProgress");
    const statCompleted  = document.getElementById("statCompleted");

    const chatTitle    = document.getElementById("chatTitle");
    const chatSubtitle = document.getElementById("chatSubtitle");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput    = document.getElementById("chatInput");
    const chatForm     = document.getElementById("chatForm");

    // Requests DOM
    const requestsStatusEl = document.getElementById("requestsStatus");
    const requestsListEl   = document.getElementById("requestsList");

    // --- Utils ---
    function setStatus(msg, type = "info") {
      if (!statusText) return;
      statusText.textContent = msg || "";
      if (!msg) {
        statusText.className = "mb-3 text-xs text-slate-400";
      } else if (type === "error") {
        statusText.className = "mb-3 text-xs text-red-300";
      } else {
        statusText.className = "mb-3 text-xs text-slate-300";
      }
    }

    function normalizeStatus(s) {
      s = (s || "").toString().toLowerCase();
      if (!s || s === "pending") return "pending";
      if (s === "accepted" || s === "in progress") return "inprogress";
      if (s === "completed") return "completed";
      if (s === "paid") return "paid";
      if (s === "locked") return "locked"; // payment lock ke liye separate
      return "other";
    }

    function formatBudget(v) {
      if (!v && v !== 0) return "N/A";
      const num = Number(v.toString().replace(/[^0-9.]/g, "")) || 0;
      return "‚Çπ" + num.toLocaleString("en-IN");
    }

    // ‚≠ê USER ROLE HELPER ‚Äì Owner guard (Users script se)
    async function fetchUserRole(email) {
      try {
        const url = `${USERS_SCRIPT_URL}?action=getUserRole&email=${encodeURIComponent(email)}`;
        const res = await fetch(url);
        const data = await res.json();
        if (data && data.ok && data.role) {
          try {
            if (data.bizId) localStorage.setItem("bizlinkBizID", data.bizId);
            if (data.plan)  localStorage.setItem("bizlinkPlan", data.plan);
            if (data.role)  localStorage.setItem("bizlink_user_role", data.role.toLowerCase());
          } catch (e) {}
          return data.role;
        }
        return null;
      } catch (err) {
        console.error("getUserRole error:", err);
        return null;
      }
    }

    // --- Works loading ---
    async function loadOwnerWorks() {
      try {
        setStatus("Loading your works‚Ä¶");

        const res = await fetch(`${SCRIPT_URL}?sheet=works`);
        const data = await res.json();

        if (!Array.isArray(data)) {
          throw new Error("Invalid data from server");
        }

        allWorks = data.filter(w =>
          (w.ClientEmail || "").toString().toLowerCase() === ownerEmail.toLowerCase()
        );

        // map create
        worksById = {};
        allWorks.forEach(w => {
          if (w.WorkID != null) {
            worksById[w.WorkID.toString()] = w;
          }
        });

        updateStats();
        renderWorkList();
        setStatus(allWorks.length ? "" : "No works found for your email. Pehle Post a Work form se work create karo.");
      } catch (err) {
        console.error(err);
        setStatus("Error loading works: " + err.message, "error");
        workListEl.innerHTML = `
          <div class="py-8 text-center text-xs text-red-300">
            Error loading works: ${err.message}
          </div>`;
      }
    }

    function updateStats() {
      const total = allWorks.length;
      const pending = allWorks.filter(w => normalizeStatus(w.Status) === "pending").length;
      const inProg  = allWorks.filter(w => normalizeStatus(w.Status) === "inprogress").length;
      const completed = allWorks.filter(w => normalizeStatus(w.Status) === "completed").length;

      statTotal.textContent      = total;
      statPending.textContent    = pending;
      statInProgress.textContent = inProg;
      statCompleted.textContent  = completed;
    }

    function paymentChip(w) {
      const status = (w.PaymentStatus || "").toString();
      if (status === "Paid") {
        return `<span class="chip chip-paid">Paid</span>`;
      }
      if (status === "Locked") {
        const amt = w.LockedAmount ? "‚Çπ" + w.LockedAmount : "";
        return `<span class="chip chip-locked">Locked ${amt}</span>`;
      }
      return `<span class="chip chip-pending">Not Locked</span>`;
    }

    function renderWorkList() {
      const items = allWorks.filter(w => {
        const st = normalizeStatus(w.Status);
        if (currentFilter === "all") return true;
        if (currentFilter === "paid") {
          return (w.PaymentStatus || "").toString() === "Paid";
        }
        return st === currentFilter;
      });

      filterLabel.textContent = "Filter: " + (currentFilter[0].toUpperCase() + currentFilter.slice(1));

      if (!items.length) {
        workListEl.innerHTML = `
          <div class="py-10 text-center text-xs text-slate-500">
            No works in <span class="font-semibold">${currentFilter}</span>.
          </div>`;
        return;
      }

      workListEl.innerHTML = items.map(w => {
        const st = normalizeStatus(w.Status);
        let chipClass = "chip-pending", chipLabel = "Pending";
        if (st === "inprogress") { chipClass = "chip-progress"; chipLabel = "In Progress"; }
        else if (st === "completed") { chipClass = "chip-completed"; chipLabel = "Completed"; }
        else if (st === "paid") { chipClass = "chip-paid"; chipLabel = "Paid"; }

        const payStatus = (w.PaymentStatus || "").toString();
        const isLocked = payStatus === "Locked";
        const isPaid   = payStatus === "Paid";

        // Payment action buttons:
        let paymentButtons = "";
        if (isPaid) {
          paymentButtons = `<span class="text-[11px] text-emerald-400 font-semibold">Payment Done</span>`;
        } else if (isLocked) {
          paymentButtons = `
            <button
              class="px-3 py-1 rounded-md border border-yellow-400 text-yellow-300 text-[11px] font-semibold"
              data-action="unlock-payment"
            >
              Unlock
            </button>
            <button
              class="px-3 py-1 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white text-[11px] font-semibold"
              data-action="mark-paid"
            >
              Mark Paid
            </button>
          `;
        } else {
          paymentButtons = `
            <button 
              class="px-3 py-1 rounded-md bg-purple-600 hover:bg-purple-700 text-white text-[11px] font-semibold"
              data-action="lock-payment"
            >
              Lock Payment
            </button>
          `;
        }

        const lockedInfo = isLocked
          ? `<p class="text-[10px] text-slate-500 mt-1">
              Locked: ${w.LockedAmount || "-"} by ${w.LockedBy || "-"}
              ${w.LockedAt ? " ¬∑ " + new Date(w.LockedAt).toLocaleString() : ""}
             </p>`
          : "";

        const showRateButton =
          (st === "completed") && (w.AssignedTo && w.AssignedTo.toString().trim() !== "");

        // ‚≠ê NEW: show Raise Dispute button only when completed OR paid
        const showRaiseDispute = (st === "completed") || isPaid;

        return `
          <article class="card-bg rounded-lg p-3 flex flex-col gap-2" data-work-id="${w.WorkID || ""}">
            <div class="flex items-start justify-between gap-2">
              <div>
                <h3 class="text-sm font-semibold text-slate-100">${w.Title || "Untitled Work"}</h3>
                <p class="text-[11px] text-slate-400">
                  ${w.Category || ""} ¬∑ ${w.City || ""} ¬∑ ID: <span class="font-mono">${w.WorkID || ""}</span>
                </p>
              </div>
              <div class="flex flex-col items-end gap-1">
                <span class="chip ${chipClass}">${chipLabel}</span>
                ${paymentChip(w)}
              </div>
            </div>

            <p class="text-xs text-slate-400">
              ${w.Description || "No description"}
            </p>

            <div class="flex items-center justify-between text-[11px] text-slate-400 flex-wrap gap-2">
              <span>Budget: <span class="text-emerald-400 font-semibold">${formatBudget(w.Budget)}</span></span>
              <div class="flex flex-wrap gap-2">
                <button
                  class="px-3 py-1 rounded-md border border-slate-600 hover:border-purple-500 text-slate-100 font-semibold text-[11px]"
                  data-action="open-chat"
                >
                  Open Chat
                </button>
                ${paymentButtons}
                ${
                  showRateButton
                    ? `<button
                        class="px-3 py-1 rounded-md bg-emerald-700 hover:bg-emerald-800 text-white text-[11px] font-semibold"
                        data-action="rate-freelancer"
                      >
                        Rate Freelancer
                      </button>`
                    : ""
                }
                ${
                  showRaiseDispute
                    ? `<button
                        class="px-3 py-1 rounded-md border border-red-500 text-red-300 text-[11px] font-semibold"
                        data-action="raise-dispute"
                      >
                        Raise Dispute
                      </button>`
                    : ""
                }
              </div>
            </div>

            ${lockedInfo}
          </article>
        `;
      }).join("");
    }

    // --- Chat ---
    async function loadChatMessages(workId) {
      if (!workId) return;
      try {
        const res = await fetch(
          `${SCRIPT_URL}?action=getChatMessages&WorkID=${encodeURIComponent(workId)}`
        );
        const data = await res.json();
        if (!data.ok) {
          throw new Error(data.error || "Unknown error");
        }
        const msgs = data.messages || [];
        if (!msgs.length) {
          chatMessages.innerHTML = `
            <div class="py-8 text-center text-xs text-slate-500">
              No messages yet. Pehla message bhej kar conversation start karo.
            </div>`;
          return;
        }

        chatMessages.innerHTML = msgs.map(m => {
          const isOwner = (m.FromRole || "").toLowerCase() === "owner";
          const align = isOwner ? "items-end" : "items-start";
          const bubbleClasses = isOwner
            ? "bg-violet-600 text-white rounded-2xl rounded-br-none"
            : "bg-slate-800 text-slate-100 rounded-2xl rounded-bl-none";
          const metaAlign = isOwner ? "text-right" : "text-left";
          const who = isOwner ? "You (Owner)" : "Freelancer";

          const timeStr = m.CreatedAt
            ? new Date(m.CreatedAt).toLocaleString()
            : "";

          return `
            <div class="flex ${align}">
              <div class="max-w-[80%]">
                <div class="px-3 py-2 ${bubbleClasses} text-[11px]">
                  ${m.Message || ""}
                </div>
                <p class="mt-1 text-[10px] text-slate-500 ${metaAlign}">
                  ${who} ¬∑ ${timeStr}
                </p>
              </div>
            </div>
          `;
        }).join("");

        chatMessages.scrollTop = chatMessages.scrollHeight;
      } catch (err) {
        console.error(err);
        chatMessages.innerHTML = `
          <div class="py-8 text-center text-xs text-red-300">
            Error loading messages: ${err.message}
          </div>`;
      }
    }

    async function sendChatMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      if (!currentWorkId) {
        alert("Pehle koi work select karo (Open Chat).");
        return;
      }

      try {
        const body = new URLSearchParams();
        body.append("action", "sendMessage");
        body.append("WorkID", currentWorkId);
        body.append("FromRole", "Owner");
        body.append("FromEmail", ownerEmail);
        body.append("Message", text);

        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          body
        });
        const data = await res.json();
        if (!data.ok) {
          throw new Error(data.error || "Error sending message");
        }
        chatInput.value = "";
        await loadChatMessages(currentWorkId);
      } catch (err) {
        console.error(err);
        alert("Error sending message: " + err.message);
      }
    }

    // --- Payment actions ---
    async function apiPost(bodyObj) {
      const body = new URLSearchParams();
      Object.keys(bodyObj).forEach(k => body.append(k, bodyObj[k]));
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        body
      });
      return res.json();
    }

    /* ‚≠ê UPDATED: lockPayment ‚Äì ab BidAmount priority se use hoga */
    async function lockPayment(workId, budgetValue) {
      // 1) Is Work ka object nikaalo
      const work = allWorks.find(
        w => (w.WorkID || "").toString() === workId.toString()
      );
      const assigned = work ? (work.AssignedTo || "").toLowerCase() : "";

      // 2) Is work + freelancer ke liye APPROVED / ACCEPTED request dhundo
      let matchedReq = null;
      if (ownerRequests && ownerRequests.length) {
        matchedReq = ownerRequests.find(r => {
          const rWork   = (r.WorkID || "").toString();
          const rFree   = (r.FreelancerEmail || "").toLowerCase();
          const rStatus = (r.Status || "").toLowerCase();

          return (
            rWork === workId.toString() &&
            (!assigned || rFree === assigned) &&
            (rStatus === "approved" || rStatus === "accepted")
          );
        });
      }

      // 3) BidAmount ko priority do
      let rawAmount = "";

      let reqBid = null;
      if (matchedReq) {
        if (matchedReq.BidAmount != null && matchedReq.BidAmount !== "") {
          reqBid = matchedReq.BidAmount;
        } else if (matchedReq.bidAmount != null && matchedReq.bidAmount !== "") {
          reqBid = matchedReq.bidAmount;
        }
      }

      if (reqBid != null) {
        rawAmount = reqBid.toString();
      } else if (work && work.LockedAmount) {
        rawAmount = work.LockedAmount.toString();
      } else if (work && work.Budget) {
        rawAmount = work.Budget.toString();
      } else {
        rawAmount = (budgetValue || "").toString();
      }

      const amount = rawAmount.toString().replace(/[^0-9.]/g, "");

      const ok = confirm(
        `Is work ke liye payment lock karein?\n\nAmount: ‚Çπ${amount || "0"}`
      );
      if (!ok) return;

      try {
        const resp = await apiPost({
          action: "lockPayment",
          WorkID: workId,
          ownerEmail: ownerEmail,
          amount: amount
        });
        if (!resp.ok) {
          alert("Lock error: " + (resp.error || "Unknown"));
          return;
        }
        // Lock ke baad dono lists refresh karo
        await loadOwnerWorks();
        await loadWorkRequests();
      } catch (err) {
        console.error(err);
        alert("Network error while locking payment.");
      }
    }

    async function unlockPayment(workId) {
      const ok = confirm("Payment lock hataana hai?");
      if (!ok) return;

      try {
        const resp = await apiPost({
          action: "unlockPayment",
          WorkID: workId,
          ownerEmail: ownerEmail,
          notes: ""
        });
        if (!resp.ok) {
          alert("Unlock error: " + (resp.error || "Unknown"));
          return;
        }
        await loadOwnerWorks();
      } catch (err) {
        console.error(err);
        alert("Network error while unlocking payment.");
      }
    }

    async function markPaid(workId) {
      const ok = confirm("Mark as PAID? (Freelancer ko payment done)");
      if (!ok) return;

      const work = allWorks.find(w => (w.WorkID || "").toString() === workId.toString());
      const assigned = work ? (work.AssignedTo || "") : "";

      try {
        const resp = await apiPost({
          action: "markPaid",
          WorkID: workId,
          freelancerEmail: assigned,
          amount: work ? (work.LockedAmount || work.Budget || "") : "",
          notes: ""
        });
        if (!resp.ok) {
          alert("Mark paid error: " + (resp.error || "Unknown"));
          return;
        }
        await loadOwnerWorks();
      } catch (err) {
        console.error(err);
        alert("Network error while marking paid.");
      }
    }

    /*****************************************
     *  ‚≠ê NEW: OWNER ‚Üí FREELANCER RATING / REVIEW
     *****************************************/
    async function openRatingPrompt(work) {
      if (!work || !work.AssignedTo) {
        alert("Is work par abhi koi freelancer assign nahi hai.");
        return;
      }

      const ratingStr = prompt(
        `Freelancer (${work.AssignedTo}) ko rating do (1-5):`,
        "5"
      );
      if (!ratingStr) return;

      const rating = Number(ratingStr);
      if (!rating || rating < 1 || rating > 5) {
        alert("Rating 1 se 5 ke beech honi chahiye.");
        return;
      }

      const comment = prompt("Short review / feedback (optional):", "") || "";

      try {
        const resp = await apiPost({
          action: "submitReview",
          FreelancerEmail: work.AssignedTo,
          WorkID: work.WorkID,
          OwnerEmail: ownerEmail,
          Rating: rating,
          Comment: comment
        });

        if (!resp.ok) {
          alert("Error submitting review: " + (resp.error || "Unknown"));
          return;
        }

        alert("‚úÖ Review save ho gaya! Freelancer profile pe rating update ho jayegi.");
      } catch (err) {
        console.error(err);
        alert("Network error while submitting review.");
      }
    }

    /*****************************************
     *  NEW: OWNER SIDE ‚Äì WORK REQUESTS (WITH BID)
     *****************************************/
    async function loadWorkRequests() {
      if (!ownerEmail) return;
      try {
        requestsStatusEl.textContent = "Loading requests...";
        requestsListEl.innerHTML = `
          <div class="py-8 text-center text-xs text-slate-500">
            Loading requests...
          </div>
        `;

        const url = `${SCRIPT_URL}?action=listWorkRequestsForOwner&ownerEmail=${encodeURIComponent(ownerEmail)}&includeProfile=true`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data.ok) {
          throw new Error(data.error || "Unknown error");
        }
        ownerRequests = data.requests || [];

        requestsStatusEl.textContent = ownerRequests.length
          ? `Total Requests: ${ownerRequests.length}`
          : "No requests yet.";

        renderRequestsList();
      } catch (err) {
        console.error(err);
        requestsStatusEl.textContent = "Error loading requests";
        requestsListEl.innerHTML = `
          <div class="py-8 text-center text-xs text-red-300">
            Error loading requests: ${err.message}
          </div>
        `;
      }
    }

    function renderRequestsList() {
      if (!ownerRequests.length) {
        requestsListEl.innerHTML = `
          <div class="py-8 text-center text-xs text-slate-500">
            Abhi tak koi freelancer ne aapke works ke liye request nahi ki. üôÇ
          </div>
        `;
        return;
      }

      requestsListEl.innerHTML = ownerRequests.map(r => {
        const status = (r.Status || "Pending").toString();
        let chipClass = "req-pending";
        let chipLabel = "Pending";

        if (status.toLowerCase() === "accepted" || status.toLowerCase() === "approved") {
          chipClass = "req-accepted";
          chipLabel = "Accepted";
        } else if (status.toLowerCase() === "rejected") {
          chipClass = "req-rejected";
          chipLabel = "Rejected";
        }

        const workId = r.WorkID || "";
        const freelancer = r.FreelancerEmail || "";
        const cover = r.CoverNote || "";
        const portfolio = r.PortfolioURL || r.PortfolioUrl || "";

        const rawBid = r.BidAmount != null ? r.BidAmount : (r.bidAmount != null ? r.bidAmount : "");
        let bidDisplay = "";
        if (rawBid !== "" && rawBid != null) {
          const n = Number(rawBid.toString().replace(/[^0-9.]/g, ""));
          if (!isNaN(n) && n > 0) {
            bidDisplay = formatBudget(n);
          }
        }

        const profile = r._freelancerProfile || {};
        const fName  = profile.Name || profile["Full Name"] || "";
        const fCity  = profile.City || "";
        const fSkills = profile.Skills || profile.Tags || "";
        const totalWorks = profile._TotalWorks || profile.TotalWorks || 0;
        const avgRating   = profile.AvgRating || profile.avgRating || null;
        const totalReviews = profile.TotalReviews || profile.ReviewsCount || 0;

        const workObj = worksById[workId ? workId.toString() : ""];
        const alreadyAssigned = workObj && (workObj.AssignedTo || "").toLowerCase() === freelancer.toLowerCase();

        const budgetDisplay = workObj && workObj.Budget ? formatBudget(workObj.Budget) : "";

        const ts = r.Timestamp ? new Date(r.Timestamp).toLocaleString() : "";

        let actionButtons = "";
        if (alreadyAssigned || status.toLowerCase() === "accepted" || status.toLowerCase() === "approved") {
          actionButtons = `
            <span class="text-[11px] text-emerald-400 font-semibold">
              Assigned to this freelancer
            </span>
          `;
        } else if (status.toLowerCase() === "rejected") {
          actionButtons = `
            <span class="text-[11px] text-red-300 font-semibold">
              Rejected
            </span>
          `;
        } else {
          actionButtons = `
            <button
              class="px-3 py-1 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white text-[11px] font-semibold"
              data-req-action="accept"
              data-work-id="${workId}"
              data-freelancer="${freelancer}"
            >
              Accept & Assign
            </button>
            <button
              class="px-3 py-1 rounded-md border border-red-500 text-red-300 text-[11px] font-semibold"
              data-req-action="reject"
              data-work-id="${workId}"
              data-freelancer="${freelancer}"
            >
              Reject
            </button>
          `;
        }

        return `
          <article class="card-bg rounded-lg p-3 flex flex-col gap-2 text-xs">
            <div class="flex items-start justify-between gap-2">
              <div>
                <p class="text-[11px] text-slate-400">
                  Work ID: <span class="font-mono text-slate-100">${workId}</span>
                </p>
                <p class="text-[11px] text-slate-400">
                  Freelancer: <span class="font-semibold text-slate-100">${freelancer}</span>
                </p>
                ${
                  fName
                    ? `<p class="text-[11px] text-slate-300">
                        Name: <span class="font-semibold">${fName}</span>
                       </p>`
                    : ""
                }
                ${
                  fCity
                    ? `<p class="text-[11px] text-slate-400">
                         City: ${fCity}
                       </p>`
                    : ""
                }
                ${
                  (avgRating || totalWorks)
                    ? `<p class="text-[11px] text-slate-400 mt-1">
                         ${avgRating ? `‚≠ê ${Number(avgRating).toFixed(1)} ¬∑ ` : ""}
                         ${totalReviews ? `${totalReviews} reviews ¬∑ ` : ""}
                         ${totalWorks ? `${totalWorks} completed works` : ""}
                       </p>`
                    : ""
                }
                ${
                  fSkills
                    ? `<p class="text-[11px] text-slate-400 mt-1">
                         <span class="font-semibold text-slate-300">Skills:</span> ${fSkills}
                       </p>`
                    : ""
                }
                ${
                  bidDisplay || budgetDisplay
                    ? `<p class="text-[11px] text-slate-400 mt-1">
                         ${
                           bidDisplay
                             ? `Bid: <span class="text-emerald-300 font-semibold">${bidDisplay}</span>`
                             : ""
                         }
                         ${
                           budgetDisplay
                             ? ` ¬∑ Budget: <span class="text-slate-300">${budgetDisplay}</span>`
                             : ""
                         }
                       </p>`
                    : ""
                }
                ${portfolio ? `
                  <p class="text-[11px] mt-1">
                    Portfolio: 
                    <a href="${portfolio}" target="_blank" class="text-sky-400 underline">
                      View Portfolio
                    </a>
                  </p>
                ` : ""}
              </div>
              <span class="req-chip ${chipClass}">${chipLabel}</span>
            </div>

            ${cover ? `
              <p class="text-[11px] text-slate-300">
                <span class="font-semibold text-slate-400">Cover Note:</span> ${cover}
              </p>
            ` : ""}

            <div class="flex items-center justify-between mt-1">
              <p class="text-[10px] text-slate-500">
                Requested at: ${ts}
              </p>
              <div class="flex gap-2">
                ${actionButtons}
              </div>
            </div>
          </article>
        `;
      }).join("");
    }

    // ---------- RAZORPAY INTEGRATION (CLIENT-SIDE helpers) ----------
    // create order on backend ‚Äî backend must create Razorpay order using secret key
    async function createRazorOrderOnBackend(workId, amount, meta = {}) {
      try {
        const resp = await apiPost({
          action: 'createRazorOrder',
          WorkID: workId,
          amount: amount, // rupees (backend should convert to paise if needed)
          meta: JSON.stringify(meta)
        });
        return resp;
      } catch (err) {
        console.error('createRazorOrder error', err);
        return { ok: false, error: String(err) };
      }
    }

    // verify payment & lock on backend
    async function verifyRazorPaymentOnBackend(verificationPayload) {
      try {
        const body = Object.assign({ action: 'verifyRazorPayment' }, verificationPayload);
        const resp = await apiPost(body);
        return resp;
      } catch (err) {
        console.error('verifyRazorPayment error', err);
        return { ok: false, error: String(err) };
      }
    }

    // calc totals
    function calcTotalAmounts(freelancerAmt) {
      const fa = Number(String(freelancerAmt || '').replace(/[^0-9.]/g, '')) || 0;
      const commission = (fa * (COMMISSION_PERCENT / 100));
      const taxable = fa + commission;
      const gst = taxable * (GST_PERCENT / 100);
      const total = Math.round((fa + commission + gst) * 100) / 100;
      return { freelancerAmount: fa, commission, gst, total };
    }

    // approve & pay flow
    async function approveAndPayWithRazor(workId, freelancerEmail) {
      try {
        if (!confirm(`Freelancer assign karne ke saath payment lock karna chahte ho? WorkID: ${workId}`)) return;

        // find request or work to determine amount
        let req = null;
        if (ownerRequests && ownerRequests.length) {
          req = ownerRequests.find(r => (r.WorkID || '').toString() === (workId || '').toString() && (r.FreelancerEmail || '').toLowerCase() === (freelancerEmail || '').toLowerCase());
        }

        const workObj = worksById && worksById[workId] ? worksById[workId] : null;

        let freelancerAmt = 0;
        if (req && (req.BidAmount != null && req.BidAmount !== '')) freelancerAmt = req.BidAmount;
        else if (workObj && workObj.LockedAmount) freelancerAmt = workObj.LockedAmount;
        else if (workObj && workObj.Budget) freelancerAmt = workObj.Budget;
        else {
          const ask = prompt('Freelancer amount (‚Çπ) ‚Äî please enter:', workObj && workObj.Budget ? workObj.Budget : '');
          if (!ask) { alert('Amount required to proceed'); return; }
          freelancerAmt = ask;
        }

        const amounts = calcTotalAmounts(freelancerAmt);
        const confirmMsg = `Amount summary:\n\nFreelancer: ‚Çπ${amounts.freelancerAmount}\nCommission (${COMMISSION_PERCENT}%): ‚Çπ${amounts.commission.toFixed(2)}\nGST (${GST_PERCENT}%): ‚Çπ${amounts.gst.toFixed(2)}\n\nTotal to charge: ‚Çπ${amounts.total.toFixed(2)}\n\nProceed to payment?`;
        if (!confirm(confirmMsg)) return;

        // 1) create order on backend
        setStatus('Creating payment order‚Ä¶');
        const createResp = await createRazorOrderOnBackend(workId, amounts.total, { freelancerAmount: amounts.freelancerAmount, commission: amounts.commission, gst: amounts.gst });

        if (!createResp || !createResp.ok) {
          console.warn('createResp failed', createResp);
          if (confirm('Payment order creation failed. Proceed to assign without payment? (NOT recommended)')) {
            const resp = await apiPost({ action: 'approveRequest', WorkID: workId, FreelancerEmail: freelancerEmail, OwnerEmail: ownerEmail });
            if (resp && resp.ok) {
              alert('Freelancer assigned (no payment).');
              await loadOwnerWorks(); await loadWorkRequests();
            } else {
              alert('Approve failed: ' + (resp && resp.error ? resp.error : 'Unknown'));
            }
          } else {
            setStatus('');
          }
          return;
        }

        const order = createResp.order || createResp.data || null;
        const keyId = createResp.key_id || createResp.key || createResp.razorpay_key || null;
        const amountUsed = createResp.amountUsed || createResp.lockAmount || Math.round(amounts.total * 100);

        if (!order || !keyId) {
          console.warn('Incomplete order response', createResp);
          alert('Payment setup failed (invalid order from server).');
          setStatus('');
          return;
        }

        setStatus('Opening payment gateway‚Ä¶');
        const options = {
          key: keyId,
          amount: order.amount || Math.round(amounts.total * 100),
          currency: order.currency || 'INR',
          name: workObj && workObj.Title ? workObj.Title : 'BizLink Payment',
          description: `Lock for WorkID ${workId}`,
          order_id: order.id,
          handler: async function (response) {
            setStatus('Verifying payment‚Ä¶');

            const verifyResp = await verifyRazorPaymentOnBackend({
              WorkID: workId,
              OwnerEmail: ownerEmail,
              FreelancerEmail: freelancerEmail,
              razorpay_payment_id: response.razorpay_payment_id,
              razorpay_order_id: response.razorpay_order_id,
              razorpay_signature: response.razorpay_signature,
              amount: amountUsed
            });

            if (!verifyResp || !verifyResp.ok) {
              console.error('verify failed', verifyResp);
              alert('Payment verification failed: ' + (verifyResp && verifyResp.error ? verifyResp.error : 'Unknown'));
              setStatus('');
              return;
            }

            // success ‚Üí approve request (assign freelancer)
            setStatus('Finalizing assignment‚Ä¶');
            const approveResp = await apiPost({
              action: 'approveRequest',
              WorkID: workId,
              FreelancerEmail: freelancerEmail,
              OwnerEmail: ownerEmail
            });

            if (!approveResp || !approveResp.ok) {
              alert('Payment locked but assignment failed: ' + (approveResp && approveResp.error ? approveResp.error : 'Unknown'));
            } else {
              alert('‚úÖ Payment successful and freelancer assigned.');
            }

            await loadOwnerWorks();
            await loadWorkRequests();
            setStatus('');
          },
          modal: {
            ondismiss: function() {
              setStatus('');
            }
          },
          prefill: {
            name: ownerEmail,
            email: ownerEmail
          }
        };

        const rzp = new Razorpay(options);
        rzp.on('payment.failed', function (resp) {
          console.error('payment.failed', resp);
          alert('Payment failed: ' + (resp.error && resp.error.description ? resp.error.description : 'Unknown'));
          setStatus('');
        });
        rzp.open();

      } catch (err) {
        console.error('approveAndPayWithRazor error', err);
        alert('Error: ' + (err && err.message ? err.message : String(err)));
        setStatus('');
      }
    }

    // ---------- END Razorpay helpers ----------

    async function handleAcceptRequest(workId, freelancer) {
      try {
        // Ask owner: pay now (recommended) or assign without payment
        const doPay = confirm('Assign and lock payment now using Razorpay? (OK = Pay now / Cancel = Assign without payment)');
        if (doPay) {
          await approveAndPayWithRazor(workId, freelancer);
          return;
        }

        // fallback assign without payment
        if (!confirm(`Aap confirm karte ho ki freelancer assign karein?\n\nWorkID: ${workId}\nFreelancer: ${freelancer}`)) return;

        const resp = await apiPost({
          action: "approveRequest",
          WorkID: workId,
          FreelancerEmail: freelancer,
          OwnerEmail: ownerEmail
        });
        if (!resp.ok) {
          alert("Error assigning freelancer: " + (resp.error || "Unknown"));
          return;
        }

        const infoMsg = `Hi, aapki request approve ho gayi hai. WorkID: ${workId}.`;
        await apiPost({
          action: "sendMessage",
          WorkID: workId,
          FromRole: "Owner",
          FromEmail: ownerEmail,
          Message: infoMsg
        });

        await loadOwnerWorks();
        await loadWorkRequests();
        alert("‚úÖ Freelancer assigned successfully (no payment).");

      } catch (err) {
        console.error(err);
        alert("Network error while assigning freelancer.");
      }
    }

    async function handleRejectRequest(workId, freelancer) {
      const msg = `Is request ko reject karein?\n\nWorkID: ${workId}\nFreelancer: ${freelancer}`;
      if (!confirm(msg)) return;

      try {
        const infoMsg = `Hi, aapki request for WorkID: ${workId} is baar approve nahi ho paayi.`;
        await apiPost({
          action: "sendMessage",
          WorkID: workId,
          FromRole: "Owner",
          FromEmail: ownerEmail,
          Message: infoMsg
        });

        ownerRequests = ownerRequests.map(r => {
          if ((r.WorkID || "").toString() === workId.toString()
              && (r.FreelancerEmail || "").toLowerCase() === freelancer.toLowerCase()) {
            return { ...r, Status: "Rejected" };
          }
          return r;
        });
        renderRequestsList();

        alert("Request rejected (freelancer ko chat message chala gaya).");
      } catch (err) {
        console.error(err);
        alert("Network error while rejecting request.");
      }
    }

    /*****************************************
     *  ‚≠ê NEW: RAISE DISPUTE (Owner)
     *****************************************/
    async function raiseDisputeUI(work) {
      if (!work || !work.WorkID) {
        alert("Work not found.");
        return;
      }
      const st = normalizeStatus(work.Status);
      const payStatus = (work.PaymentStatus || "").toString();
      if (!(st === "completed" || payStatus === "Paid")) {
        alert("Dispute sirf Completed ya Paid works par raise kiya ja sakta hai.");
        return;
      }

      const reason = prompt("Dispute ka reason likho (required):");
      if (!reason || !reason.trim()) {
        alert("Reason required.");
        return;
      }
      const files = prompt("Optional file link (Google Drive / WeTransfer) - leave blank if none:");

      try {
        const resp = await apiPost({
          action: "raiseDispute",
          WorkID: work.WorkID,
          RaisedByEmail: ownerEmail,
          RaisedByRole: "owner",
          AgainstEmail: work.AssignedTo || "",
          Reason: reason,
          FilesURL: files || ""
        });

        if (!resp.ok) {
          alert("Error submitting dispute: " + (resp.error || JSON.stringify(resp)));
          return;
        }

        alert("Dispute raised successfully. Admin will review and contact you.");
        await loadOwnerWorks();
        await loadWorkRequests();
      } catch (err) {
        console.error(err);
        alert("Network error while raising dispute.");
      }
    }

    /*****************************************
     *  EVENT BINDINGS
     *****************************************/
    document.getElementById("statusTabs").addEventListener("click", (e) => {
      if (!e.target.matches("[data-filter]")) return;
      const filter = e.target.getAttribute("data-filter");
      currentFilter = filter;

      document.querySelectorAll("#statusTabs .tab-button").forEach(btn => {
        btn.classList.toggle("active", btn.getAttribute("data-filter") === filter);
      });

      renderWorkList();
    });

    workListEl.addEventListener("click", (e) => {
      const el = e.target.closest("[data-action]");
      if (!el) return;
      const action = el.getAttribute("data-action");
      const card = el.closest("[data-work-id]");
      if (!card) return;
      const workId = card.getAttribute("data-work-id");
      const work = allWorks.find(x => (x.WorkID || "").toString() === workId.toString());

      if (action === "open-chat") {
        currentWorkId = workId;
        chatTitle.textContent = work ? work.Title || "Chat" : "Chat";
        chatSubtitle.textContent = work
          ? `${work.Category || ""} ¬∑ ${work.City || ""} ¬∑ ID: ${work.WorkID || ""}`
          : "";
        loadChatMessages(workId);
      }

      if (action === "lock-payment") {
        lockPayment(workId, work ? work.Budget : "");
      }

      if (action === "unlock-payment") {
        unlockPayment(workId);
      }

      if (action === "mark-paid") {
        markPaid(workId);
      }

      if (action === "rate-freelancer") {
        openRatingPrompt(work);
      }

      if (action === "raise-dispute") {
        raiseDisputeUI(work);
      }
    });

    chatForm.addEventListener("submit", (e) => {
      e.preventDefault();
      sendChatMessage();
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut().then(() => {
        window.location.href = "index.html";
      });
    });

    // NEW: Requests list actions
    requestsListEl.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-req-action]");
      if (!btn) return;
      const action = btn.getAttribute("data-req-action");
      const workId = btn.getAttribute("data-work-id");
      const freelancer = btn.getAttribute("data-freelancer");
      if (!workId || !freelancer) return;

      if (action === "accept") {
        handleAcceptRequest(workId, freelancer);
      } else if (action === "reject") {
        handleRejectRequest(workId, freelancer);
      }
    });

    // --- Auth guard + initial load (‚≠ê UPDATED role-based) ---
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        alert("Please login first.");
        window.location.href = "login.html";
        return;
      }

      ownerEmail = (user.email || "").toLowerCase();
      const loggedSpan = document.getElementById("loggedInEmail");
      if (loggedSpan) {
        loggedSpan.textContent = `Logged in as: ${ownerEmail}`;
      }

      // Backend role (Users sheet se)
      const backendRoleRaw = await fetchUserRole(ownerEmail);
      const backendRole = backendRoleRaw ? backendRoleRaw.toString().toLowerCase() : "";

      // LocalStorage role (signup ne jo save kiya)
      let storedRole = "";
      try {
        storedRole = (localStorage.getItem("bizlink_user_role") || "").toString().toLowerCase();
      } catch (e) {
        storedRole = "";
      }

      const combinedRoleStr = (backendRole || storedRole || "").toLowerCase();

      const isFreelancer =
        combinedRoleStr.includes("free") || backendRole === "freelancer";

      const isOwner =
        combinedRoleStr.includes("owner") ||
        combinedRoleStr.includes("project") ||
        combinedRoleStr.includes("client");

      const isBusiness10x =
        combinedRoleStr.includes("business") ||
        combinedRoleStr.includes("10x") ||
        combinedRoleStr.includes("grow"); // "10X Grow Lab", "growth lab business" etc

      // Freelancer ko yahan allow nahi karna
      if (isFreelancer) {
        alert("Ye Owner Dashboard hai. Freelancers ke liye Freelancer Dashboard available hai.");
        window.location.href = "freelancer-dashboard.html";
        return;
      }

      const isAllowedOwner = isOwner || isBusiness10x;

      // Agar role clear owner/business type nahi hai ‚Üí block
      if (!isAllowedOwner) {
        alert("Aapka role owner / business category me nahi hai. Home par redirect kiya ja raha hai.");
        window.location.href = "index.html";
        return;
      }

      // ‚úÖ Role sahi hai to hi data load karein
      loadOwnerWorks();
      loadWorkRequests();
    });
  </script>
</body>
</html>
