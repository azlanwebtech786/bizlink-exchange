<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BizLink | Owner Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Poppins',sans-serif;background:#050816;color:#e5e7eb}
    .card-bg{background:#0f172a;border:1px solid rgba(148,163,184,.35)}
    .button-gradient{background:linear-gradient(90deg,#a855f7 0%,#ec4899 100%)}
    .chip{font-size:.70rem;padding:.2rem .6rem;border-radius:999px}
    .pending{background:#facc15;color:#1f2937}
    .accepted{background:#22c55e;color:#022c22}
    .completed{background:#38bdf8;color:#0f172a}
    .scroll-y{max-height:420px;overflow-y:auto}
  </style>
</head>

<body class="min-h-screen">

<header class="border-b border-slate-800 bg-slate-950 px-4 py-3 sticky top-0">
  <div class="max-w-6xl mx-auto flex justify-between items-center">
    <h1 class="text-lg font-bold text-white">
      BizLink <span class="text-purple-400">Owner Dashboard</span>
    </h1>
    <button onclick="logout()" class="bg-red-600 px-4 py-1 rounded text-xs">Logout</button>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6 grid lg:grid-cols-2 gap-6">

<!-- LEFT -->
<div class="card-bg rounded-xl p-4">
  <h2 class="text-sm font-semibold mb-3">Your Posted Works</h2>
  <div id="workList" class="scroll-y space-y-3 text-xs text-slate-300">
    Loading works…
  </div>
</div>

<!-- RIGHT -->
<div class="card-bg rounded-xl p-4 flex flex-col">
  <h2 id="chatTitle" class="text-sm font-semibold mb-2">Select a work to chat</h2>

  <div id="chatMessages" class="flex-1 scroll-y space-y-2 text-xs mb-3">
    <p class="text-slate-500 text-center mt-10">No work selected</p>
  </div>

  <form id="chatForm" class="flex gap-2">
    <input id="chatInput" type="text" placeholder="Type message…"
      class="flex-1 bg-slate-900 border border-slate-700 px-3 py-2 rounded text-xs">
    <button class="button-gradient px-4 text-xs rounded">Send</button>
  </form>
</div>

</main>

<script>
/* ================= CONFIG ================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx33xzS-1OyIoSRJcnUt0y3EJR3-GMm96DDnefgI93AXdr_IkDiDCg2ww45epJ5Q-5D1g/exec";

/* ================= STATE ================= */
let ownerEmail = localStorage.getItem("bizlinkOwnerEmail") || "";
let currentWorkId = null;
let chatTimer = null;

/* ================= LOGIN ================= */
if (!ownerEmail) {
  ownerEmail = prompt("Owner email:");
  localStorage.setItem("bizlinkOwnerEmail", ownerEmail);
}

/* ================= LOAD WORKS ================= */
async function loadOwnerWorks() {
  const box = document.getElementById("workList");
  box.innerHTML = "Loading works…";

  const res = await fetch(`${SCRIPT_URL}?sheet=works`);
  const data = await res.json();

  const works = data.filter(w =>
    (w.ClientEmail || "").toLowerCase() === ownerEmail.toLowerCase()
  );

  if (!works.length) {
    box.innerHTML = `<p class="text-slate-500 text-center">No works found.</p>`;
    return;
  }

  box.innerHTML = works.map(w => `
    <div class="p-3 rounded-lg bg-slate-900 border border-slate-800">
      <div class="flex justify-between items-center mb-1">
        <p class="font-semibold">${w.Title || "No title"}</p>
        <span class="chip ${w.Status === "Pending" ? "pending" :
                            w.Status === "Accepted" ? "accepted" : "completed"}">
          ${w.Status}
        </span>
      </div>
      <p class="text-slate-400 mb-2">${w.Description || ""}</p>
      <button onclick="openChat('${w.WorkID}','${w.Title}','${w.AssignedTo || ""}')"
        class="text-xs border px-3 py-1 rounded hover:bg-slate-800">
        Open Chat
      </button>
    </div>
  `).join("");
}

/* ================= CHAT ================= */
async function openChat(workId,title,freelancer) {
  currentWorkId = workId;
  document.getElementById("chatTitle").textContent =
    `${title} (${freelancer || "Not assigned"})`;

  if (chatTimer) clearInterval(chatTimer);
  await loadMessages();
  chatTimer = setInterval(loadMessages, 5000);
}

async function loadMessages() {
  if (!currentWorkId) return;
  const box = document.getElementById("chatMessages");

  const res = await fetch(
    `${SCRIPT_URL}?action=getChatMessages&WorkID=${currentWorkId}`
  );
  const data = await res.json();

  if (!data.messages || !data.messages.length) {
    box.innerHTML = `<p class="text-center text-slate-500 mt-10">No messages yet.</p>`;
    return;
  }

  box.innerHTML = data.messages.map(m => {
    const isOwner = m.FromRole === "Owner";
    return `
      <div class="${isOwner ? "text-right" : "text-left"}">
        <span class="inline-block px-3 py-2 rounded text-xs
          ${isOwner ? "bg-pink-600" : "bg-slate-800"}">
          ${m.Message}
        </span>
      </div>
    `;
  }).join("");
  box.scrollTop = box.scrollHeight;
}

/* ================= SEND ================= */
document.getElementById("chatForm").addEventListener("submit", async e => {
  e.preventDefault();
  const input = document.getElementById("chatInput");
  if (!input.value || !currentWorkId) return;

  await fetch(SCRIPT_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "sendMessage",
      WorkID: currentWorkId,
      FromRole: "Owner",
      FromEmail: ownerEmail,
      Message: input.value
    })
  });

  input.value = "";
  loadMessages();
});

/* ================= LOGOUT ================= */
function logout() {
  localStorage.removeItem("bizlinkOwnerEmail");
  location.href = "index.html";
}

loadOwnerWorks();
</script>
</body>
</html>
