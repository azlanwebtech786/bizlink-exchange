<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BizLink | Owner Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<style>
body{background:#050816;color:#e5e7eb;font-family:Inter,system-ui}
.card{background:#0f172a;border:1px solid #1f2937}
.btn{background:linear-gradient(90deg,#a855f7,#ec4899)}
</style>
</head>

<body class="min-h-screen">

<header class="p-4 border-b border-slate-800 flex justify-between">
<h1 class="font-bold">BizLink <span class="text-purple-400">Owner Dashboard</span></h1>
<button onclick="logout()" class="bg-red-600 px-3 py-1 rounded text-sm">Logout</button>
</header>

<main class="max-w-6xl mx-auto p-4 grid grid-cols-2 gap-4">

<!-- LEFT -->
<div class="card p-4">
<h2 class="font-semibold mb-2">Your Posted Works</h2>
<div id="workList" class="space-y-3 text-sm text-slate-300">
Loading works...
</div>
</div>

<!-- RIGHT -->
<div class="card p-4 flex flex-col">
<h2 id="chatTitle" class="font-semibold mb-2">Select a work to chat</h2>
<div id="chatMessages" class="flex-1 space-y-2 text-sm overflow-y-auto mb-2 text-slate-300">
No work selected
</div>

<form id="chatForm" class="flex gap-2">
<input id="chatInput" class="flex-1 bg-slate-900 px-3 py-2 rounded text-sm" placeholder="Type message..." />
<button class="btn px-4 py-2 rounded text-sm">Send</button>
</form>
</div>

</main>

<script>
// ========= CONFIG =========
const API_URL = "https://script.google.com/macros/s/AKfycbx33xzS-1OyIoSRJcnUt0y3EJR3-GMm96DDnefgI93AXdr_IkDiDCg2ww45epJ5Q-5D1g/exec";

let ownerEmail = localStorage.getItem("bizlinkOwnerEmail");
if(!ownerEmail){
  ownerEmail = prompt("Owner email:");
  localStorage.setItem("bizlinkOwnerEmail", ownerEmail);
}

let currentWorkId = null;

// ========= LOAD WORKS =========
async function loadOwnerWorks(){
  const res = await fetch(`${API_URL}?sheet=works`);
  const data = await res.json();

  const myWorks = data.filter(w =>
    String(w.ClientEmail).toLowerCase() === ownerEmail.toLowerCase()
  );

  const box = document.getElementById("workList");
  box.innerHTML = "";

  if(!myWorks.length){
    box.innerHTML = "<p class='text-slate-500'>No works found</p>";
    return;
  }

  myWorks.forEach(w=>{
    box.innerHTML += `
      <div class="border border-slate-700 rounded p-3">
        <p class="font-medium">${w.Title || "No title"}</p>
        <p>ID: ${w.WorkID}</p>
        <p>â‚¹${w.Budget}</p>
        <button onclick="openChat('${w.WorkID}','${w.Title}','${w.AssignedTo||""}')" class="mt-2 text-xs bg-slate-800 px-3 py-1 rounded">Open Chat</button>
      </div>
    `;
  });
}

// ========= CHAT =========
async function openChat(workId,title,freelancer){
  currentWorkId = workId;
  document.getElementById("chatTitle").innerText = `${title} (${workId})`;
  loadChat();
}

async function loadChat(){
  const res = await fetch(`${API_URL}?action=getChatMessages&WorkID=${currentWorkId}`);
  const data = await res.json();
  const box = document.getElementById("chatMessages");
  box.innerHTML = "";

  if(!data.messages.length){
    box.innerHTML = "<p class='text-slate-500'>No messages</p>";
    return;
  }

  data.messages.forEach(m=>{
    const align = m.FromRole==="Owner"?"text-right":"text-left";
    box.innerHTML += `
      <div class="${align}">
        <div class="inline-block bg-slate-800 px-3 py-2 rounded mb-1">
          ${m.Message}
        </div>
      </div>
    `;
  });

  box.scrollTop = box.scrollHeight;
}

// ========= SEND =========
document.getElementById("chatForm").onsubmit = async e=>{
  e.preventDefault();
  if(!currentWorkId) return alert("Select a work");

  const msg = chatInput.value.trim();
  if(!msg) return;

  await fetch(API_URL,{
    method:"POST",
    body:new URLSearchParams({
      action:"sendMessage",
      WorkID:currentWorkId,
      FromRole:"Owner",
      FromEmail:ownerEmail,
      Message:msg
    })
  });

  chatInput.value="";
  loadChat();
};

// ========= LOGOUT =========
function logout(){
  localStorage.clear();
  location.href="index.html";
}

loadOwnerWorks();
</script>
</body>
</html>
