<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BizLink | Owner Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind & Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Poppins',sans-serif;background:#050816;color:#e5e7eb}
    .card-bg{background:#0f172a;border:1px solid rgba(148,163,184,.35)}
    .button-gradient{background:linear-gradient(90deg,#a855f7 0%,#ec4899 100%)}
    .chip{font-size:.70rem;padding:.15rem .5rem;border-radius:999px}
    .chip-pending{background:#facc15;color:#1f2937}
    .chip-progress{background:#22c55e;color:#022c22}
    .chip-completed{background:#38bdf8;color:#0f172a}
    .chip-paid{background:#4ade80;color:#022c22}
    .tab-button{color:#9ca3af;border-bottom:2px solid transparent}
    .tab-button.active{color:#a855f7;border-bottom-color:#a855f7;font-weight:600}
    .scroll-y{max-height:430px;overflow-y:auto}
    .scroll-y::-webkit-scrollbar{width:6px}
    .scroll-y::-webkit-scrollbar-thumb{background:#1f2937;border-radius:999px}
  </style>
</head>
<body class="min-h-screen">

  <!-- TOP BAR -->
  <header class="border-b border-slate-800 bg-slate-950/95 sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <a href="index.html" class="text-xs text-slate-300 hover:text-white flex items-center">
          ‚Üê Back to Home
        </a>
        <h1 class="text-lg sm:text-2xl font-bold text-white">
          BizLink <span class="text-purple-400">Owner Dashboard</span>
        </h1>
      </div>
      <div class="flex items-center space-x-3 text-xs sm:text-sm">
        <span id="loggedInEmail" class="hidden sm:inline text-slate-300"></span>
        <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-1.5 rounded-md text-xs font-semibold">
          Logout
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">

    <!-- ERROR / STATUS MSG -->
    <div id="pageStatus" class="mb-3 text-xs text-slate-400"></div>

    <!-- STATS -->
    <section class="grid sm:grid-cols-4 gap-4 mb-6">
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">Total Works</p>
        <p id="statTotal" class="text-2xl font-bold text-slate-100">0</p>
      </div>
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">Pending</p>
        <p id="statPending" class="text-2xl font-bold text-yellow-400">0</p>
      </div>
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">In Progress</p>
        <p id="statInProgress" class="text-2xl font-bold text-green-400">0</p>
      </div>
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">Completed</p>
        <p id="statCompleted" class="text-2xl font-bold text-sky-400">0</p>
      </div>
    </section>

    <!-- TABS -->
    <section class="mb-4">
      <nav class="-mb-px flex space-x-6 overflow-x-auto" id="statusTabs">
        <button class="tab-button active whitespace-nowrap py-2 text-sm" data-filter="all">All</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-filter="pending">Pending</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-filter="inprogress">In Progress</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-filter="completed">Completed</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-filter="paid">Paid (coming soon)</button>
      </nav>
    </section>

    <!-- MAIN LAYOUT -->
    <section class="grid lg:grid-cols-2 gap-6">

      <!-- LEFT: WORK LIST -->
      <div class="card-bg rounded-xl p-4">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h2 class="text-sm font-semibold text-slate-200">Your Posted Works</h2>
            <p class="text-xs text-slate-400">
              Yahan sirf wahi works dikhte hain jo <span class="font-semibold">aapke email se Post a Work form</span> se aaye hain.
            </p>
          </div>
          <p id="currentFilterLabel" class="text-xs text-slate-400">Filter: All</p>
        </div>

        <div id="workList" class="space-y-3 scroll-y">
          <!-- JS se cards aayenge -->
          <div class="py-10 text-center text-xs text-slate-500">
            Loading works‚Ä¶
          </div>
        </div>
      </div>

      <!-- RIGHT: CHAT PANEL -->
      <div class="card-bg rounded-xl p-4 flex flex-col">
        <div id="chatHeader" class="border-b border-slate-800 pb-3 mb-3">
          <p class="text-xs text-slate-400">Chat Panel (Owner ‚Üí Freelancer)</p>
          <h2 id="chatTitle" class="text-sm font-semibold text-slate-100 mt-1">
            Select a work to start chatting
          </h2>
          <p id="chatSubtitle" class="text-xs text-slate-400 mt-1">
            Kisi work card par <span class="font-semibold text-slate-200">‚ÄúOpen Chat‚Äù</span> click karo.
            Yahan se files links bhejo, feedback do, status discuss karo.
          </p>
        </div>

        <div id="chatMessages" class="flex-1 scroll-y space-y-3 text-xs">
          <div class="h-full flex flex-col items-center justify-center text-center text-slate-500">
            <div class="mb-2 text-2xl">üí¨</div>
            <p>No work selected.</p>
          </div>
        </div>

        <form id="chatForm" class="mt-3 flex gap-2 items-center">
          <input
            id="chatInput"
            type="text"
            placeholder="Type a message‚Ä¶ (Owner ‚Üí Freelancer)"
            class="flex-1 text-xs px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
          <button
            id="chatSendBtn"
            type="submit"
            class="button-gradient px-4 py-2 rounded-lg text-xs font-semibold text-white disabled:opacity-50"
          >
            Send
          </button>
        </form>
      </div>
    </section>
  </main>

  <!-- FIREBASE + OWNER DASHBOARD JS -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script>
    // ---- Firebase config (same as baaki pages) ----
    const firebaseConfig = {
      apiKey: "AIzaSyBtle51gX5kHufuWZ_YVOIQdDR05kbCE5I",
      authDomain: "bizlink-exchange.firebaseapp.com",
      projectId: "bizlink-exchange",
      storageBucket: "bizlink-exchange.firebasestorage.app",
      messagingSenderId: "116213651971",
      appId: "1:116213651971:web:fff60961af0c4da3448c36",
      measurementId: "G-VQ3JM82D1N"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
  </script>

  <script>
    // --------- CONFIG ---------
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx33xzS-1OyIoSRJcnUt0y3EJR3-GMm96DDnefgI93AXdr_IkDiDCg2ww45epJ5Q-5D1g/exec";


// TODO: Abhi ke liye hard-coded; baad me Firebase se user.email le lenge
const OWNER_EMAIL = "don@gmail.com";   // yahan apna login email daalo

// DOM refs
const workListEl       = document.getElementById("ownerWorkList");
const msgListEl        = document.getElementById("chatMessagesOwner");
const chatFormEl       = document.getElementById("ownerChatForm");
const chatInputEl      = document.getElementById("ownerChatInput");

const statTotalEl      = document.getElementById("statOwnerTotal");
const statPendingEl    = document.getElementById("statOwnerPending");
const statInProgEl     = document.getElementById("statOwnerInProgress");
const statCompletedEl  = document.getElementById("statOwnerCompleted");

// State
let allWorks = [];
let currentWorkId = null;
let currentWorkTitle = "";
let chatPollTimer = null;

// ===============================
//  Helpers
// ===============================
function formatBudget(v) {
  if (v === "" || v == null) return "N/A";
  const num = Number(v);
  if (isNaN(num)) return v;
  return "‚Çπ" + num.toLocaleString("en-IN");
}

function statusChip(status) {
  const s = (status || "").toLowerCase();
  if (s === "pending") {
    return '<span class="chip chip-pending">Pending</span>';
  } else if (s === "accepted" || s === "in progress") {
    return '<span class="chip chip-accepted">In Progress</span>';
  } else if (s === "completed") {
    return '<span class="chip chip-completed">Completed</span>';
  }
  return '<span class="chip">-</span>';
}

// ===============================
//  LOAD WORKS FOR OWNER
// ===============================
async function loadOwnerWorks() {
  try {
    // works sheet ka pura data
    const res  = await fetch(`${SCRIPT_URL}?sheet=works`);
    const data = await res.json();   // array of row objects

    if (!Array.isArray(data)) {
      workListEl.innerHTML = `<p class="text-xs text-red-400">Error loading works (invalid data)</p>`;
      return;
    }

    // Sirf woh works jaha ClientEmail = OWNER_EMAIL
    allWorks = data.filter(w => {
      const email = (w.ClientEmail || "").toString().trim().toLowerCase();
      return email === OWNER_EMAIL.toLowerCase();
    });

    renderStats();
    renderWorkCards();

  } catch (err) {
    console.error(err);
    workListEl.innerHTML =
      `<p class="text-xs text-red-400">Error loading works: ${err.message}</p>`;
  }
}

function renderStats() {
  const total     = allWorks.length;
  const pending   = allWorks.filter(w => (w.Status || "").toLowerCase() === "pending").length;
  const inProg    = allWorks.filter(w => (w.Status || "").toLowerCase() === "accepted").length;
  const completed = allWorks.filter(w => (w.Status || "").toLowerCase() === "completed").length;

  statTotalEl.textContent     = total;
  statPendingEl.textContent   = pending;
  statInProgEl.textContent    = inProg;
  statCompletedEl.textContent = completed;
}

function renderWorkCards(filterStatus = "All") {
  if (!allWorks.length) {
    workListEl.innerHTML = `
      <div class="py-10 text-center text-xs text-slate-500">
        No works in <span class="font-semibold">${filterStatus}</span>.
      </div>`;
    return;
  }

  const list = allWorks.filter(w => {
    if (filterStatus === "All") return true;
    const s = (w.Status || "").toLowerCase();
    if (filterStatus === "Pending")   return s === "pending";
    if (filterStatus === "InProgress")return s === "accepted";
    if (filterStatus === "Completed") return s === "completed";
    return true;
  });

  workListEl.innerHTML = list.map(w => {
    const id      = w.WorkID || "";
    const title   = w.Title || "No Title";
    const client  = w.business_name || "";
    const city    = w.City || w.city || "-";
    const cat     = w.Category || w.category || "-";
    const desc    = w.Description || "No description";
    const status  = w.Status || "Pending";
    const budget  = formatBudget(w.Budget);

    return `
      <article class="card-bg rounded-lg p-3 mb-3 flex flex-col gap-2">
        <div class="flex items-center justify-between gap-2">
          <div>
            <h3 class="text-sm font-semibold text-slate-100">${title}</h3>
            <p class="text-[11px] text-slate-400">
              ${cat} ¬∑ ${city} ¬∑ ID: <span class="font-mono">${id}</span>
            </p>
          </div>
          <div>${statusChip(status)}</div>
        </div>
        <p class="text-xs text-slate-300 line-clamp-2">${desc}</p>
        <div class="flex items-center justify-between text-xs mt-1">
          <p>Budget: <span class="text-emerald-400 font-semibold">${budget}</span></p>
          <button
            class="px-3 py-1 rounded-md border border-purple-500 text-purple-300 text-xs font-semibold hover:bg-purple-500 hover:text-white"
            data-action="open-chat"
            data-id="${id}">
            Open Chat
          </button>
        </div>
      </article>
    `;
  }).join("");
}

// Tabs (All / Pending / In Progress / Completed / Paid soon)
document.addEventListener("click", (e) => {
  const tab = e.target.getAttribute("data-owner-tab");
  if (!tab) return;

  document.querySelectorAll("[data-owner-tab]").forEach(btn => {
    btn.classList.toggle("active", btn.getAttribute("data-owner-tab") === tab);
  });

  if (tab === "All")          renderWorkCards("All");
  if (tab === "Pending")      renderWorkCards("Pending");
  if (tab === "InProgress")   renderWorkCards("InProgress");
  if (tab === "Completed")    renderWorkCards("Completed");
});

// Work card click ‚Äì Open Chat
workListEl.addEventListener("click", (e) => {
  const btn = e.target.closest("[data-action='open-chat']");
  if (!btn) return;

  const workId = btn.getAttribute("data-id");
  const work   = allWorks.find(w => (w.WorkID || "") === workId);
  if (!work) return;

  openChatForWork(work);
});

// ===============================
//  CHAT ‚Äì LOAD & RENDER
// ===============================
function clearChatUI() {
  msgListEl.innerHTML = `
    <div class="py-8 text-center text-xs text-slate-500">
      No work selected.
    </div>
  `;
}

async function loadMessages(workId) {
  try {
    const res  = await fetch(`${SCRIPT_URL}?action=getChatMessages&WorkID=${encodeURIComponent(workId)}`);
    const data = await res.json();
    if (!data.ok) {
      console.error(data.error);
      return;
    }
    renderMessages(data.messages || []);
  } catch (err) {
    console.error("Chat load error:", err);
  }
}

function renderMessages(list) {
  if (!list.length) {
    msgListEl.innerHTML = `
      <div class="py-8 text-center text-xs text-slate-500">
        No messages yet. Start the conversation.
      </div>`;
    return;
  }

  msgListEl.innerHTML = list.map(m => {
    const isOwner = (m.FromRole || "").toLowerCase() === "owner";
    const align   = isOwner ? "items-end" : "items-start";
    const bubble  = isOwner
      ? "bg-violet-600 text-white rounded-2xl rounded-br-none"
      : "bg-slate-800 text-slate-100 rounded-2xl rounded-bl-none";
    const label   = isOwner ? "You (Owner)" : "Freelancer";
    const timeStr = m.CreatedAt
      ? new Date(m.CreatedAt).toLocaleString()
      : "";

    return `
      <div class="flex ${align} mb-2">
        <div class="max-w-[80%]">
          <div class="px-3 py-2 text-[11px] ${bubble}">
            ${m.Message}
          </div>
          <p class="mt-1 text-[10px] text-slate-500 ${isOwner ? "text-right" : "text-left"}">
            ${label} ¬∑ ${timeStr}
          </p>
        </div>
      </div>
    `;
  }).join("");

  msgListEl.scrollTop = msgListEl.scrollHeight;
}

// Chat open kare
function openChatForWork(work) {
  currentWorkId    = work.WorkID;
  currentWorkTitle = work.Title || "Work";

  // Header text agar tumne banaya ho to optionally yahan set kar sakte ho
  // document.getElementById("chatHeaderTitle").textContent =
  //   `${currentWorkTitle} (ID: ${currentWorkId})`;

  clearChatUI();
  loadMessages(currentWorkId);

  // Polling har 5 second
  if (chatPollTimer) clearInterval(chatPollTimer);
  chatPollTimer = setInterval(() => {
    if (currentWorkId) loadMessages(currentWorkId);
  }, 5000);
}

// ===============================
//  CHAT ‚Äì SEND MESSAGE
// ===============================
chatFormEl.addEventListener("submit", async (e) => {
  e.preventDefault();
  const text = chatInputEl.value.trim();
  if (!text) return;

  if (!currentWorkId) {
    alert("Pehle koi work me 'Open Chat' karo.");
    return;
  }

  try {
    const fd = new FormData();
    fd.append("action",     "sendMessage");
    fd.append("WorkID",     currentWorkId);
    fd.append("FromRole",   "Owner");
    fd.append("FromEmail",  OWNER_EMAIL);
    fd.append("Message",    text);

    const res  = await fetch(SCRIPT_URL, { method: "POST", body: fd });
    const data = await res.json();

    if (!data.ok) {
      alert("Error sending message: " + (data.error || "Unknown"));
      return;
    }

    chatInputEl.value = "";
    await loadMessages(currentWorkId);  // fresh messages

  } catch (err) {
    console.error(err);
    alert("Network error while sending message.");
  }
});

// ===============================
//  INITIAL LOAD
// ===============================
clearChatUI();
loadOwnerWorks();

</script>

</body>
</html>
