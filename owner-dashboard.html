<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BizLink | Owner Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind & Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Poppins',sans-serif;background:#050816;color:#e5e7eb}
    .card-bg{background:#0f172a;border:1px solid rgba(148,163,184,.35)}
    .button-gradient{background:linear-gradient(90deg,#a855f7 0%,#ec4899 100%)}
    .chip{font-size:.70rem;padding:.15rem .5rem;border-radius:999px}
    .chip-pending{background:#facc15;color:#1f2937}
    .chip-progress{background:#22c55e;color:#022c22}
    .chip-completed{background:#38bdf8;color:#0f172a}
    .chip-paid{background:#4ade80;color:#022c22}
    .tab-button{color:#9ca3af;border-bottom:2px solid transparent}
    .tab-button.active{color:#a855f7;border-bottom-color:#a855f7;font-weight:600}
    .scroll-y{max-height:430px;overflow-y:auto}
    .scroll-y::-webkit-scrollbar{width:6px}
    .scroll-y::-webkit-scrollbar-thumb{background:#1f2937;border-radius:999px}
  </style>
</head>
<body class="min-h-screen">

  <!-- TOP BAR -->
  <header class="border-b border-slate-800 bg-slate-950/95 sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <a href="index.html" class="text-xs text-slate-300 hover:text-white flex items-center">
          ‚Üê Back to Home
        </a>
        <h1 class="text-lg sm:text-2xl font-bold text-white">
          BizLink <span class="text-purple-400">Owner Dashboard</span>
        </h1>
      </div>
      <div class="flex items-center space-x-3 text-xs sm:text-sm">
        <span id="loggedInEmail" class="hidden sm:inline text-slate-300"></span>
        <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-1.5 rounded-md text-xs font-semibold">
          Logout
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">

    <!-- ERROR / STATUS MSG -->
    <div id="pageStatus" class="mb-3 text-xs text-slate-400"></div>

    <!-- STATS -->
    <section class="grid sm:grid-cols-4 gap-4 mb-6">
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">Total Works</p>
        <p id="statTotal" class="text-2xl font-bold text-slate-100">0</p>
      </div>
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">Pending</p>
        <p id="statPending" class="text-2xl font-bold text-yellow-400">0</p>
      </div>
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">In Progress</p>
        <p id="statInProgress" class="text-2xl font-bold text-green-400">0</p>
      </div>
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">Completed</p>
        <p id="statCompleted" class="text-2xl font-bold text-sky-400">0</p>
      </div>
    </section>

    <!-- TABS -->
    <section class="mb-4">
      <nav class="-mb-px flex space-x-6 overflow-x-auto" id="statusTabs">
        <button class="tab-button active whitespace-nowrap py-2 text-sm" data-filter="all">All</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-filter="pending">Pending</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-filter="inprogress">In Progress</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-filter="completed">Completed</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-filter="paid">Paid (coming soon)</button>
      </nav>
    </section>

    <!-- MAIN LAYOUT -->
    <section class="grid lg:grid-cols-2 gap-6">

      <!-- LEFT: WORK LIST -->
      <div class="card-bg rounded-xl p-4">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h2 class="text-sm font-semibold text-slate-200">Your Posted Works</h2>
            <p class="text-xs text-slate-400">
              Yahan sirf wahi works dikhte hain jo <span class="font-semibold">aapke email se Post a Work form</span> se aaye hain.
            </p>
          </div>
          <p id="currentFilterLabel" class="text-xs text-slate-400">Filter: All</p>
        </div>

        <div id="workList" class="space-y-3 scroll-y">
          <!-- JS se cards aayenge -->
          <div class="py-10 text-center text-xs text-slate-500">
            Loading works‚Ä¶
          </div>
        </div>
      </div>

      <!-- RIGHT: CHAT PANEL -->
      <div class="card-bg rounded-xl p-4 flex flex-col">
        <div id="chatHeader" class="border-b border-slate-800 pb-3 mb-3">
          <p class="text-xs text-slate-400">Chat Panel (Owner ‚Üí Freelancer)</p>
          <h2 id="chatTitle" class="text-sm font-semibold text-slate-100 mt-1">
            Select a work to start chatting
          </h2>
          <p id="chatSubtitle" class="text-xs text-slate-400 mt-1">
            Kisi work card par <span class="font-semibold text-slate-200">‚ÄúOpen Chat‚Äù</span> click karo.
            Yahan se files links bhejo, feedback do, status discuss karo.
          </p>
        </div>

        <div id="chatMessages" class="flex-1 scroll-y space-y-3 text-xs">
          <div class="h-full flex flex-col items-center justify-center text-center text-slate-500">
            <div class="mb-2 text-2xl">üí¨</div>
            <p>No work selected.</p>
          </div>
        </div>

        <form id="chatForm" class="mt-3 flex gap-2 items-center">
          <input
            id="chatInput"
            type="text"
            placeholder="Type a message‚Ä¶ (Owner ‚Üí Freelancer)"
            class="flex-1 text-xs px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
          <button
            id="chatSendBtn"
            type="submit"
            class="button-gradient px-4 py-2 rounded-lg text-xs font-semibold text-white disabled:opacity-50"
          >
            Send
          </button>
        </form>
      </div>
    </section>
  </main>

  <!-- FIREBASE + OWNER DASHBOARD JS -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script>
    // ---- Firebase config (same as baaki pages) ----
    const firebaseConfig = {
      apiKey: "AIzaSyBtle51gX5kHufuWZ_YVOIQdDR05kbCE5I",
      authDomain: "bizlink-exchange.firebaseapp.com",
      projectId: "bizlink-exchange",
      storageBucket: "bizlink-exchange.firebasestorage.app",
      messagingSenderId: "116213651971",
      appId: "1:116213651971:web:fff60961af0c4da3448c36",
      measurementId: "G-VQ3JM82D1N"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
  </script>

  <script>
    // --------- CONFIG ---------
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx33xzS-1OyIoSRJcnUt0y3EJR3-GMm96DDnefgI93AXdr_IkDiDCg2ww45epJ5Q-5D1g/exec";

function getLoggedInEmailOwner() {
  let email =
    (window.LOGGED_IN_EMAIL || "").trim() ||
    (localStorage.getItem("bizlink_email") || "").trim() ||
    (localStorage.getItem("bizlinkOwnerEmail") || "").trim();

  if (!email) {
    email = prompt("Owner (client) ka login email likho (temporary):") || "";
    email = email.trim();
    if (email) {
      localStorage.setItem("bizlinkOwnerEmail", email);
    }
  }
  return email;
}

// =========================
//  STATE
// =========================
let ownerEmail = "";
let currentOwnerWorkId = null;
let chatOwnerTimer = null;

// yahan se tum agar chaho to header me "Logged in as ..." bhi set kar sakte ho
window.addEventListener("DOMContentLoaded", () => {
  ownerEmail = getLoggedInEmailOwner();
  const span = document.getElementById("ownerEmailLabel");
  if (span && ownerEmail) span.textContent = ownerEmail;
  setupOwnerChatForm();
});

// =========================
//  API HELPERS
// =========================
async function ownerApiGet(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error("HTTP " + res.status);
  return res.json();
}

async function ownerApiPost(bodyObj) {
  const body = new URLSearchParams(bodyObj);
  const res = await fetch(API_URL_OWNER, {
    method: "POST",
    body
  });
  if (!res.ok) throw new Error("HTTP " + res.status);
  return res.json();
}

// =========================
//  CHAT ‚Äì OWNER SIDE
// =========================

// ye function tumhare work card se call hoga
// example button HTML:
// <button onclick="openOwnerChat('W-123','Video editing','freelancer@gmail.com')">Open Chat</button>
window.openOwnerChat = function (workId, title, assignedTo) {
  currentOwnerWorkId = workId;

  const titleEl = document.getElementById("ownerChatTitle");
  const subEl = document.getElementById("ownerChatSubtitle");

  if (titleEl) titleEl.textContent = title || "Chat";
  if (subEl)
    subEl.textContent =
      (assignedTo ? `Freelancer: ${assignedTo}` : "") + ` ¬∑ Work ID: ${workId}`;

  if (chatOwnerTimer) clearInterval(chatOwnerTimer);

  loadOwnerChatMessages(workId);
  chatOwnerTimer = setInterval(() => {
    if (currentOwnerWorkId) loadOwnerChatMessages(currentOwnerWorkId);
  }, 5000);
};

function setupOwnerChatForm() {
  const form = document.getElementById("ownerChatForm");
  const input = document.getElementById("ownerChatInput");
  if (!form || !input) return;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;
    if (!currentOwnerWorkId) {
      alert("Pehle kisi work ka chat open karo.");
      return;
    }

    try {
      await ownerApiPost({
        action: "sendMessage",
        WorkID: currentOwnerWorkId,
        FromRole: "Owner",
        FromEmail: ownerEmail,
        Message: text
      });
      input.value = "";
      await loadOwnerChatMessages(currentOwnerWorkId);
    } catch (err) {
      console.error(err);
      alert("Owner message bhejte time error aaya.");
    }
  });
}

async function loadOwnerChatMessages(workId) {
  const msgBox = document.getElementById("ownerChatMessages");
  if (!msgBox) return;

  try {
    const data = await ownerApiGet(
      `${API_URL_OWNER}?action=getChatMessages&WorkID=${encodeURIComponent(
        workId
      )}`
    );

    if (!data.ok) {
      msgBox.innerHTML = `
        <div class="py-6 text-center text-xs text-red-300">
          Chat load nahi ho paaya.
        </div>`;
      return;
    }

    const messages = data.messages || [];
    if (!messages.length) {
      msgBox.innerHTML = `
        <div class="py-10 text-center text-xs text-slate-500">
          No messages yet. Pehla message bhejo.
        </div>`;
      return;
    }

    msgBox.innerHTML = messages
      .map((m) => {
        const fromRole = (m.FromRole || "").toLowerCase();
        const isOwner = fromRole === "owner";
        const align = isOwner ? "items-end" : "items-start";
        const bubble = isOwner
          ? "bg-pink-600 text-white rounded-2xl rounded-br-none"
          : "bg-slate-800 text-slate-100 rounded-2xl rounded-bl-none";
        const metaAlign = isOwner ? "text-right" : "text-left";
        const who = isOwner ? "You" : "Freelancer";

        const timeStr = m.CreatedAt
          ? new Date(m.CreatedAt).toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit"
            })
          : "";

        return `
          <div class="flex ${align}">
            <div class="max-w-[80%]">
              <div class="px-3 py-2 ${bubble} text-[11px]">
                ${m.Message || ""}
              </div>
              <p class="mt-1 text-[10px] text-slate-500 ${metaAlign}">
                ${who} ¬∑ ${timeStr}
              </p>
            </div>
          </div>
        `;
      })
      .join("");

    msgBox.scrollTop = msgBox.scrollHeight;
  } catch (err) {
    console.error(err);
  }
}
</script>


</body>
</html>
