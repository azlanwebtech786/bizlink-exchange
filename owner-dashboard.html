<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BizLink | Owner Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind & Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Poppins',sans-serif;background:#050816;color:#e5e7eb}
    .card-bg{background:#0f172a;border:1px solid rgba(148,163,184,.35)}
    .button-gradient{background:linear-gradient(90deg,#a855f7 0%,#ec4899 100%)}
    .chip{font-size:.70rem;padding:.15rem .5rem;border-radius:999px}
    .chip-pending{background:#facc15;color:#1f2937}
    .chip-progress{background:#22c55e;color:#022c22}
    .chip-completed{background:#38bdf8;color:#0f172a}
    .chip-paid{background:#4ade80;color:#022c22}
    .chip-locked{background:#a855f7;color:#f9fafb}
    .tab-button{color:#9ca3af;border-bottom:2px solid transparent}
    .tab-button.active{color:#a855f7;border-bottom-color:#a855f7;font-weight:600}
    .scroll-y{max-height:430px;overflow-y:auto}
    .scroll-y::-webkit-scrollbar{width:6px}
    .scroll-y::-webkit-scrollbar-thumb{background:#1f2937;border-radius:999px}
  </style>
</head>
<body class="min-h-screen">

  <!-- TOP BAR -->
  <header class="border-b border-slate-800 bg-slate-950/95 sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <a href="index.html" class="text-xs text-slate-300 hover:text-white flex items-center">
          ‚Üê Back to Home
        </a>
        <h1 class="text-lg sm:text-2xl font-bold text-white">
          BizLink <span class="text-purple-400">Owner Dashboard</span>
        </h1>
      </div>
      <div class="flex items-center space-x-3 text-xs sm:text-sm">
        <span id="loggedInEmail" class="hidden sm:inline text-slate-300"></span>
        <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-1.5 rounded-md text-xs font-semibold">
          Logout
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">

    <!-- ERROR / STATUS MSG -->
    <div id="pageStatus" class="mb-3 text-xs text-slate-400"></div>

    <!-- STATS -->
    <section class="grid sm:grid-cols-4 gap-4 mb-6">
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">Total Works</p>
        <p id="statTotal" class="text-2xl font-bold text-slate-100">0</p>
      </div>
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">Pending</p>
        <p id="statPending" class="text-2xl font-bold text-yellow-400">0</p>
      </div>
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">In Progress</p>
        <p id="statInProgress" class="text-2xl font-bold text-green-400">0</p>
      </div>
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">Completed</p>
        <p id="statCompleted" class="text-2xl font-bold text-sky-400">0</p>
      </div>
    </section>

    <!-- TABS -->
    <section class="mb-4">
      <nav class="-mb-px flex space-x-6 overflow-x-auto" id="statusTabs">
        <button class="tab-button active whitespace-nowrap py-2 text-sm" data-filter="all">All</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-filter="pending">Pending</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-filter="inprogress">In Progress</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-filter="completed">Completed</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-filter="paid">Paid (coming soon)</button>
      </nav>
    </section>

    <!-- MAIN LAYOUT -->
    <section class="grid lg:grid-cols-2 gap-6">

      <!-- LEFT: WORK LIST -->
      <div class="card-bg rounded-xl p-4">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h2 class="text-sm font-semibold text-slate-200">Your Posted Works</h2>
            <p class="text-xs text-slate-400">
              Yahan sirf wahi works dikhte hain jo <span class="font-semibold">aapke email se Post a Work form</span> se aaye hain.
            </p>
          </div>
          <p id="currentFilterLabel" class="text-xs text-slate-400">Filter: All</p>
        </div>

        <div id="workList" class="space-y-3 scroll-y">
          <div class="py-10 text-center text-xs text-slate-500">
            Loading works‚Ä¶
          </div>
        </div>
      </div>

      <!-- RIGHT: CHAT PANEL -->
      <div class="card-bg rounded-xl p-4 flex flex-col">
        <div id="chatHeader" class="border-b border-slate-800 pb-3 mb-3">
          <p class="text-xs text-slate-400">Chat Panel (Owner ‚Üí Freelancer)</p>
          <h2 id="chatTitle" class="text-sm font-semibold text-slate-100 mt-1">
            Select a work to start chatting
          </h2>
          <p id="chatSubtitle" class="text-xs text-slate-400 mt-1">
            Kisi work card par <span class="font-semibold text-slate-200">‚ÄúOpen Chat‚Äù</span> click karo.
            Yahan se files links bhejo, feedback do, status discuss karo.
          </p>
        </div>

        <div id="chatMessages" class="flex-1 scroll-y space-y-3 text-xs">
          <div class="h-full flex flex-col items-center justify-center text-center text-slate-500">
            <div class="mb-2 text-2xl">üí¨</div>
            <p>No work selected.</p>
          </div>
        </div>

        <form id="chatForm" class="mt-3 flex gap-2 items-center">
          <input
            id="chatInput"
            type="text"
            placeholder="Type a message‚Ä¶ (Owner ‚Üí Freelancer)"
            class="flex-1 text-xs px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
          <button
            id="chatSendBtn"
            type="submit"
            class="button-gradient px-4 py-2 rounded-lg text-xs font-semibold text-white disabled:opacity-50"
          >
            Send
          </button>
        </form>
      </div>
    </section>
  </main>

  <!-- FIREBASE + OWNER DASHBOARD JS -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script>
    // ---- Firebase config (same as baaki pages) ----
    const firebaseConfig = {
      apiKey: "AIzaSyBtle51gX5kHufuWZ_YVOIQdDR05kbCE5I",
      authDomain: "bizlink-exchange.firebaseapp.com",
      projectId: "bizlink-exchange",
      storageBucket: "bizlink-exchange.firebasestorage.app",
      messagingSenderId: "116213651971",
      appId: "1:116213651971:web:fff60961af0c4da3448c36",
      measurementId: "G-VQ3JM82D1N"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
  </script>

  <script>
    // --------- CONFIG ---------
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyDw-YRQzfEBiZUzlOFf02Z-42QLu7HkiTvZ7_ge_Ae4_kMjK0ovQ8ZuTRooIoMjCx36g/exec";

    let ownerEmail = null;
    let allWorks = [];
    let currentFilter = "all";
    let currentWorkId = null;

    const statusText = document.getElementById("pageStatus");
    const workListEl = document.getElementById("workList");
    const filterLabel = document.getElementById("currentFilterLabel");

    const statTotal      = document.getElementById("statTotal");
    const statPending    = document.getElementById("statPending");
    const statInProgress = document.getElementById("statInProgress");
    const statCompleted  = document.getElementById("statCompleted");

    const chatTitle    = document.getElementById("chatTitle");
    const chatSubtitle = document.getElementById("chatSubtitle");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput    = document.getElementById("chatInput");
    const chatForm     = document.getElementById("chatForm");

    // --- Utils ---
    function setStatus(msg, type = "info") {
      if (!statusText) return;
      statusText.textContent = msg || "";
      if (!msg) {
        statusText.className = "mb-3 text-xs text-slate-400";
      } else if (type === "error") {
        statusText.className = "mb-3 text-xs text-red-300";
      } else {
        statusText.className = "mb-3 text-xs text-slate-300";
      }
    }

    function normalizeStatus(s) {
      s = (s || "").toString().toLowerCase();
      if (!s || s === "pending") return "pending";
      if (s === "accepted" || s === "in progress") return "inprogress";
      if (s === "completed") return "completed";
      if (s === "paid") return "paid";
      if (s === "locked") return "locked"; // payment lock ke liye
      return "other";
    }

    function formatBudget(v) {
      if (!v && v !== 0) return "N/A";
      const num = Number(v.toString().replace(/[^0-9.]/g, "")) || 0;
      return "‚Çπ" + num.toLocaleString("en-IN");
    }

    // --- Works loading ---
    async function loadOwnerWorks() {
      try {
        setStatus("Loading your works‚Ä¶");

        const res = await fetch(`${SCRIPT_URL}?sheet=works`);
        const data = await res.json();

        if (!Array.isArray(data)) {
          throw new Error("Invalid data from server");
        }

        allWorks = data.filter(w =>
          (w.ClientEmail || "").toString().toLowerCase() === ownerEmail.toLowerCase()
        );

        updateStats();
        renderWorkList();
        setStatus(allWorks.length ? "" : "No works found for your email. Pehle Post a Work form se work create karo.");
      } catch (err) {
        console.error(err);
        setStatus("Error loading works: " + err.message, "error");
        workListEl.innerHTML = `
          <div class="py-8 text-center text-xs text-red-300">
            Error loading works: ${err.message}
          </div>`;
      }
    }

    function updateStats() {
      const total = allWorks.length;
      const pending   = allWorks.filter(w => normalizeStatus(w.Status) === "pending").length;
      const inProg    = allWorks.filter(w => normalizeStatus(w.Status) === "inprogress").length;
      const completed = allWorks.filter(w => normalizeStatus(w.Status) === "completed").length;

      statTotal.textContent      = total;
      statPending.textContent    = pending;
      statInProgress.textContent = inProg;
      statCompleted.textContent  = completed;
    }

    function paymentChip(w) {
      const status = (w.PaymentStatus || "").toString();
      if (status === "Paid") {
        return `<span class="chip chip-paid">Paid</span>`;
      }
      if (status === "Locked") {
        const amt = w.LockedAmount ? "‚Çπ" + w.LockedAmount : "";
        return `<span class="chip chip-locked">Locked ${amt}</span>`;
      }
      return `<span class="chip chip-pending">Not Locked</span>`;
    }

    function renderWorkList() {
      const items = allWorks.filter(w => {
        const st = normalizeStatus(w.Status);
        if (currentFilter === "all") return true;
        if (currentFilter === "paid") {
          return (w.PaymentStatus || "").toString() === "Paid";
        }
        return st === currentFilter;
      });

      filterLabel.textContent = "Filter: " + (currentFilter[0].toUpperCase() + currentFilter.slice(1));

      if (!items.length) {
        workListEl.innerHTML = `
          <div class="py-10 text-center text-xs text-slate-500">
            No works in <span class="font-semibold">${currentFilter}</span>.
          </div>`;
        return;
      }

      workListEl.innerHTML = items.map(w => {
        const st = normalizeStatus(w.Status);
        let chipClass = "chip-pending", chipLabel = "Pending";
        if (st === "inprogress") { chipClass = "chip-progress"; chipLabel = "In Progress"; }
        else if (st === "completed") { chipClass = "chip-completed"; chipLabel = "Completed"; }
        else if (st === "paid") { chipClass = "chip-paid"; chipLabel = "Paid"; }

        const payStatus = (w.PaymentStatus || "").toString();
        const isLocked = payStatus === "Locked";
        const isPaid   = payStatus === "Paid";

        let paymentButtons = "";
        if (isPaid) {
          paymentButtons = `<span class="text-[11px] text-emerald-400 font-semibold">Payment Done</span>`;
        } else if (isLocked) {
          paymentButtons = `
            <button
              class="px-3 py-1 rounded-md border border-yellow-400 text-yellow-300 text-[11px] font-semibold"
              data-action="unlock-payment"
            >
              Unlock
            </button>
            <button
              class="px-3 py-1 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white text-[11px] font-semibold"
              data-action="mark-paid"
            >
              Mark Paid
            </button>
          `;
        } else {
          paymentButtons = `
            <button
              class="px-3 py-1 rounded-md bg-purple-600 hover:bg-purple-700 text-white text-[11px] font-semibold"
              data-action="lock-payment"
            >
              Lock Payment
            </button>
          `;
        }

        const lockedInfo = isLocked
          ? `<p class="text-[10px] text-slate-500 mt-1">
              Locked: ${w.LockedAmount || "-"} by ${w.LockedBy || "-"}
              ${w.LockedAt ? " ¬∑ " + new Date(w.LockedAt).toLocaleString() : ""}
             </p>`
          : "";

        return `
          <article class="card-bg rounded-lg p-3 flex flex-col gap-2" data-work-id="${w.WorkID || ""}">
            <div class="flex items-start justify-between gap-2">
              <div>
                <h3 class="text-sm font-semibold text-slate-100">${w.Title || "Untitled Work"}</h3>
                <p class="text-[11px] text-slate-400">
                  ${w.Category || ""} ¬∑ ${w.City || ""} ¬∑ ID: <span class="font-mono">${w.WorkID || ""}</span>
                </p>
              </div>
              <div class="flex flex-col items-end gap-1">
                <span class="chip ${chipClass}">${chipLabel}</span>
                ${paymentChip(w)}
              </div>
            </div>

            <p class="text-xs text-slate-400">
              ${w.Description || "No description"}
            </p>

            <div class="flex items-center justify-between text-[11px] text-slate-400 flex-wrap gap-2">
              <span>Budget: <span class="text-emerald-400 font-semibold">${formatBudget(w.Budget)}</span></span>
              <div class="flex flex-wrap gap-2">
                <button
                  class="px-3 py-1 rounded-md border border-slate-600 hover:border-purple-500 text-slate-100 font-semibold text-[11px]"
                  data-action="open-chat"
                >
                  Open Chat
                </button>
                ${paymentButtons}
              </div>
            </div>

            ${lockedInfo}
          </article>
        `;
      }).join("");
    }

    // --- Chat ---
    async function loadChatMessages(workId) {
      if (!workId) return;
      try {
        const res = await fetch(
          `${SCRIPT_URL}?action=getChatMessages&WorkID=${encodeURIComponent(workId)}`
        );
        const data = await res.json();
        if (!data.ok) {
          throw new Error(data.error || "Unknown error");
        }
        const msgs = data.messages || [];
        if (!msgs.length) {
          chatMessages.innerHTML = `
            <div class="py-8 text-center text-xs text-slate-500">
              No messages yet. Pehla message bhej kar conversation start karo.
            </div>`;
          return;
        }

        chatMessages.innerHTML = msgs.map(m => {
          const isOwner = (m.FromRole || "").toLowerCase() === "owner";
          const align = isOwner ? "items-end" : "items-start";
          const bubbleClasses = isOwner
            ? "bg-violet-600 text-white rounded-2xl rounded-br-none"
            : "bg-slate-800 text-slate-100 rounded-2xl rounded-bl-none";
          const metaAlign = isOwner ? "text-right" : "text-left";
          const who = isOwner ? "You (Owner)" : "Freelancer";

          const timeStr = m.CreatedAt
            ? new Date(m.CreatedAt).toLocaleString()
            : "";

          return `
            <div class="flex ${align}"><div class="max-w-[80%]">
              <div class="px-3 py-2 ${bubbleClasses} text-[11px]">
                ${m.Message || ""}
              </div>
              <p class="mt-1 text-[10px] text-slate-500 ${metaAlign}">
                ${who} ¬∑ ${timeStr}
              </p>
            </div></div>
          `;
        }).join("");

        chatMessages.scrollTop = chatMessages.scrollHeight;
      } catch (err) {
        console.error(err);
        chatMessages.innerHTML = `
          <div class="py-8 text-center text-xs text-red-300">
            Error loading messages: ${err.message}
          </div>`;
      }
    }

    async function sendChatMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      if (!currentWorkId) {
        alert("Pehle koi work select karo (Open Chat).");
        return;
      }

      try {
        const body = new URLSearchParams();
        body.append("action", "sendMessage");
        body.append("WorkID", currentWorkId);
        body.append("FromRole", "Owner");
        body.append("FromEmail", ownerEmail);
        body.append("Message", text);

        const res = await fetch(SCRIPT_URL, { method: "POST", body });
        const data = await res.json();
        if (!data.ok) {
          throw new Error(data.error || "Error sending message");
        }
        chatInput.value = "";
        await loadChatMessages(currentWorkId);
      } catch (err) {
        console.error(err);
        alert("Error sending message: " + err.message);
      }
    }

    // --- Payment helper for POST ---
    async function apiPost(bodyObj) {
      const body = new URLSearchParams();
      Object.keys(bodyObj).forEach(k => body.append(k, bodyObj[k]));
      const res = await fetch(SCRIPT_URL, { method: "POST", body });
      return res.json();
    }

    // --- Payment actions ---
    async function lockPayment(workId, budgetValue) {
      const amount = (budgetValue || "").toString().replace(/[^0-9.]/g, "");
      const ok = confirm(`Is work ke liye payment lock karein? Amount: ‚Çπ${amount || "0"}`);
      if (!ok) return;

      try {
        const resp = await apiPost({
          action: "lockPayment",
          WorkID: workId,
          ownerEmail: ownerEmail,
          amount: amount
        });
        if (!resp.ok) {
          alert("Lock error: " + (resp.error || "Unknown"));
          return;
        }
        await loadOwnerWorks();
      } catch (err) {
        console.error(err);
        alert("Network error while locking payment.");
      }
    }

    async function unlockPayment(workId) {
      const ok = confirm("Payment lock hataana hai?");
      if (!ok) return;

      try {
        const resp = await apiPost({
          action: "unlockPayment",
          WorkID: workId,
          ownerEmail: ownerEmail,
          notes: ""
        });
        if (!resp.ok) {
          alert("Unlock error: " + (resp.error || "Unknown"));
          return;
        }
        await loadOwnerWorks();
      } catch (err) {
        console.error(err);
        alert("Network error while unlocking payment.");
      }
    }

    async function markPaid(workId) {
      const ok = confirm("Mark as PAID? (Freelancer ko payment done)");
      if (!ok) return;

      const work = allWorks.find(w => (w.WorkID || "").toString() === workId.toString());
      const assigned = work ? (work.AssignedTo || "") : "";

      try {
        const resp = await apiPost({
          action: "markPaid",
          WorkID: workId,
          freelancerEmail: assigned,
          amount: work ? (work.LockedAmount || work.Budget || "") : "",
          notes: ""
        });
        if (!resp.ok) {
          alert("Mark paid error: " + (resp.error || "Unknown"));
          return;
        }
        await loadOwnerWorks();
      } catch (err) {
        console.error(err);
        alert("Network error while marking paid.");
      }
    }

    // --- Event bindings ---
    document.getElementById("statusTabs").addEventListener("click", (e) => {
      if (!e.target.matches("[data-filter]")) return;
      const filter = e.target.getAttribute("data-filter");
      currentFilter = filter;

      document.querySelectorAll("#statusTabs .tab-button").forEach(btn => {
        btn.classList.toggle("active", btn.getAttribute("data-filter") === filter);
      });

      renderWorkList();
    });

    workListEl.addEventListener("click", (e) => {
      const el = e.target.closest("[data-action]");
      if (!el) return;
      const action = el.getAttribute("data-action");
      const card = el.closest("[data-work-id]");
      if (!card) return;
      const workId = card.getAttribute("data-work-id");
      const work = allWorks.find(x => (x.WorkID || "").toString() === workId.toString());

      if (action === "open-chat") {
        currentWorkId = workId;
        chatTitle.textContent = work ? work.Title || "Chat" : "Chat";
        chatSubtitle.textContent = work
          ? `${work.Category || ""} ¬∑ ${work.City || ""} ¬∑ ID: ${work.WorkID || ""}`
          : "";
        loadChatMessages(workId);
      }

      if (action === "lock-payment") {
        lockPayment(workId, work ? work.Budget : "");
      }

      if (action === "unlock-payment") {
        unlockPayment(workId);
      }

      if (action === "mark-paid") {
        markPaid(workId);
      }
    });

    chatForm.addEventListener("submit", (e) => {
      e.preventDefault();
      sendChatMessage();
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut().then(() => {
        window.location.href = "index.html";
      });
    });

    // --- Auth guard + initial load ---
    auth.onAuthStateChanged((user) => {
      if (!user) {
        alert("Please login first.");
        window.location.href = "login.html";
        return;
      }
      ownerEmail = user.email;
      const loggedSpan = document.getElementById("loggedInEmail");
      if (loggedSpan) {
        loggedSpan.textContent = `Logged in as: ${ownerEmail}`;
      }
      loadOwnerWorks();
    });
  </script>
</body>
</html>
