<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BizLink | Owner Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind & Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Poppins',sans-serif;background:#050816;color:#e5e7eb}
    .card-bg{background:#0f172a;border:1px solid rgba(148,163,184,.35)}
    .button-gradient{background:linear-gradient(90deg,#a855f7 0%,#ec4899 100%)}
    .chip{font-size:.70rem;padding:.15rem .5rem;border-radius:999px}
    .chip-pending{background:#facc15;color:#1f2937}
    .chip-accepted{background:#22c55e;color:#022c22}
    .chip-completed{background:#38bdf8;color:#0f172a}
    .chip-paid{background:#16a34a;color:#022c22}
    .tab-button{color:#9ca3af;border-bottom:2px solid transparent}
    .tab-button.active{color:#a855f7;border-bottom-color:#a855f7;font-weight:600}
    .scroll-y{max-height:430px;overflow-y:auto}
    .scroll-y::-webkit-scrollbar{width:6px}
    .scroll-y::-webkit-scrollbar-thumb{background:#1f2937;border-radius:999px}
  </style>
</head>
<body class="min-h-screen">

  <!-- TOP BAR -->
  <header class="border-b border-slate-800 bg-slate-950/95 sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <a href="index.html" class="text-xs text-slate-300 hover:text-white flex items-center">
          ‚Üê Back to Home
        </a>
        <h1 class="text-lg sm:text-2xl font-bold text-white">
          BizLink <span class="text-purple-400">Owner Dashboard</span>
        </h1>
      </div>
      <div class="flex items-center space-x-3 text-xs sm:text-sm">
        <span class="hidden sm:inline text-slate-300">
          Logged in as <span id="ownerEmailLabel" class="font-semibold">Owner</span>
        </span>
        <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-1.5 rounded-md text-xs font-semibold">
          Logout
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">

    <!-- STATS -->
    <section class="grid sm:grid-cols-4 gap-4 mb-6">
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">Total Works</p>
        <p id="statTotal" class="text-2xl font-bold text-slate-100">0</p>
      </div>
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">Pending</p>
        <p id="statPending" class="text-2xl font-bold text-yellow-400">0</p>
      </div>
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">In Progress</p>
        <p id="statAccepted" class="text-2xl font-bold text-green-400">0</p>
      </div>
      <div class="card-bg rounded-xl px-4 py-4">
        <p class="text-xs text-slate-400 mb-1">Completed</p>
        <p id="statCompleted" class="text-2xl font-bold text-sky-400">0</p>
      </div>
    </section>

    <!-- TABS -->
    <section class="mb-4">
      <nav class="-mb-px flex space-x-6 overflow-x-auto" id="statusTabs">
        <button class="tab-button active whitespace-nowrap py-2 text-sm" data-tab="All">All</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-tab="Pending">Pending</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-tab="Accepted">In Progress</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-tab="Completed">Completed</button>
        <button class="tab-button whitespace-nowrap py-2 text-sm" data-tab="Paid">Paid</button>
      </nav>
    </section>

    <!-- MAIN LAYOUT -->
    <section class="grid lg:grid-cols-2 gap-6">

      <!-- LEFT: WORK LIST -->
      <div class="card-bg rounded-xl p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-semibold text-slate-200">Your Posted Works</h2>
          <p class="text-[11px] text-slate-400">
            Filter: <span id="currentFilterLabel" class="font-semibold">All</span>
          </p>
        </div>

        <p class="text-xs text-slate-400 mb-4">
          Yahan aap apne saare works dekh sakte ho, kisi freelancer ko assign kar sakte ho,
          chat open kar sakte ho aur payment mark kar sakte ho.
        </p>

        <div id="workList" class="space-y-3 scroll-y">
          <!-- JS will inject cards -->
        </div>
      </div>

      <!-- RIGHT: CHAT PANEL -->
      <div class="card-bg rounded-xl p-4 flex flex-col">
        <div id="chatHeader" class="border-b border-slate-800 pb-3 mb-3">
          <p class="text-xs text-slate-400">Chat Panel</p>
          <h2 id="chatTitle" class="text-sm font-semibold text-slate-100 mt-1">
            Select a work to start chatting
          </h2>
          <p id="chatSubtitle" class="text-xs text-slate-400 mt-1">
            Kisi work card par <span class="font-semibold text-slate-200">‚ÄúOpen Chat‚Äù</span> click karo.
          </p>
        </div>

        <div id="chatMessages" class="flex-1 scroll-y space-y-3 text-xs">
          <div class="h-full flex flex-col items-center justify-center text-center text-slate-500">
            <div class="mb-2 text-2xl">üí¨</div>
            <p>No work selected.</p>
          </div>
        </div>

        <form id="chatForm" class="mt-3 flex gap-2 items-center">
          <input
            id="chatInput"
            type="text"
            placeholder="Type a message‚Ä¶ (Owner ‚Üí Freelancer)"
            class="flex-1 text-xs px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
          <button
            type="submit"
            class="button-gradient px-4 py-2 rounded-lg text-xs font-semibold text-white disabled:opacity-50"
          >
            Send
          </button>
        </form>
      </div>
    </section>
  </main>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <script>
    // ‚úÖ SAME FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBtle51gX5kHufuWZ_YVOIQdDR05kbCE5I",
      authDomain: "bizlink-exchange.firebaseapp.com",
      projectId: "bizlink-exchange",
      storageBucket: "bizlink-exchange.firebasestorage.app",
      messagingSenderId: "116213651971",
      appId: "1:116213651971:web:fff60961af0c4da3448c36",
      measurementId: "G-VQ3JM82D1N"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
  </script>

  <script>
    // üîó Apps Script endpoint
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx33xzS-1OyIoSRJcnUt0y3EJR3-GMm96DDnefgI93AXdr_IkDiDCg2ww45epJ5Q-5D1g/exec";

    let ownerEmail = null;
    let works = [];           // filtered by owner
    let currentTab = "All";
    let currentWorkId = null;
    let chatCache = {};       // WorkID -> messages[]

    const ownerEmailLabel = document.getElementById("ownerEmailLabel");
    const logoutBtn = document.getElementById("logoutBtn");
    const workList = document.getElementById("workList");
    const currentFilterLabel = document.getElementById("currentFilterLabel");

    const statTotal = document.getElementById("statTotal");
    const statPending = document.getElementById("statPending");
    const statAccepted = document.getElementById("statAccepted");
    const statCompleted = document.getElementById("statCompleted");

    const chatMessagesEl = document.getElementById("chatMessages");
    const chatTitleEl = document.getElementById("chatTitle");
    const chatSubtitleEl = document.getElementById("chatSubtitle");
    const chatForm = document.getElementById("chatForm");
    const chatInput = document.getElementById("chatInput");

    /* ---------- AUTH GUARD ---------- */
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        alert("Please login as owner first.");
        window.location.href = "login.html";
        return;
      }
      ownerEmail = user.email;
      ownerEmailLabel.textContent = ownerEmail || "Owner";
      await loadOwnerWorks();
    });

    logoutBtn.addEventListener("click", () => {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    });

    /* ---------- API HELPERS ---------- */
    async function apiGet(params) {
      const url = SCRIPT_URL + "?" + new URLSearchParams(params).toString();
      const res = await fetch(url);
      if (!res.ok) throw new Error("HTTP " + res.status);
      return res.json();
    }

    async function apiPost(bodyObj) {
      const form = new URLSearchParams();
      Object.keys(bodyObj).forEach(k => form.append(k, bodyObj[k]));
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: form.toString()
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return res.json();
    }

    /* ---------- LOAD WORKS FOR OWNER ---------- */
    async function loadOwnerWorks() {
      try {
        workList.innerHTML = `
          <div class="py-8 text-center text-xs text-slate-500">
            Loading your works‚Ä¶
          </div>
        `;

        const data = await apiGet({
          action: "listWorksForOwner",
          ownerEmail: ownerEmail
        });

        if (!data.ok) {
          throw new Error(data.error || "API error");
        }

        works = data.works || [];
        updateStats();
        renderWorkList();
      } catch (err) {
        console.error(err);
        workList.innerHTML = `
          <div class="py-8 text-center text-xs text-red-400">
            Error loading works: ${err.message}
          </div>
        `;
      }
    }

    function updateStats() {
      const total = works.length;
      const pending = works.filter(w => (w.Status || "").toLowerCase() === "pending").length;
      const accepted = works.filter(w => (w.Status || "").toLowerCase() === "accepted").length;
      const completed = works.filter(w => (w.Status || "").toLowerCase() === "completed").length;

      statTotal.textContent = total;
      statPending.textContent = pending;
      statAccepted.textContent = accepted;
      statCompleted.textContent = completed;
    }

    function getWorksForTab(tab) {
      if (tab === "All") return works;
      if (tab === "Paid") {
        return works.filter(w => {
          const pay = (w.PaymentStatus || w.PaidStatus || "").toString().toLowerCase();
          return pay === "paid";
        });
      }
      return works.filter(w => (w.Status || "").toLowerCase() === tab.toLowerCase());
    }

    function statusChip(status, work) {
      const s = (status || "").toLowerCase();
      const pay = (work.PaymentStatus || work.PaidStatus || "").toString().toLowerCase();
      if (pay === "paid") {
        return '<span class="chip chip-paid">Paid</span>';
      }
      if (s === "pending")   return '<span class="chip chip-pending">Pending</span>';
      if (s === "accepted")  return '<span class="chip chip-accepted">In Progress</span>';
      if (s === "completed") return '<span class="chip chip-completed">Completed</span>';
      return '<span class="chip chip-pending">' + (status || "Pending") + '</span>';
    }

    function formatBudget(val) {
      if (!val && val !== 0) return "N/A";
      const num = Number(val) || 0;
      return "‚Çπ" + num.toLocaleString("en-IN");
    }

    /* ---------- RENDER WORK LIST ---------- */
    function renderWorkList() {
      const items = getWorksForTab(currentTab);

      currentFilterLabel.textContent = currentTab;

      if (!items.length) {
        workList.innerHTML = `
          <div class="py-12 text-center text-xs text-slate-500">
            No works in <span class="font-semibold">${currentTab}</span>.
          </div>
        `;
        return;
      }

      workList.innerHTML = items.map(w => {
        const canAssign = !w.AssignedTo;
        const status = w.Status || "Pending";
        const statusLower = status.toLowerCase();
        const payStatus = (w.PaymentStatus || w.PaidStatus || "").toString().toLowerCase();
        const canMarkPaid = statusLower === "completed" && payStatus !== "paid";

        return `
          <article class="card-bg rounded-lg p-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <h3 class="text-sm font-semibold text-slate-100">${w.Title || "No Title"}</h3>
                ${statusChip(status, w)}
              </div>
              <p class="text-xs text-slate-400">
                ${w.City || ""} ¬∑ ${w.Category || ""} ¬∑
                Budget: <span class="text-emerald-400 font-semibold">${formatBudget(w.Budget)}</span>
              </p>
              <p class="text-[11px] text-slate-500 mt-1">
                ID: <span class="font-mono text-slate-300">${w.WorkID || ""}</span>
                ${w.AssignedTo ? ` ¬∑ Assigned: <span class="text-slate-200">${w.AssignedTo}</span>` : ''}
              </p>
            </div>
            <div class="flex flex-col sm:items-end gap-2 text-xs">
              <div class="flex flex-wrap gap-2">
                ${
                  canAssign
                    ? `<button data-action="assign" data-id="${w.WorkID}"
                         class="px-3 py-1 rounded-md bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold">
                         Assign
                       </button>`
                    : ""
                }
                <button data-action="open-chat" data-id="${w.WorkID}"
                  class="px-3 py-1 rounded-md border border-slate-600 hover:border-purple-500 text-slate-100 font-semibold">
                  Open Chat
                </button>
                ${
                  canMarkPaid
                    ? `<button data-action="mark-paid" data-id="${w.WorkID}"
                         class="px-3 py-1 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white font-semibold">
                         Mark Paid
                       </button>`
                    : ""
                }
              </div>
              <p class="text-[10px] text-slate-500">
                ${w.PostedOn ? ("Posted: " + new Date(w.PostedOn).toLocaleString()) : ""}
              </p>
            </div>
          </article>
        `;
      }).join("");
    }

    /* ---------- CHAT RENDER ---------- */
    function renderChat(workId) {
      const work = works.find(w => w.WorkID == workId);
      if (!work) {
        chatTitleEl.textContent = "Select a work to start chatting";
        chatSubtitleEl.textContent = "";
        chatMessagesEl.innerHTML = "";
        return;
      }

      chatTitleEl.textContent = work.Title || "Work";
      chatSubtitleEl.textContent = `${work.City || ""} ¬∑ ID: ${work.WorkID}`;

      const msgs = chatCache[workId] || [];

      if (!msgs.length) {
        chatMessagesEl.innerHTML = `
          <div class="py-10 text-center text-xs text-slate-500">
            No messages yet. Pehla message bhej kar conversation start karo.
          </div>
        `;
        return;
      }

      chatMessagesEl.innerHTML = msgs.map(m => {
        const isOwner = (m.FromRole || "").toLowerCase() === "owner" ||
                        (m.FromEmail || "").toLowerCase() === (ownerEmail || "").toLowerCase();
        const align = isOwner ? "items-end" : "items-start";
        const bubbleClasses = isOwner
          ? "bg-violet-600 text-white rounded-2xl rounded-br-none"
          : "bg-slate-800 text-slate-100 rounded-2xl rounded-bl-none";
        const metaAlign = isOwner ? "text-right" : "text-left";
        const who = isOwner ? "You" : (m.FromRole || "Freelancer");
        const timeStr = m.CreatedAt ? new Date(m.CreatedAt).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}) : "";

        return `
          <div class="flex ${align}">
            <div class="max-w-[80%]">
              <div class="px-3 py-2 ${bubbleClasses} text-[11px]">
                ${m.Message}
              </div>
              <p class="mt-1 text-[10px] text-slate-500 ${metaAlign}">
                ${who} ¬∑ ${timeStr}
              </p>
            </div>
          </div>
        `;
      }).join("");

      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    async function loadChat(workId) {
      try {
        const data = await apiGet({
          action: "getChatMessages",
          WorkID: workId
        });
        if (!data.ok) throw new Error(data.error || "Chat load error");
        chatCache[workId] = data.messages || [];
        renderChat(workId);
      } catch (err) {
        console.error(err);
        chatMessagesEl.innerHTML = `
          <div class="py-8 text-center text-xs text-red-400">
            Error loading chat: ${err.message}
          </div>
        `;
      }
    }

    /* ---------- EVENTS ---------- */
    // Tabs
    document.getElementById("statusTabs").addEventListener("click", (e) => {
      const btn = e.target.closest("[data-tab]");
      if (!btn) return;
      const tab = btn.getAttribute("data-tab");
      currentTab = tab;

      document.querySelectorAll("#statusTabs .tab-button").forEach(b => {
        b.classList.toggle("active", b.getAttribute("data-tab") === tab);
      });

      renderWorkList();
    });

    // Work list actions
    workList.addEventListener("click", async (e) => {
      const btn = e.target.closest("[data-action]");
      if (!btn) return;

      const action = btn.getAttribute("data-action");
      const workId = btn.getAttribute("data-id");
      if (!workId) return;

      const work = works.find(w => w.WorkID == workId);
      if (!work) return;

      if (action === "assign") {
        const email = prompt("Freelancer email / ID to assign:");
        if (!email) return;
        try {
          const res = await apiPost({
            action: "assignFreelancer",
            WorkID: workId,
            freelancerEmail: email,
            notes: "Assigned by owner dashboard"
          });
          if (!res.ok) throw new Error(res.error || "Assign error");
          alert("Assigned successfully.");
          // Local update
          work.AssignedTo = email;
          renderWorkList();
        } catch (err) {
          alert("Error assigning: " + err.message);
        }
      }

      if (action === "open-chat") {
        currentWorkId = workId;
        await loadChat(workId);
      }

      if (action === "mark-paid") {
        if (!confirm("Mark this work as PAID?")) return;
        const amount = work.Budget || "";
        try {
          const res = await apiPost({
            action: "markPaid",
            WorkID: workId,
            freelancerEmail: work.AssignedTo || "",
            amount: amount,
            notes: "Marked paid from owner dashboard"
          });
          if (!res.ok) throw new Error(res.error || "Payment update error");
          alert("Payment marked as Paid.");
          // Local update (agar column exist kare to)
          work.PaymentStatus = "Paid";
          renderWorkList();
        } catch (err) {
          alert("Error marking paid: " + err.message);
        }
      }
    });

    // Chat send
    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;

      if (!currentWorkId) {
        alert("Pehele koi work select karo (Open Chat button).");
        return;
      }

      try {
        const res = await apiPost({
          action: "sendMessage",
          WorkID: currentWorkId,
          FromRole: "Owner",
          FromEmail: ownerEmail || "",
          Message: text
        });
        if (!res.ok) throw new Error(res.error || "Send error");

        const now = new Date();
        const newMsg = {
          WorkID: currentWorkId,
          MessageID: res.MessageID || ("TEMP-" + now.getTime()),
          FromRole: "Owner",
          FromEmail: ownerEmail,
          Message: text,
          CreatedAt: res.CreatedAt || now
        };
        if (!chatCache[currentWorkId]) chatCache[currentWorkId] = [];
        chatCache[currentWorkId].push(newMsg);
        chatInput.value = "";
        renderChat(currentWorkId);
      } catch (err) {
        alert("Error sending message: " + err.message);
      }
    });
  </script>
</body>
</html>
