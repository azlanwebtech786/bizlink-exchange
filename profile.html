<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BizLink | My Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind & Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Poppins',sans-serif;background:#050816;color:#e5e7eb}
    .card-bg{background:#0f172a;border:1px solid rgba(148,163,184,.35)}
    .badge{font-size:.70rem;padding:.15rem .5rem;border-radius:999px}
    .badge-role{background:#a855f7;color:#f9fafb}
    .badge-plan{background:#22c55e1a;color:#bbf7d0;border:1px solid #22c55e66}
  </style>
</head>
<body class="min-h-screen">

  <!-- TOP BAR -->
  <header class="border-b border-slate-800 bg-slate-950/95 sticky top-0 z-40">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <a href="index.html" class="text-xs text-slate-300 hover:text-white flex items-center">
          ← Back to Home
        </a>
        <h1 class="text-lg sm:text-2xl font-bold text-white">
          My <span class="text-purple-400">BizLink Profile</span>
        </h1>
      </div>
      <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-md text-xs font-semibold">
        Logout
      </button>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <div id="profileStatus" class="mb-3 text-xs text-slate-400"></div>

    <section class="card-bg rounded-2xl p-5 flex flex-col sm:flex-row gap-5 items-start">
      <div class="w-20 h-20 rounded-full bg-slate-800 flex items-center justify-center text-2xl font-bold">
        <span id="profileInitials">BZ</span>
      </div>

      <div class="flex-1 space-y-2">
        <div class="flex flex-wrap items-center gap-2">
          <h2 id="profileName" class="text-xl font-semibold text-slate-100">Loading...</h2>
          <span id="profileBizID" class="badge badge-role">BZ----</span>
          <span id="profileRole" class="badge badge-role">Role</span>
          <span id="profilePlan" class="badge badge-plan">Plan</span>
        </div>

        <p id="profileEmail" class="text-sm text-slate-300"></p>
        <p id="profileCity" class="text-xs text-slate-400"></p>

        <div class="mt-3 flex flex-wrap items-center gap-4 text-xs">
          <div>
            <p class="text-slate-400">Rating</p>
            <p class="text-lg font-semibold text-yellow-300">
              <span id="profileRating">–</span> <span class="text-sm">/ 5</span>
            </p>
          </div>
          <div>
            <p class="text-slate-400">Total Reviews</p>
            <p class="text-lg font-semibold text-slate-100" id="profileTotalReviews">0</p>
          </div>
          <div>
            <p class="text-slate-400">Joined</p>
            <p class="text-xs font-medium text-slate-200" id="profileJoinedAt">–</p>
          </div>
          <div>
            <p class="text-slate-400">Last Login</p>
            <p class="text-xs font-medium text-slate-200" id="profileLastLogin">–</p>
          </div>
        </div>
      </div>
    </section>

    <section class="mt-5 card-bg rounded-2xl p-4 text-xs text-slate-400">
      <h3 class="text-sm font-semibold text-slate-100 mb-2">Profile Info</h3>
      <p>
        Ye profile data aapke signup ke time se <span class="font-semibold text-slate-200">Users Google Sheet</span> se aa raha hai.
        Aage chal kar yahin se <span class="text-purple-300 font-semibold">public profile / rating badge</span> generate hoga.
      </p>
    </section>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBtle51gX5kHufuWZ_YVOIQdDR05kbCE5I",
      authDomain: "bizlink-exchange.firebaseapp.com",
      projectId: "bizlink-exchange",
      storageBucket: "bizlink-exchange.firebasestorage.app",
      messagingSenderId: "116213651971",
      appId: "1:116213651971:web:fff60961af0c4da3448c36",
      measurementId: "G-VQ3JM82D1N"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
  </script>

  <script>
    const USERS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyt_-zovOHhovnE067tC_XQEEVAP3R-j0QxN9lhxzqcTpmHYwoHzKzbrJ7O3UYvqA7H/exec";

    const statusEl   = document.getElementById("profileStatus");
    const nameEl     = document.getElementById("profileName");
    const emailEl    = document.getElementById("profileEmail");
    const cityEl     = document.getElementById("profileCity");
    const bizIdEl    = document.getElementById("profileBizID");
    const roleEl     = document.getElementById("profileRole");
    const planEl     = document.getElementById("profilePlan");
    const ratingEl   = document.getElementById("profileRating");
    const reviewsEl  = document.getElementById("profileTotalReviews");
    const joinedEl   = document.getElementById("profileJoinedAt");
    const lastLoginEl= document.getElementById("profileLastLogin");
    const initialsEl = document.getElementById("profileInitials");

    function setStatus(msg, type="info"){
      statusEl.textContent = msg || "";
      if(!msg){
        statusEl.className = "mb-3 text-xs text-slate-400";
      } else if(type === "error"){
        statusEl.className = "mb-3 text-xs text-red-300";
      } else {
        statusEl.className = "mb-3 text-xs text-slate-300";
      }
    }

    function makeInitials(name, email){
      if(name && name.trim()){
        const parts = name.trim().split(" ");
        const first = parts[0]?.[0] || "";
        const second= parts[1]?.[0] || "";
        return (first + second).toUpperCase();
      }
      if(email){
        return email[0].toUpperCase();
      }
      return "BZ";
    }

    async function loadProfile(email){
      try{
        setStatus("Loading profile…");
        const url = `${USERS_SCRIPT_URL}?action=getUserProfile&email=${encodeURIComponent(email)}`;
        const res = await fetch(url);
        const data = await res.json();
        console.log("getUserProfile:", data);

        if(!data.ok || !data.user){
          setStatus("Profile not found in Users sheet. Ho sakta hai signup ke time entry nahi bani ho.", "error");
          nameEl.textContent = "No profile found";
          emailEl.textContent = email;
          return;
        }

        const u = data.user;

        nameEl.textContent   = u.FullName || "No Name";
        emailEl.textContent  = u.Email || email;
        cityEl.textContent   = u.City ? ("City: " + u.City) : "";
        bizIdEl.textContent  = u.BizID || "BZ----";
        roleEl.textContent   = u.Role || "Role";
        planEl.textContent   = u.Plan || "Free";

        initialsEl.textContent = makeInitials(u.FullName, u.Email);

        const rating = u.Rating ? Number(u.Rating) : null;
        if(rating){
          ratingEl.textContent = rating.toFixed(1);
        } else {
          ratingEl.textContent = "–";
        }

        reviewsEl.textContent = u.TotalReviews || "0";
        joinedEl.textContent  = u.JoinedAt || "–";
        lastLoginEl.textContent = u.LastLogin || "–";

        setStatus(""); // clear
      }catch(err){
        console.error(err);
        setStatus("Error loading profile: " + err.message, "error");
      }
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut().then(() => {
        localStorage.removeItem("bizlink_user_email");
        localStorage.removeItem("bizlink_user_role");
        window.location.href = "index.html";
      });
    });

    auth.onAuthStateChanged((user) => {
      if(!user){
        alert("Please login first.");
        window.location.href = "login.html";
        return;
      }
      const email = user.email.toLowerCase();
      loadProfile(email);
    });
  </script>
</body>
</html>
