<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BizLink | My Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind + Font -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    body{font-family:'Poppins',sans-serif;background:#050816;color:#e5e7eb}
    .card-bg{background:#0f172a;border:1px solid rgba(148,163,184,.35)}
    .badge{font-size:.70rem;padding:.15rem .55rem;border-radius:999px;font-weight:500}
    .badge-role{background:rgba(96,165,250,.15);color:#bfdbfe;border:1px solid rgba(96,165,250,.5)}
    .badge-plan{background:rgba(16,185,129,.15);color:#a7f3d0;border:1px solid rgba(16,185,129,.5)}
    .badge-bizid{background:rgba(168,85,247,.15);color:#e9d5ff;border:1px solid rgba(168,85,247,.5)}
  </style>
</head>
<body class="min-h-screen">

  <!-- TOP BAR -->
  <header class="border-b border-slate-800 bg-slate-950/95 sticky top-0 z-40">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <a href="index.html" class="text-xs text-slate-300 hover:text-white flex items-center">
          ‚Üê Back to Home
        </a>
        <h1 class="text-lg sm:text-2xl font-bold text-white">
          My <span class="text-purple-400">BizLink</span> Profile
        </h1>
      </div>
      <div class="flex items-center space-x-3 text-xs sm:text-sm">
        <span id="topEmail" class="hidden sm:inline text-slate-300"></span>
        <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-1.5 rounded-md text-xs font-semibold">
          Logout
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6">
    <p id="statusText" class="mb-3 text-xs text-slate-400"></p>

    <!-- PROFILE CARD -->
    <section id="profileCard" class="card-bg rounded-2xl p-5 sm:p-6 mb-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 rounded-full bg-purple-600 flex items-center justify-center text-xl font-bold">
            <span id="avatarInitials">BZ</span>
          </div>
          <div>
            <h2 id="displayName" class="text-lg sm:text-xl font-semibold text-slate-50">
              No profile found
            </h2>
            <p id="displayEmail" class="text-xs text-slate-400">‚Äî</p>
            <div class="flex flex-wrap gap-2 mt-2 text-[11px]">
              <span id="bizIdBadge" class="badge badge-bizid">BZ----</span>
              <span id="roleBadge" class="badge badge-role">Role</span>
              <span id="planBadge" class="badge badge-plan">Plan</span>
            </div>
          </div>
        </div>

        <div class="text-xs text-slate-400 sm:text-right">
          <p>Rating: <span id="ratingText" class="font-semibold text-yellow-300">- / 5</span></p>
          <p>Total Reviews: <span id="totalReviewsText" class="font-semibold">0</span></p>
          <p>Joined: <span id="joinedText" class="font-semibold">-</span></p>
          <p>Last Login: <span id="lastLoginText" class="font-semibold">-</span></p>
        </div>
      </div>
    </section>

    <!-- PROFILE INFO / SUMMARY -->
    <section class="grid md:grid-cols-2 gap-5">
      <!-- Basic details -->
      <div class="card-bg rounded-2xl p-5">
        <h3 class="text-sm font-semibold text-slate-100 mb-3">Basic Details</h3>
        <dl class="text-xs space-y-2 text-slate-300">
          <div class="flex justify-between">
            <dt class="text-slate-400">Full Name</dt>
            <dd id="fieldFullName" class="font-medium text-slate-100">‚Äî</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">Role / Account Type</dt>
            <dd id="fieldRole">‚Äî</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">Phone</dt>
            <dd id="fieldPhone">‚Äî</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">City</dt>
            <dd id="fieldCity">‚Äî</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">BizLink ID</dt>
            <dd id="fieldBizId" class="font-mono">‚Äî</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">Plan</dt>
            <dd id="fieldPlan">‚Äî</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">Account Status</dt>
            <dd id="fieldStatus">‚Äî</dd>
          </div>
        </dl>
      </div>

      <!-- Info text -->
      <div class="card-bg rounded-2xl p-5">
        <h3 class="text-sm font-semibold text-slate-100 mb-3">Profile Info</h3>
        <p class="text-xs text-slate-300 leading-relaxed">
          Ye profile data <span class="font-semibold">BizLink_Users ‚Üí Users</span> 
          Google Sheet se aa raha hai (signup ke time auto entry).
          <br/><br/>
          Future me yahin se aapka
          <span class="font-semibold text-purple-300"> public profile link</span>,
          <span class="font-semibold text-sky-300"> rating badge</span> 
          aur activity summary generate hoga.
        </p>
      </div>
    </section>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <script>
    // Firebase config (same jo dusri pages par hai)
    const firebaseConfig = {
      apiKey: "AIzaSyBtle51gX5kHufuWZ_YVOIQdDR05kbCE5I",
      authDomain: "bizlink-exchange.firebaseapp.com",
      projectId: "bizlink-exchange",
      storageBucket: "bizlink-exchange.firebasestorage.app",
      messagingSenderId: "116213651971",
      appId: "1:116213651971:web:fff60961af0c4da3448c36",
      measurementId: "G-VQ3JM82D1N"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // üëâ YAHI pe tumhara naya Users Apps Script URL
    const USERS_SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbztkBN5GcgZdPARgOSrvBvgJcfClCvXzIq0mEk64TpaShqQ4FzpFAjQ742Io70wyzNa/exec";

    const statusText   = document.getElementById("statusText");
    const topEmail     = document.getElementById("topEmail");

    const avatarInitials = document.getElementById("avatarInitials");
    const displayName    = document.getElementById("displayName");
    const displayEmail   = document.getElementById("displayEmail");
    const bizIdBadge     = document.getElementById("bizIdBadge");
    const roleBadge      = document.getElementById("roleBadge");
    const planBadge      = document.getElementById("planBadge");

    const ratingText       = document.getElementById("ratingText");
    const totalReviewsText = document.getElementById("totalReviewsText");
    const joinedText       = document.getElementById("joinedText");
    const lastLoginText    = document.getElementById("lastLoginText");

    const fieldFullName = document.getElementById("fieldFullName");
    const fieldRole     = document.getElementById("fieldRole");
    const fieldPhone    = document.getElementById("fieldPhone");
    const fieldCity     = document.getElementById("fieldCity");
    const fieldBizId    = document.getElementById("fieldBizId");
    const fieldPlan     = document.getElementById("fieldPlan");
    const fieldStatus   = document.getElementById("fieldStatus");

    function setStatus(msg, type="info"){
      statusText.textContent = msg || "";
      if(!msg){
        statusText.className = "mb-3 text-xs text-slate-400";
      }else if(type==="error"){
        statusText.className = "mb-3 text-xs text-red-300";
      }else{
        statusText.className = "mb-3 text-xs text-slate-300";
      }
    }

    function showNoProfile(email){
      displayName.textContent = "No profile found";
      displayEmail.textContent = email || "‚Äî";
      fieldFullName.textContent = "‚Äî";
      fieldRole.textContent     = "‚Äî";
      fieldPhone.textContent    = "‚Äî";
      fieldCity.textContent     = "‚Äî";
      fieldBizId.textContent    = "‚Äî";
      fieldPlan.textContent     = "‚Äî";
      fieldStatus.textContent   = "‚Äî";
      bizIdBadge.textContent    = "BZ----";
      roleBadge.textContent     = "Role";
      planBadge.textContent     = "Plan";
      ratingText.textContent    = "- / 5";
      totalReviewsText.textContent = "0";
      joinedText.textContent    = "-";
      lastLoginText.textContent = "-";

      setStatus("Profile not found in Users sheet. Ho sakta hai signup ke time entry nahi bani ho.", "error");
    }

    function formatDate(d){
      if(!d) return "-";
      const dt = new Date(d);
      if(isNaN(dt.getTime())) return d.toString();
      return dt.toLocaleDateString();
    }

    async function loadProfile(email){
      if(!email) return;
      try{
        setStatus("Loading profile‚Ä¶");

        const url = `${USERS_SCRIPT_URL}?action=getProfile&email=${encodeURIComponent(email)}`;
        const res = await fetch(url);
        const data = await res.json();

        if(!data.ok || !data.profile){
          showNoProfile(email);
          return;
        }

        const p = data.profile;

        // LocalStorage me save (baaki pages ke liye)
        try{
          if(p.Role)   localStorage.setItem("bizlink_user_role", p.Role.toLowerCase());
          if(p.Plan)   localStorage.setItem("bizlink_user_plan", p.Plan);
          if(p.BizID)  localStorage.setItem("bizlink_user_id", p.BizID);
        }catch(e){}

        const fullName = p.FullName || "BizLink User";
        const role     = p.Role || "-";
        const city     = p.City || "-";
        const plan     = p.Plan || "Free";
        const bizId    = p.BizID || "BZ----";
        const rating   = p.Rating || "-";
        const reviews  = p.TotalReviews || 0;
        const joined   = p.JoinedAt || "";
        const lastLogin= p.LastLogin || "";
        const status   = p.Status || "active";
        const phone    = p.Phone || "-";

        // Avatar initials
        const initials = fullName.trim().split(/\s+/).map(w=>w[0]).join("").slice(0,2).toUpperCase();
        avatarInitials.textContent = initials || "BZ";

        displayName.textContent  = fullName;
        displayEmail.textContent = email;
        bizIdBadge.textContent   = bizId;
        roleBadge.textContent    = role;
        planBadge.textContent    = plan;

        ratingText.textContent       = `${rating} / 5`;
        totalReviewsText.textContent = reviews;
        joinedText.textContent       = formatDate(joined);
        lastLoginText.textContent    = formatDate(lastLogin);

        fieldFullName.textContent = fullName;
        fieldRole.textContent     = role;
        fieldPhone.textContent    = phone;
        fieldCity.textContent     = city;
        fieldBizId.textContent    = bizId;
        fieldPlan.textContent     = plan;
        fieldStatus.textContent   = status;

        setStatus("");
      }catch(err){
        console.error(err);
        showNoProfile(email);
        setStatus("Error loading profile: " + err.message, "error");
      }
    }

    // Logout
    document.getElementById("logoutBtn").addEventListener("click",()=>{
      auth.signOut().then(()=>{
        try{
          localStorage.removeItem("bizlink_user_role");
          localStorage.removeItem("bizlink_user_plan");
          localStorage.removeItem("bizlink_user_id");
          localStorage.removeItem("bizlink_user_email");
        }catch(e){}
        window.location.href = "index.html";
      });
    });

    // Auth guard
    auth.onAuthStateChanged(user=>{
      if(!user){
        alert("Please login first.");
        window.location.href = "login.html";
        return;
      }

      const email = (user.email || "").toLowerCase();
      topEmail.textContent = `Logged in as: ${email}`;
      topEmail.classList.remove("hidden");

      try{
        localStorage.setItem("bizlink_user_email", email);
      }catch(e){}

      loadProfile(email);
    });
  </script>
</body>
</html>
