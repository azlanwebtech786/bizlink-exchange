<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BizLink | My Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind & Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Poppins',sans-serif;background:#050816;color:#e5e7eb}
    .card-bg{background:#0f172a;border:1px solid rgba(148,163,184,.32)}
    .badge{font-size:.70rem;padding:.15rem .6rem;border-radius:999px;font-weight:600}
    .badge-purple{background:#a855f7;color:white}
    .badge-blue{background:#2563eb;color:white}
    .badge-green{background:#16a34a;color:white}
  </style>
</head>
<body class="min-h-screen">

  <!-- TOP BAR -->
  <header class="border-b border-slate-800 bg-slate-950/95 sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3 text-sm">
        <a href="index.html" class="text-xs text-slate-300 hover:text-white flex items-center">
          ← Back to Home
        </a>
        <h1 class="text-lg sm:text-2xl font-bold text-white">
          My <span class="text-purple-400">BizLink</span> Profile
        </h1>
      </div>
      <div class="flex items-center space-x-3 text-xs sm:text-sm">
        <span id="loggedInEmail" class="hidden sm:inline text-slate-300"></span>
        <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-1.5 rounded-md text-xs font-semibold">
          Logout
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- STATUS LINE -->
    <p id="profileStatus" class="text-xs text-rose-300 mb-3 hidden">
      Profile not found in Users sheet. Ho sakta hai signup ke time entry nahi bani ho.
    </p>

    <!-- TOP PROFILE CARD -->
    <section id="topCard" class="card-bg rounded-2xl p-4 sm:p-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 sm:w-16 sm:h-16 rounded-full bg-purple-600 flex items-center justify-center text-xl font-bold">
          <span id="avatarInitials">BZ</span>
        </div>
        <div>
          <h2 id="displayName" class="text-lg sm:text-xl font-semibold text-slate-50">No profile found</h2>
          <p id="displayEmail" class="text-xs text-slate-300 mt-1">—</p>
          <div class="flex flex-wrap gap-2 mt-2">
            <span id="bizIdBadge" class="badge badge-purple">BZ----</span>
            <span id="roleBadge" class="badge badge-blue">Role</span>
            <span id="planBadge" class="badge badge-green">Plan</span>
          </div>
        </div>
      </div>

      <div class="text-right text-xs sm:text-sm space-y-1">
        <p><span class="font-semibold">Rating:</span> <span id="ratingValue">- / 5</span></p>
        <p><span class="font-semibold">Total Reviews:</span> <span id="ratingCount">0</span></p>
        <p><span class="font-semibold">Joined:</span> <span id="joinedAtText">-</span></p>
        <p><span class="font-semibold">Last Login:</span> <span id="lastLoginText">-</span></p>
      </div>
    </section>

    <!-- DETAILS + INFO -->
    <section class="grid md:grid-cols-2 gap-6 mb-6">
      <!-- BASIC DETAILS -->
      <div class="card-bg rounded-2xl p-4 sm:p-5">
        <h3 class="text-sm font-semibold mb-3 text-slate-100">Basic Details</h3>
        <dl class="space-y-2 text-xs sm:text-sm">
          <div class="flex justify-between">
            <dt class="text-slate-400">Full Name</dt>
            <dd id="bdFullName" class="text-slate-100 text-right">—</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">Role / Account Type</dt>
            <dd id="bdRole" class="text-slate-100 text-right">—</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">Phone</dt>
            <dd id="bdPhone" class="text-slate-100 text-right">—</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">City</dt>
            <dd id="bdCity" class="text-slate-100 text-right">—</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">BizLink ID</dt>
            <dd id="bdBizId" class="text-slate-100 text-right">—</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">Plan</dt>
            <dd id="bdPlan" class="text-slate-100 text-right">—</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">Account Status</dt>
            <dd id="bdStatus" class="text-slate-100 text-right">—</dd>
          </div>
        </dl>
      </div>

      <!-- PROFILE INFO -->
      <div class="card-bg rounded-2xl p-4 sm:p-5">
        <h3 class="text-sm font-semibold mb-3 text-slate-100">Profile Info</h3>
        <p class="text-xs sm:text-sm text-slate-300 leading-relaxed">
          Ye profile data <span class="font-semibold">BizLink_Users → Users</span>
          Google Sheet se aa raha hai (signup ke time auto entry).
        </p>
        <p class="text-xs sm:text-sm text-slate-300 leading-relaxed mt-3">
          Future me yahin se aapka <span class="font-semibold">public profile link, rating badge</span>
          aur <span class="font-semibold">activity summary</span> generate hoga.
        </p>
      </div>
    </section>

    <!-- ACTIVITY SUMMARY (placeholder abhi) -->
    <section class="card-bg rounded-2xl p-4 sm:p-5 mt-4">
      <h3 class="text-sm font-semibold mb-3 text-slate-100">Activity Summary</h3>
      <p class="text-xs text-slate-400 mb-3">
        Abhi tak koi work <span class="font-semibold">Post a Work</span> se create nahi hua, isliye sab zero hai.
        Baad me yahan se aapke works ka overview show karenge.
      </p>
      <div class="grid sm:grid-cols-3 gap-4 text-center text-sm">
        <div class="border border-slate-700 rounded-xl py-4">
          <p class="text-slate-400 text-xs mb-1">Works Posted</p>
          <p class="text-2xl font-bold" id="statPosted">0</p>
        </div>
        <div class="border border-slate-700 rounded-xl py-4">
          <p class="text-slate-400 text-xs mb-1">In Progress</p>
          <p class="text-2xl font-bold" id="statInProgress">0</p>
        </div>
        <div class="border border-slate-700 rounded-xl py-4">
          <p class="text-slate-400 text-xs mb-1">Completed</p>
          <p class="text-2xl font-bold" id="statCompleted">0</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script>
    // ---- Firebase config (same as baaki pages) ----
    const firebaseConfig = {
      apiKey: "AIzaSyBtle51gX5kHufuWZ_YVOIQdDR05kbCE5I",
      authDomain: "bizlink-exchange.firebaseapp.com",
      projectId: "bizlink-exchange",
      storageBucket: "bizlink-exchange.firebasestorage.app",
      messagingSenderId: "116213651971",
      appId: "1:116213651971:web:fff60961af0c4da3448c36",
      measurementId: "G-VQ3M820IW"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
  </script>

  <script>
    // ---- SAME SCRIPT URL JO signup.html me hai ----
    const USERS_SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbztkBN5GcgZdPARgOSrvBvgJcfClCvXzIq0mEk64TpaShqQ4FzpFAjQ742Io70wyzNa/exec";

    // DOM refs
    const profileStatus  = document.getElementById("profileStatus");
    const loggedInEmailEl= document.getElementById("loggedInEmail");
    const avatarInitials = document.getElementById("avatarInitials");
    const displayName    = document.getElementById("displayName");
    const displayEmail   = document.getElementById("displayEmail");
    const bizIdBadge     = document.getElementById("bizIdBadge");
    const roleBadge      = document.getElementById("roleBadge");
    const planBadge      = document.getElementById("planBadge");
    const ratingValue    = document.getElementById("ratingValue");
    const ratingCount    = document.getElementById("ratingCount");
    const joinedAtText   = document.getElementById("joinedAtText");
    const lastLoginText  = document.getElementById("lastLoginText");

    const bdFullName = document.getElementById("bdFullName");
    const bdRole     = document.getElementById("bdRole");
    const bdPhone    = document.getElementById("bdPhone");
    const bdCity     = document.getElementById("bdCity");
    const bdBizId    = document.getElementById("bdBizId");
    const bdPlan     = document.getElementById("bdPlan");
    const bdStatus   = document.getElementById("bdStatus");

    function showStatus(msg) {
      if (!msg) {
        profileStatus.classList.add("hidden");
        return;
      }
      profileStatus.textContent = msg;
      profileStatus.classList.remove("hidden");
    }

    function setLocalRoleAndBizId(profile) {
      try {
        if (profile.role) {
          localStorage.setItem("bizlink_user_role", String(profile.role));
        }
        if (profile.bizId) {
          localStorage.setItem("bizlink_user_bizid", String(profile.bizId));
        }
      } catch (e) {
        console.warn("LocalStorage error:", e);
      }
    }

    function fillProfileCard(p, email) {
      const name = p.fullName || "New BizLink User";
      const initials = name
        .split(" ")
        .filter(Boolean)
        .map(w => w[0].toUpperCase())
        .join("")
        .slice(0,2) || "BZ";

      avatarInitials.textContent = initials;
      displayName.textContent    = name;
      displayEmail.textContent   = email || p.email || "-";

      bizIdBadge.textContent = p.bizId || "BZ----";
      roleBadge.textContent  = (p.role || "Role").toLowerCase();
      planBadge.textContent  = p.plan || "Free";

      ratingValue.textContent = (p.rating && p.rating !== "-")
        ? `${p.rating} / 5`
        : "- / 5";
      ratingCount.textContent = p.totalReviews || 0;
      joinedAtText.textContent = p.joinedAt || "-";
      lastLoginText.textContent= p.lastLogin || "-";

      bdFullName.textContent = name;
      bdRole.textContent     = p.role || "-";
      bdPhone.textContent    = p.phone || "-";
      bdCity.textContent     = p.city || "-";
      bdBizId.textContent    = p.bizId || "-";
      bdPlan.textContent     = p.plan || "-";
      bdStatus.textContent   = p.status || "-";
    }

    async function loadProfileForEmail(rawEmail) {
      if (!rawEmail) {
        showStatus("User email missing (auth issue).");
        return;
      }
      const email = rawEmail.trim().toLowerCase();
      loggedInEmailEl.textContent = `Logged in as: ${email}`;
      displayEmail.textContent = email;

      try {
        const url =
          `${USERS_SCRIPT_URL}?action=profile&email=${encodeURIComponent(email)}&ts=` +
          Date.now();
        const res = await fetch(url);
        const data = await res.json();

        console.log("PROFILE RESPONSE", data);

        if (!data || !data.ok || !data.profile) {
          showStatus("Profile not found in Users sheet. Ho sakta hai signup ke time entry nahi bani ho.");
          return;
        }

        showStatus(""); // hide red line
        const p = data.profile;
        fillProfileCard(p, email);
        setLocalRoleAndBizId(p);
      } catch (err) {
        console.error("Profile load error:", err);
        showStatus("Error loading profile. Thodi der baad try karein.");
      }
    }

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    });

    // Auth guard
    auth.onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      const email = (user.email || "").toLowerCase();
      loadProfileForEmail(email);
    });
  </script>
</body>
</html>
