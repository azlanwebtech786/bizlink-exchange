<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BizLink | My Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind & Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Poppins',sans-serif;background:#050816;color:#e5e7eb}
    .card-bg{background:#0f172a;border:1px solid rgba(148,163,184,.35)}
    .badge{font-size:.65rem;padding:.2rem .55rem;border-radius:999px}
    .badge-role{background:#1d4ed8;color:#bfdbfe}
    .badge-plan{background:#047857;color:#bbf7d0}
    .badge-id{background:#6b21a8;color:#f3e8ff}
  </style>
</head>
<body class="min-h-screen">

  <!-- TOP BAR -->
  <header class="border-b border-slate-800 bg-slate-950/95 sticky top-0 z-40">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="index.html" class="text-xs text-slate-300 hover:text-white flex items-center">
        ‚Üê Back to Home
      </a>
      <h1 class="text-lg sm:text-2xl font-bold text-white">
        My <span class="text-purple-400">BizLink</span> Profile
      </h1>
      <div class="flex items-center space-x-3 text-xs sm:text-sm">
        <span id="loggedInEmailTop" class="hidden sm:inline text-slate-300"></span>
        <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-md text-xs font-semibold">
          Logout
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6">
    <p id="pageStatus" class="mb-3 text-xs text-slate-400"></p>

    <!-- TOP PROFILE CARD -->
    <section class="card-bg rounded-2xl p-4 sm:p-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 sm:w-16 sm:h-16 rounded-full bg-purple-600 flex items-center justify-center text-lg font-bold">
          <span id="avatarInitials">BZ</span>
        </div>
        <div>
          <p id="profileName" class="text-base sm:text-lg font-semibold text-slate-50">
            No profile found
          </p>
          <p id="profileEmail" class="text-xs text-slate-400 mt-0.5">‚Äî</p>
          <div class="flex flex-wrap gap-2 mt-2">
            <span id="badgeId" class="badge badge-id">BZ----</span>
            <span id="badgeRole" class="badge badge-role">Role</span>
            <span id="badgePlan" class="badge badge-plan">Plan</span>
          </div>
        </div>
      </div>

      <div class="text-right text-xs sm:text-sm">
        <p class="text-slate-400">
          Rating:
          <span id="ratingValue" class="font-semibold text-amber-300">-</span>
          <span class="text-slate-500">/ 5</span>
        </p>
        <p class="text-slate-400">
          Total Reviews:
          <span id="ratingCount" class="font-semibold text-slate-100">0</span>
        </p>
        <p class="text-slate-400 mt-1">
          Joined:
          <span id="joinedAt">-</span>
        </p>
        <p class="text-slate-400">
          Last Login:
          <span id="lastLogin">-</span>
        </p>
      </div>
    </section>

    <p id="notFoundNote" class="mt-3 text-xs text-amber-300 hidden">
      Profile not found in Users sheet. Ho sakta hai signup ke time entry nahi bani ho.
    </p>

    <!-- BOTTOM 2-COLUMN -->
    <section class="mt-6 grid md:grid-cols-2 gap-5">
      <!-- LEFT: BASIC DETAILS -->
      <div class="card-bg rounded-2xl p-4 sm:p-5">
        <h2 class="text-sm font-semibold mb-3 text-slate-100">Basic Details</h2>
        <dl class="text-xs sm:text-sm space-y-2 text-slate-300">
          <div class="flex justify-between">
            <dt class="text-slate-400">Full Name</dt>
            <dd id="detailName" class="font-medium text-slate-50">‚Äî</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">Role / Account Type</dt>
            <dd id="detailRole" class="font-medium text-slate-50">‚Äî</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">Phone</dt>
            <dd id="detailPhone" class="font-medium text-slate-50">‚Äî</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">City</dt>
            <dd id="detailCity" class="font-medium text-slate-50">‚Äî</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">BizLink ID</dt>
            <dd id="detailBizId" class="font-medium text-slate-50">‚Äî</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">Plan</dt>
            <dd id="detailPlan" class="font-medium text-slate-50">‚Äî</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-400">Account Status</dt>
            <dd id="detailStatus" class="font-medium text-slate-50">‚Äî</dd>
          </div>
        </dl>
      </div>

      <!-- RIGHT: INFO -->
      <div class="card-bg rounded-2xl p-4 sm:p-5">
        <h2 class="text-sm font-semibold mb-3 text-slate-100">Profile Info</h2>
        <p class="text-xs sm:text-sm text-slate-300 leading-relaxed">
          Ye profile data <span class="font-semibold text-slate-100">BizLink_Users ‚Üí Users</span> Google Sheet se aa raha hai
          (signup ke time auto entry).
        </p>
        <p class="text-xs sm:text-sm text-slate-300 leading-relaxed mt-3">
          Future me yahin se aapka <span class="font-semibold text-sky-300">public profile link</span>,
          <span class="font-semibold text-amber-300"> rating badge</span> aur
          <span class="font-semibold text-purple-300"> activity summary</span> generate hoga.
        </p>
      </div>
    </section>

    <!-- ACTIVITY SUMMARY -->
    <section class="mt-6 card-bg rounded-2xl p-4 sm:p-5">
      <h2 class="text-sm font-semibold mb-2 text-slate-100">Activity Summary</h2>
      <p id="activityInfoText" class="text-xs sm:text-sm text-slate-300 mb-4">
        Abhi tak koi work Post a Work se create nahi hua, isliye sab zero hai. Baad me yahan se aapke works ka overview show karenge.
      </p>

      <div class="grid sm:grid-cols-3 gap-4 text-center">
        <div class="border border-slate-700 rounded-xl py-4">
          <p class="text-xs text-slate-400 mb-1">Works Posted</p>
          <p id="statWorksPosted" class="text-2xl font-bold text-slate-50">0</p>
        </div>
        <div class="border border-slate-700 rounded-xl py-4">
          <p class="text-xs text-slate-400 mb-1">In Progress</p>
          <p id="statInProgress" class="text-2xl font-bold text-slate-50">0</p>
        </div>
        <div class="border border-slate-700 rounded-xl py-4">
          <p class="text-xs text-slate-400 mb-1">Completed</p>
          <p id="statCompleted" class="text-2xl font-bold text-slate-50">0</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBtle51gX5kHufuWZ_YVOIQdDR05kbCE5I",
      authDomain: "bizlink-exchange.firebaseapp.com",
      projectId: "bizlink-exchange",
      storageBucket: "bizlink-exchange.firebasestorage.app",
      messagingSenderId: "116213651971",
      appId: "1:116213651971:web:fff60961af0c4da3448c36",
      measurementId: "G-VQ3JM82D1N"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
  </script>

  <!-- PROFILE + ACTIVITY LOGIC -->
  <script>
    // Users sheet script (BizLink_Users)
    const USERS_SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbztkBN5GcgZdPARgOSrvBvgJcfClCvXzIq0mEk64TpaShqQ4FzpFAjQ742Io70wyzNa/exec";

    // Main BizLink script (works, chats, etc. ‚Äì same as owner-dashboard)
    const MAIN_SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbxXHEcyQPzwQokTVw0lqAmYZrwu4UC9-5U_Dazwx0LzuP_uivnkTntB3WowL89OozaZ0w/exec";

    const statusEl      = document.getElementById("pageStatus");
    const notFoundNote  = document.getElementById("notFoundNote");
    const loggedTop     = document.getElementById("loggedInEmailTop");

    const avatarInitials= document.getElementById("avatarInitials");
    const profileNameEl = document.getElementById("profileName");
    const profileEmailEl= document.getElementById("profileEmail");
    const badgeIdEl     = document.getElementById("badgeId");
    const badgeRoleEl   = document.getElementById("badgeRole");
    const badgePlanEl   = document.getElementById("badgePlan");

    const ratingValueEl = document.getElementById("ratingValue");
    const ratingCountEl = document.getElementById("ratingCount");
    const joinedAtEl    = document.getElementById("joinedAt");
    const lastLoginEl   = document.getElementById("lastLogin");

    const dName   = document.getElementById("detailName");
    const dRole   = document.getElementById("detailRole");
    const dPhone  = document.getElementById("detailPhone");
    const dCity   = document.getElementById("detailCity");
    const dBizId  = document.getElementById("detailBizId");
    const dPlan   = document.getElementById("detailPlan");
    const dStatus = document.getElementById("detailStatus");

    // Activity DOM
    const activityInfoEl   = document.getElementById("activityInfoText");
    const statPostedEl     = document.getElementById("statWorksPosted");
    const statInProgressEl = document.getElementById("statInProgress");
    const statCompletedEl  = document.getElementById("statCompleted");

    function setStatus(msg, type="info") {
      statusEl.textContent = msg || "";
      if (!msg) {
        statusEl.className = "mb-3 text-xs text-slate-400";
      } else if (type === "error") {
        statusEl.className = "mb-3 text-xs text-red-300";
      } else {
        statusEl.className = "mb-3 text-xs text-slate-300";
      }
    }

    function safe(v, def="‚Äî") {
      if (v === null || v === undefined || v === "") return def;
      return String(v);
    }

    function initialsFromNameOrEmail(name, email) {
      if (name && name.trim()) {
        const parts = name.trim().split(/\s+/);
        if (parts.length === 1) return parts[0].substring(0,2).toUpperCase();
        return (parts[0][0] + parts[1][0]).toUpperCase();
      }
      if (email) return email[0].toUpperCase();
      return "BZ";
    }

    function normalizeStatus(s) {
      s = (s || "").toString().toLowerCase();
      if (!s || s === "pending") return "pending";
      if (s === "accepted" || s === "in progress") return "inprogress";
      if (s === "completed") return "completed";
      return "other";
    }

    function inferRoleType(roleStr) {
      const r = (roleStr || "").toLowerCase();
      if (r.includes("free")) return "freelancer";
      return "owner";
    }

    function renderActivitySummary(summary) {
      const posted = summary?.worksPosted || 0;
      const inProg = summary?.inProgress || 0;
      const comp   = summary?.completed || 0;

      statPostedEl.textContent     = posted;
      statInProgressEl.textContent = inProg;
      statCompletedEl.textContent  = comp;

      if (posted + inProg + comp === 0) {
        activityInfoEl.textContent =
          "Abhi tak koi work Post a Work se create nahi hua, isliye sab zero hai. Baad me yahan se aapke works ka overview show karenge.";
      } else {
        activityInfoEl.textContent =
          "Yeh numbers basic overview dete hain ki aapne BizLink par kitna kaam kiya hai.";
      }
    }

    async function loadActivitySummary(email, role) {
      if (!email) return;
      try {
        const res = await fetch(`${MAIN_SCRIPT_URL}?sheet=works`);
        const data = await res.json();
        if (!Array.isArray(data)) {
          console.log("Activity summary: invalid data", data);
          return;
        }

        const emailLower = email.toLowerCase();
        const roleType = inferRoleType(role);

        let myWorks;
        if (roleType === "freelancer") {
          myWorks = data.filter(w =>
            (w.AssignedTo || "").toString().toLowerCase() === emailLower
          );
        } else {
          // owner / business
          myWorks = data.filter(w =>
            (w.ClientEmail || "").toString().toLowerCase() === emailLower
          );
        }

        const worksPosted = myWorks.length;
        const inProgress  = myWorks.filter(w => normalizeStatus(w.Status) === "inprogress").length;
        const completed   = myWorks.filter(w => normalizeStatus(w.Status) === "completed").length;

        renderActivitySummary({ worksPosted, inProgress, completed });
      } catch (err) {
        console.error("Activity summary load error:", err);
      }
    }

    function renderProfile(p, authEmail) {
      notFoundNote.classList.add("hidden");

      const fullName = safe(p.FullName, "New BizLink User");
      const email    = authEmail || safe(p.Email, "‚Äî");
      const bizId    = safe(p.BizID, "BZ----");
      const role     = safe(p.Role, "‚Äî").toLowerCase();
      const phone    = safe(p.Phone);
      const city     = safe(p.City);
      const plan     = safe(p.Plan, "Free");
      const rating   = p.Rating && p.Rating !== "-" ? p.Rating : "-";
      const totalRev = p.TotalReviews || 0;
      const joined   = safe(p.JoinedAt, "-");
      const lastLog  = safe(p.LastLogin, "-");
      const status   = safe(p.Status, "active");

      avatarInitials.textContent = initialsFromNameOrEmail(fullName, email);
      profileNameEl.textContent  = fullName;
      profileEmailEl.textContent = email;

      badgeIdEl.textContent   = bizId;
      badgeRoleEl.textContent = role || "Role";
      badgePlanEl.textContent = plan || "Plan";

      ratingValueEl.textContent = rating;
      ratingCountEl.textContent = totalRev;
      joinedAtEl.textContent    = joined;
      lastLoginEl.textContent   = lastLog;

      dName.textContent   = fullName;
      dRole.textContent   = role;
      dPhone.textContent  = phone;
      dCity.textContent   = city;
      dBizId.textContent  = bizId;
      dPlan.textContent   = plan;
      dStatus.textContent = status;

      try {
        if (role) localStorage.setItem("bizlink_user_role", role);
        if (plan) localStorage.setItem("bizlinkPlan", plan);
      } catch (e) {}

      // üîπ Activity Summary (works counts)
      loadActivitySummary(email, role);
    }

    function renderNotFound(email, extraMsg) {
      profileNameEl.textContent  = "No profile found";
      profileEmailEl.textContent = email || "‚Äî";
      avatarInitials.textContent = initialsFromNameOrEmail("", email);
      badgeIdEl.textContent      = "BZ----";
      badgeRoleEl.textContent    = "Role";
      badgePlanEl.textContent    = "Plan";
      ratingValueEl.textContent  = "-";
      ratingCountEl.textContent  = "0";
      joinedAtEl.textContent     = "-";
      lastLoginEl.textContent    = "-";

      dName.textContent   = "‚Äî";
      dRole.textContent   = "‚Äî";
      dPhone.textContent  = "‚Äî";
      dCity.textContent   = "‚Äî";
      dBizId.textContent  = "‚Äî";
      dPlan.textContent   = "‚Äî";
      dStatus.textContent = "‚Äî";

      notFoundNote.classList.remove("hidden");
      if (extraMsg) setStatus(extraMsg, "error");

      // No profile => zero activity
      renderActivitySummary({ worksPosted: 0, inProgress: 0, completed: 0 });
    }

    async function loadUserProfile(email) {
      if (!email) {
        setStatus("Auth email missing.", "error");
        renderNotFound("");
        return;
      }

      setStatus("Loading profile‚Ä¶");

      try {
        const url = `${USERS_SCRIPT_URL}?action=getProfile&email=${encodeURIComponent(email)}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data && data.ok === false && data.error) {
          renderNotFound(email, "Sheet script error: " + data.error);
          return;
        }

        let profile = null;
        if (data && data.profile) {
          profile = data.profile;
        } else if (data && data.found && data.profile) {
          profile = data.profile;
        }

        if (!profile) {
          renderNotFound(email);
          setStatus("Profile not found in Users sheet.");
          return;
        }

        renderProfile(profile, email);
        setStatus("");

      } catch (err) {
        console.error("Profile load error:", err);
        renderNotFound(email, "Error loading profile: " + err.message);
      }
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut().then(() => {
        try {
          localStorage.removeItem("bizlink_user_role");
          localStorage.removeItem("bizlinkPlan");
          localStorage.removeItem("bizlink_user_email");
        } catch (e) {}
        window.location.href = "index.html";
      });
    });

    auth.onAuthStateChanged((user) => {
      if (!user) {
        alert("Please login first.");
        window.location.href = "login.html";
        return;
      }

      const email = (user.email || "").toLowerCase();
      loggedTop.textContent = `Logged in as: ${email}`;
      loggedTop.classList.remove("hidden");

      try {
        localStorage.setItem("bizlink_user_email", email);
      } catch (e) {}

      loadUserProfile(email);
    });
  </script>
</body>
</html>
