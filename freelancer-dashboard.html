<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Freelancer Dashboard | BizLink Exchange</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind & Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Poppins', sans-serif; background:#0b0d1e; color:#e5e7eb; }
    .card-bg { background:#1a1e3a; border:1px solid rgba(255,255,255,.12); }
    .button-gradient{background:linear-gradient(90deg,#a855f7 0%,#ec4899 100%)}
    .tab-button{color:#9ca3af;border-bottom:2px solid transparent}
    .tab-button.active{color:#a855f7;border-bottom-color:#a855f7;font-weight:600}
    .status-badge{font-size:.75rem;padding:.15rem .55rem;border-radius:999px}
  </style>
</head>
<body class="min-h-screen">

  <!-- Header -->
  <header class="sticky top-0 bg-[#020617] bg-opacity-95 z-40 border-b border-gray-800">
    <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
      <h1 class="text-xl md:text-2xl font-bold text-white">
        BizLink <span class="text-purple-400">Freelancer</span> Dashboard
      </h1>
      <div class="flex items-center gap-3">
        <span id="freelancerEmail" class="text-xs md:text-sm text-gray-300"></span>
        <button id="logoutBtn" class="px-3 py-1.5 rounded-md bg-red-600 text-xs md:text-sm text-white hover:bg-red-700">
          Logout
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">

    <!-- Tabs -->
    <div class="border-b border-gray-700 mb-6">
      <nav class="-mb-px flex space-x-6 overflow-x-auto" id="dashTabs">
        <button data-target="tabAvailable" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 text-sm active">
          Available Work
        </button>
        <button data-target="tabMyWork" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 text-sm">
          My Work
        </button>
        <button data-target="tabHistory" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 text-sm">
          History
        </button>
      </nav>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed top-4 right-4 bg-emerald-600 text-white text-sm px-4 py-2 rounded-md shadow-lg z-50">
      Updated successfully
    </div>

    <!-- Available Work -->
    <section id="tabAvailable" class="tab-pane">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg md:text-xl font-semibold text-white">Available Work</h2>
        <span class="text-xs text-gray-400">Pulled from: works sheet</span>
      </div>
      <div id="availableContainer" class="grid gap-4 md:grid-cols-2">
        <div class="col-span-full text-center text-gray-400 text-sm" id="availableLoading">
          Loading available work...
        </div>
      </div>
    </section>

    <!-- My Work -->
    <section id="tabMyWork" class="tab-pane hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg md:text-xl font-semibold text-white">My Active Work</h2>
        <span class="text-xs text-gray-400">Accepted but not completed</span>
      </div>
      <div id="myWorkContainer" class="grid gap-4 md:grid-cols-2">
        <div class="col-span-full text-center text-gray-400 text-sm" id="myWorkLoading">
          No accepted work yet.
        </div>
      </div>
    </section>

    <!-- History -->
    <section id="tabHistory" class="tab-pane hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg md:text-xl font-semibold text-white">History & Payments</h2>
        <span class="text-xs text-gray-400">Completed work from history sheet</span>
      </div>
      <div id="historyContainer" class="grid gap-4 md:grid-cols-2">
        <div class="col-span-full text-center text-gray-400 text-sm" id="historyLoading">
          Loading history...
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <script>
    // SAME config as index.html
    const firebaseConfig = {
      apiKey: "AIzaSyBtle51gX5kHufuWZ_YVOIQdDR05kbCE5I",
      authDomain: "bizlink-exchange.firebaseapp.com",
      projectId: "bizlink-exchange",
      storageBucket: "bizlink-exchange.firebasestorage.app",
      messagingSenderId: "116213651971",
      appId: "1:116213651971:web:fff60961af0c4da3448c36",
      measurementId: "G-VQ3JM82D1N"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
  </script>

  <!-- Dashboard Logic -->
  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxVAjCB6WjXW6j3a8mWKi4ECUui_KTz3YoFkPgNVYuI9Om8ar1rhNNBi3BdZqjJMjYwwg/exec";

    let currentUser = null;
    let availableWorks = [];
    let myWorks = [];
    let historyWorks = [];

    const freelancerEmailSpan = document.getElementById('freelancerEmail');
    const logoutBtn = document.getElementById('logoutBtn');

    const availableContainer = document.getElementById('availableContainer');
    const availableLoading = document.getElementById('availableLoading');

    const myWorkContainer = document.getElementById('myWorkContainer');
    const myWorkLoading = document.getElementById('myWorkLoading');

    const historyContainer = document.getElementById('historyContainer');
    const historyLoading = document.getElementById('historyLoading');

    const toast = document.getElementById('toast');

    function showToast(message = "Updated successfully") {
      toast.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 2500);
    }

    // ðŸ” Auth check
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      freelancerEmailSpan.textContent = user.email || "";

      loadAvailableWorks();
      loadMyWorks();
      loadHistory();
    });

    logoutBtn.addEventListener('click', () => {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      }).catch(err => console.error("Logout error:", err));
    });

    // ðŸ“Œ Tabs
    const dashTabs = document.getElementById('dashTabs');
    const tabPanes = document.querySelectorAll('.tab-pane');

    dashTabs.addEventListener('click', (e) => {
      if (e.target.tagName !== 'BUTTON') return;
      const targetId = e.target.getAttribute('data-target');

      dashTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
      e.target.classList.add('active');

      tabPanes.forEach(pane => {
        pane.classList.toggle('hidden', pane.id !== targetId);
      });
    });

    // ðŸŸ£ 1. Load Available Work (sheet: works)
    async function loadAvailableWorks() {
      try {
        const res = await fetch(`${scriptURL}?sheet=works`);
        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch (err) {
          console.error("Available works JSON parse error:", text);
          availableLoading.textContent = "Error: Works data format issue.";
          return;
        }

        if (!Array.isArray(data) || !data.length) {
          availableLoading.textContent = "No work available right now.";
          return;
        }

        availableWorks = data;
        renderAvailable();
      } catch (err) {
        console.error("Error loading works:", err);
        availableLoading.textContent = "Error loading works.";
      }
    }

    function renderAvailable() {
      availableContainer.innerHTML = "";
      if (!availableWorks.length) {
        availableContainer.innerHTML = `<div class="col-span-full text-center text-gray-400 text-sm">No work available.</div>`;
        return;
      }

      availableWorks.forEach((work, index) => {
        const card = document.createElement('div');
        card.className = "card-bg rounded-xl p-4 flex flex-col justify-between";

        const title = work.Title || "No Title";
        const desc = work.Description || "No description";
        const budget = work.Budget || "N/A";
        const cat = work.Category || "General";
        const city = work.City || "-";
        const posted = work.PostedOn ? new Date(work.PostedOn).toLocaleString() : "";

        card.innerHTML = `
          <div>
            <div class="flex justify-between items-start mb-1">
              <h3 class="text-white font-semibold text-base">${title}</h3>
              <span class="status-badge bg-sky-700 text-white">${cat}</span>
            </div>
            <p class="text-xs text-gray-400 mb-2">City: ${city}</p>
            <p class="text-sm text-gray-300 mb-3 line-clamp-3">${desc}</p>
            <p class="text-sm text-gray-200 mb-1">Budget: <span class="text-emerald-400 font-semibold">â‚¹${budget}</span></p>
            <p class="text-xs text-gray-500">Posted: ${posted}</p>
          </div>
          <div class="mt-3 flex justify-end">
            <button class="button-gradient px-4 py-1.5 rounded-md text-sm font-semibold"
                    data-index="${index}">
              Accept Work
            </button>
          </div>
        `;
        const btn = card.querySelector('button');
        btn.addEventListener('click', () => acceptWork(index));
        availableContainer.appendChild(card);
      });
    }

    // âœ… Accept Work â†’ POST to Apps Script (sheet: freelancer_accept)
    async function acceptWork(idx) {
      if (!currentUser) return;
      const work = availableWorks[idx];
      if (!work) return;

      const fd = new FormData();
      fd.append('sheet', 'freelancer_accept');       // ðŸ‘ˆ Apps Script me ye sheet handle karo
      fd.append('title', work.Title || '');
      fd.append('description', work.Description || '');
      fd.append('budget', work.Budget || '');
      fd.append('category', work.Category || '');
      fd.append('city', work.City || '');
      fd.append('postedOn', work.PostedOn || '');
      fd.append('freelancerUid', currentUser.uid);
      fd.append('freelancerEmail', currentUser.email || '');
      fd.append('status', 'Accepted');
      fd.append('acceptedAt', new Date().toISOString());

      try {
        const res = await fetch(scriptURL, { method: 'POST', body: fd });
        if (!res.ok) {
          console.error("Accept work HTTP error:", res.status, res.statusText);
          showToast("Server error while accepting.");
          return;
        }
        // Frontend side: move work into My Work
        myWorks.push({
          ...work,
          Status: 'Accepted',
          FreelancerEmail: currentUser.email || ''
        });
        renderMyWorks();
        showToast("Work accepted.");
      } catch (err) {
        console.error("Accept work error:", err);
        showToast("Network error while accepting.");
      }
    }

    // ðŸŸ£ 2. Load My Works (sheet: freelancer_accept)
    async function loadMyWorks() {
      try {
        const res = await fetch(`${scriptURL}?sheet=freelancer_accept`);
        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch (err) {
          console.error("My works JSON parse error:", text);
          myWorkLoading.textContent = "Error: My work data format.";
          return;
        }

        if (!Array.isArray(data)) {
          myWorkLoading.textContent = "No active work.";
          return;
        }

        // Filter only for current freelancer
        myWorks = data.filter(row =>
          row.FreelancerEmail === (currentUser?.email || row.freelancerEmail)
        );

        renderMyWorks();
      } catch (err) {
        console.error("Error loading my works:", err);
        myWorkLoading.textContent = "Error loading my work.";
      }
    }

    function renderMyWorks() {
      myWorkContainer.innerHTML = "";
      if (!myWorks.length) {
        myWorkContainer.innerHTML = `<div class="col-span-full text-center text-gray-400 text-sm">No active work. Accept a project from Available Work tab.</div>`;
        return;
      }

      myWorks.forEach((work, index) => {
        const status = work.Status || 'Accepted';
        const statusColor =
          status === 'Submitted' ? 'bg-yellow-600' :
          status === 'Completed' ? 'bg-emerald-600' :
          'bg-blue-600';

        const card = document.createElement('div');
        card.className = "card-bg rounded-xl p-4 flex flex-col gap-3";

        card.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <h3 class="text-white font-semibold text-base">${work.Title || 'No Title'}</h3>
              <p class="text-xs text-gray-400 mt-1">${work.Category || 'General'} â€¢ â‚¹${work.Budget || 'N/A'}</p>
            </div>
            <span class="status-badge ${statusColor} text-white">${status}</span>
          </div>
          <p class="text-sm text-gray-300">${work.Description || ''}</p>
          <p class="text-xs text-gray-400">City: ${work.City || '-'}</p>

          <div class="mt-2 border-t border-gray-700 pt-3">
            <label class="block text-xs text-gray-300 mb-1">Delivery link (Drive, Figma, Zip etc.)</label>
            <input type="text" class="w-full text-sm px-3 py-2 rounded-md bg-gray-900 border border-gray-700 text-gray-100"
                   placeholder="https://..." id="deliveryLink_${index}">
            <label class="block text-xs text-gray-300 mt-2 mb-1">Note / Update</label>
            <textarea rows="2" class="w-full text-sm px-3 py-2 rounded-md bg-gray-900 border border-gray-700 text-gray-100"
                      placeholder="Short update for client" id="deliveryNote_${index}"></textarea>

            <div class="mt-3 flex justify-end gap-2">
              <button class="px-3 py-1.5 rounded-md text-xs bg-gray-700 text-gray-100 hover:bg-gray-600"
                      data-index="${index}" data-type="chat">
                Chat (coming soon)
              </button>
              <button class="button-gradient px-4 py-1.5 rounded-md text-xs font-semibold"
                      data-index="${index}" data-type="submit">
                Submit Work
              </button>
            </div>
          </div>
        `;

        const submitBtn = card.querySelector('button[data-type="submit"]');
        submitBtn.addEventListener('click', () => submitWork(index));

        myWorkContainer.appendChild(card);
      });
    }

    // âœ… Submit Work â†’ POST to Apps Script (sheet: freelancer_submit)
    async function submitWork(idx) {
      if (!currentUser) return;
      const work = myWorks[idx];
      if (!work) return;

      const linkInput = document.getElementById(`deliveryLink_${idx}`);
      const noteInput = document.getElementById(`deliveryNote_${idx}`);

      const deliveryLink = (linkInput?.value || "").trim();
      const deliveryNote = (noteInput?.value || "").trim();

      if (!deliveryLink) {
        alert("Please add a delivery link first.");
        return;
      }

      const fd = new FormData();
      fd.append('sheet', 'freelancer_submit');     // ðŸ‘ˆ Apps Script me ye handle karo
      fd.append('title', work.Title || '');
      fd.append('postedOn', work.PostedOn || '');
      fd.append('freelancerUid', currentUser.uid);
      fd.append('freelancerEmail', currentUser.email || '');
      fd.append('deliveryLink', deliveryLink);
      fd.append('deliveryNote', deliveryNote);
      fd.append('status', 'Submitted');
      fd.append('submittedAt', new Date().toISOString());

      try {
        const res = await fetch(scriptURL, { method: 'POST', body: fd });
        if (!res.ok) {
          console.error("Submit work HTTP error:", res.status, res.statusText);
          showToast("Server error while submitting.");
          return;
        }
        // Frontend: update status locally
        myWorks[idx].Status = 'Submitted';
        renderMyWorks();
        showToast("Work submitted.");
      } catch (err) {
        console.error("Submit work error:", err);
        showToast("Network error while submitting.");
      }
    }

    // ðŸŸ£ 3. History (sheet: freelancer_history)
    async function loadHistory() {
      try {
        const res = await fetch(`${scriptURL}?sheet=freelancer_history`);
        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch (err) {
          console.error("History JSON parse error:", text);
          historyLoading.textContent = "Error: history data format.";
          return;
        }

        if (!Array.isArray(data)) {
          historyLoading.textContent = "No history yet.";
          return;
        }

        historyWorks = data.filter(row =>
          row.FreelancerEmail === (currentUser?.email || row.freelancerEmail)
        );
        renderHistory();
      } catch (err) {
        console.error("Error loading history:", err);
        historyLoading.textContent = "Error loading history.";
      }
    }

    function renderHistory() {
      historyContainer.innerHTML = "";
      if (!historyWorks.length) {
        historyContainer.innerHTML = `<div class="col-span-full text-center text-gray-400 text-sm">No completed work yet.</div>`;
        return;
      }

      historyWorks.forEach(work => {
        const payStatus = work.PaymentStatus || 'Pending';
        const payColor =
          payStatus === 'Paid' ? 'bg-emerald-600' :
          payStatus === 'Partially Paid' ? 'bg-yellow-600' :
          'bg-gray-600';

        const card = document.createElement('div');
        card.className = "card-bg rounded-xl p-4 flex flex-col gap-2";

        card.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <h3 class="text-white font-semibold text-base">${work.Title || 'No Title'}</h3>
              <p class="text-xs text-gray-400 mt-1">${work.Category || 'General'} â€¢ â‚¹${work.Budget || 'N/A'}</p>
            </div>
            <span class="status-badge ${payColor} text-white">${payStatus}</span>
          </div>
          <p class="text-sm text-gray-300">${work.Description || ''}</p>
          <p class="text-xs text-gray-400">Completed on: ${work.CompletedAt ? new Date(work.CompletedAt).toLocaleString() : '-'}</p>
          <p class="text-xs text-gray-500">Txn / Ref: ${work.PaymentRef || '-'}</p>
        `;

        historyContainer.appendChild(card);
      });
    }
  </script>

</body>
</html>
