<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>BizLink | Freelancer Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
body{font-family:'Poppins',sans-serif;background:#050816;color:#e5e7eb}
.card-bg{background:#0f172a;border:1px solid rgba(148,163,184,.35)}
.button-gradient{background:linear-gradient(90deg,#a855f7 0%,#ec4899 100%)}
.badge{font-size:.65rem;padding:.15rem .55rem;border-radius:999px}
.badge-locked{background:#a855f7;color:white}
.badge-paid{background:#22c55e;color:#022c22}
.badge-unlocked{background:#facc15;color:#1f2937}
</style>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
</head>

<body>

<!-- HEADER -->
<header class="border-b border-slate-800 bg-slate-950 sticky top-0 z-40">
  <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between">
    <h2 class="text-xl font-bold">BizLink <span class="text-purple-400">Freelancer</span></h2>
    <div class="text-sm">
      <span id="freelancerEmailLabel"></span>
      <button id="logoutBtn" class="ml-3 bg-red-600 px-3 py-1 rounded">Logout</button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto p-4 grid lg:grid-cols-2 gap-6">

<!-- WORK LIST -->
<div class="card-bg p-4 rounded-xl">
  <h3 class="font-semibold mb-3">Your Works</h3>
  <div id="workList">Loading...</div>
</div>

<!-- CHAT -->
<div class="card-bg p-4 rounded-xl">
  <h3 id="chatTitle" class="font-semibold">Select a work</h3>
  <div id="chatMessages" class="h-80 overflow-y-auto my-3 text-xs"></div>

  <form id="chatForm" class="flex gap-2">
    <input id="chatInput" class="flex-1 px-2 py-1 bg-slate-900 border border-slate-700 rounded" />
    <button class="button-gradient px-3 py-1 rounded">Send</button>
  </form>
</div>

</main>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyDw-YRQzfEBiZUzlOFf02Z-42QLu7HkiTvZ7_ge_Ae4_kMjK0ovQ8ZuTRooIoMjCx36g/exec";

const firebaseConfig = {
  apiKey: "AIzaSyBtle51gX5kHufuWZ_YVOIQdDR05kbCE5I",
  authDomain: "bizlink-exchange.firebaseapp.com",
  projectId: "bizlink-exchange"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

let freelancerEmail = "";
let works = [];
let currentWorkId = null;

/* ---------- Helpers ---------- */
function paymentBadge(w) {
  if (w.PaymentStatus === "Paid") {
    return `<span class="badge badge-paid">âœ… Paid â‚¹${w.LockedAmount}</span>`;
  }
  if (w.PaymentStatus === "Locked") {
    return `<span class="badge badge-locked">ðŸ”’ Locked â‚¹${w.LockedAmount}</span>`;
  }
  return `<span class="badge badge-unlocked">Not Locked</span>`;
}

/* ---------- Render ---------- */
function renderWorks() {
  const el = document.getElementById("workList");
  if (!works.length) {
    el.innerHTML = "No works found";
    return;
  }

  el.innerHTML = works.map(w => {
    const canRequest =
      w.Status === "Completed" && w.PaymentStatus !== "Paid";

    return `
    <div class="card-bg p-3 mb-3 rounded">
      <h4 class="font-semibold">${w.Title}</h4>
      <p class="text-xs text-slate-400">${w.WorkID}</p>

      <div class="mt-2">${paymentBadge(w)}</div>

      <div class="mt-3 flex gap-2 flex-wrap">
        <button onclick="openChat('${w.WorkID}')" class="px-2 py-1 border rounded">Chat</button>

        ${canRequest ? `
        <button onclick="requestPayment('${w.WorkID}')" 
          class="px-2 py-1 bg-yellow-500 text-black rounded text-xs">
          Request Payment
        </button>` : ""}
      </div>
    </div>
    `;
  }).join("");
}

/* ---------- API ---------- */
async function postAPI(obj){
  const f=new URLSearchParams();
  Object.keys(obj).forEach(k=>f.append(k,obj[k]));
  const r=await fetch(API_URL,{method:"POST",body:f});
  return r.json();
}

async function requestPayment(workId){
  if(!confirm("Request payment from owner?")) return;

  const res = await postAPI({
    action:"requestPayment",
    WorkID:workId,
    freelancerEmail
  });

  alert(res.ok ? "âœ… Payment request sent" : res.error);
}

/* ---------- Chat ---------- */
function openChat(workId){
  currentWorkId = workId;
  document.getElementById("chatTitle").innerText = "Chat: " + workId;
}

document.getElementById("chatForm").addEventListener("submit",async e=>{
  e.preventDefault();
  if(!currentWorkId) return alert("Select work");
  const msg = chatInput.value.trim();
  if(!msg) return;

  await postAPI({
    action:"sendMessage",
    WorkID:currentWorkId,
    FromRole:"Freelancer",
    FromEmail:freelancerEmail,
    Message:msg
  });

  chatInput.value="";
});

/* ---------- AUTH ---------- */
auth.onAuthStateChanged(async user=>{
  if(!user) return location.href="login.html";
  freelancerEmail = user.email;
  freelancerEmailLabel.innerText = freelancerEmail;

  const res = await fetch(`${API_URL}?action=listWorksForFreelancer&freelancerEmail=${freelancerEmail}`);
  const data = await res.json();
  works = data.works || [];
  renderWorks();
});

logoutBtn.onclick=()=>auth.signOut().then(()=>location.href="login.html");
</script>
</body>
</html>
