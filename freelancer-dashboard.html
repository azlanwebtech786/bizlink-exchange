<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Freelancer Dashboard | BizLink Exchange</title>

  <!-- Tailwind & Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Poppins',sans-serif;background:#050816;color:#e5e7eb}
    .card-bg{background:#0f172a;border:1px solid rgba(148,163,184,.4)}
    .pill{background:rgba(148,163,184,.15);border-radius:999px}
    .button-gradient{background:linear-gradient(90deg,#a855f7 0%,#ec4899 100%)}
    .tab-button{color:#9ca3af;border-bottom:2px solid transparent}
    .tab-button.active{color:#a855f7;border-bottom-color:#a855f7;font-weight:600}
    .status-pill{font-size:.7rem;padding:.18rem .55rem;border-radius:999px}
    .status-pending{background:rgba(234,179,8,.12);color:#facc15}
    .status-accepted{background:rgba(34,197,94,.12);color:#4ade80}
    .status-completed{background:rgba(59,130,246,.12);color:#60a5fa}
    .msg-bubble{max-width:85%;padding:.55rem .75rem;border-radius:.9rem;font-size:.85rem}
    .msg-freelancer{background:#4c1d95;border-bottom-right-radius:0}
    .msg-owner{background:#111827;border:1px solid rgba(75,85,99,.8);border-bottom-left-radius:0}
    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
  </style>
</head>
<body class="min-h-screen">

  <!-- HEADER -->
  <header class="border-b border-slate-800 bg-slate-950/90 backdrop-blur sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-14">
      <div class="flex items-center gap-2">
        <a href="index.html" class="text-xs text-slate-400 hover:text-slate-200 flex items-center gap-1">
          ‚Üê Back to Home
        </a>
        <h1 class="text-lg sm:text-xl font-semibold text-white">
          Freelancer <span class="text-purple-400">Dashboard</span>
        </h1>
      </div>
      <div class="flex items-center gap-3 text-xs sm:text-sm">
        <div class="hidden sm:flex items-center gap-2 pill px-3 py-1">
          <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
          <span>Logged in as <span id="userEmailLabel" class="font-medium text-slate-100">Freelancer</span></span>
        </div>
        <select id="roleSelect" class="bg-slate-900 border border-slate-700 text-xs px-2 py-1 rounded text-slate-200">
          <option value="Freelancer">View as: Freelancer</option>
          <option value="Owner">View as: Owner (Demo)</option>
        </select>
      </div>
    </div>
  </header>

  <!-- MAIN LAYOUT -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 grid lg:grid-cols-[minmax(0,2fr)_minmax(0,1.4fr)] gap-6">
    <!-- LEFT: WORK LIST -->
    <section aria-label="Works">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-xl font-semibold text-white">Your Works</h2>
          <p class="text-xs text-slate-400">Pending, accepted, completed ‚Äì sab ek jagah.</p>
        </div>
        <div class="hidden sm:flex gap-2 text-[11px]">
          <span class="status-pill status-pending">Pending</span>
          <span class="status-pill status-accepted">Accepted</span>
          <span class="status-pill status-completed">Completed</span>
        </div>
      </div>

      <!-- TABS -->
      <nav class="border-b border-slate-800 mb-3 flex gap-4 text-sm" id="workTabs">
        <button data-status="Pending" class="tab-button active py-2">Pending</button>
        <button data-status="Accepted" class="tab-button py-2">Accepted</button>
        <button data-status="Completed" class="tab-button py-2">History</button>
      </nav>

      <!-- WORK LIST -->
      <div id="workList" class="space-y-3 max-h-[70vh] overflow-y-auto no-scrollbar pr-1">
        <!-- JS will render cards here -->
        <div class="text-center text-slate-400 text-sm py-8">Loading works...</div>
      </div>
    </section>

    <!-- RIGHT: CHAT PANEL -->
    <section aria-label="Chat" class="card-bg rounded-2xl p-4 sm:p-5 flex flex-col min-h-[320px] max-h-[80vh]">
      <!-- When no work selected -->
      <div id="chatEmptyState" class="flex-1 flex flex-col items-center justify-center text-center text-slate-400 text-sm">
        <div class="w-12 h-12 rounded-full bg-slate-900 flex items-center justify-center mb-3">
          üí¨
        </div>
        <p class="font-medium text-slate-200 mb-1">Select a work to start chatting</p>
        <p class="text-xs text-slate-500 max-w-xs">
          ‚ÄúOpen Chat‚Äù pe click karo kisi bhi work card par. Yahi se files bhejo, doubt clear karo, status track karo.
        </p>
      </div>

      <!-- Active chat -->
      <div id="chatPanel" class="hidden h-full flex flex-col">
        <!-- Header -->
        <div class="flex items-center justify-between border-b border-slate-800 pb-2 mb-3">
          <div>
            <p class="text-[11px] text-slate-400 uppercase tracking-widest">Chat for</p>
            <h3 id="chatWorkTitle" class="text-sm sm:text-base font-semibold text-white truncate max-w-[220px] sm:max-w-[280px]">
              -
            </h3>
            <p id="chatWorkMeta" class="text-[11px] text-slate-400 mt-0.5"></p>
          </div>
          <button id="closeChatButton" class="text-xs text-slate-400 hover:text-slate-100 px-2 py-1 rounded pill bg-slate-900">
            Close
          </button>
        </div>

        <!-- Messages -->
        <div id="chatMessages"
             class="flex-1 overflow-y-auto no-scrollbar space-y-2 pr-1 text-xs sm:text-[13px]">
          <!-- JS will push bubbles here -->
        </div>

        <!-- Composer -->
        <form id="chatForm" class="mt-3 border-t border-slate-800 pt-3 flex items-end gap-2">
          <textarea id="chatInput"
                    rows="1"
                    placeholder="Type your message‚Ä¶"
                    class="flex-1 text-xs sm:text-sm resize-none rounded-lg bg-slate-900 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-purple-500 px-3 py-2 text-slate-100"></textarea>
          <button type="submit"
                  class="button-gradient px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium text-white hover:opacity-90">
            Send
          </button>
        </form>

        <p class="text-[11px] text-slate-500 mt-2">
          Role: <span id="chatRoleLabel" class="font-medium text-purple-300">Freelancer</span>  
          <span class="text-slate-600">| Messages abhi local demo hai. Baad me Apps Script + Sheet se real-time sync hoga.</span>
        </p>
      </div>
    </section>
  </main>

  <!-- Simple Toast -->
  <div id="toast"
       class="fixed bottom-4 right-4 bg-slate-900 border border-slate-700 text-xs text-slate-100 px-4 py-2 rounded-lg shadow-lg hidden">
  </div>

  <!-- DATA + LOGIC -->
  <script>
    // ‚úÖ SAME Apps Script URL jo index.html me use kar rahe ho
    const scriptURL =
      "https://script.google.com/macros/s/AKfycbxVAjCB6WjXW6j3a8mWKi4ECUui_KTz3YoFkPgNVYuI9Om8ar1rhNNBi3BdZqjJMjYwwg/exec";

    // In-memory list of works (fetched from Sheet)
    let allWorks = [];  // {id,title,budget,city,category,status}
    let activeStatusFilter = "Pending";
    let activeWorkId = null;
    let currentRole = "Freelancer"; // OR "Owner"

    const workListEl = document.getElementById("workList");
    const workTabsEl = document.getElementById("workTabs");

    const chatEmptyStateEl = document.getElementById("chatEmptyState");
    const chatPanelEl = document.getElementById("chatPanel");
    const chatWorkTitleEl = document.getElementById("chatWorkTitle");
    const chatWorkMetaEl = document.getElementById("chatWorkMeta");
    const chatMessagesEl = document.getElementById("chatMessages");
    const chatFormEl = document.getElementById("chatForm");
    const chatInputEl = document.getElementById("chatInput");
    const chatRoleLabelEl = document.getElementById("chatRoleLabel");
    const closeChatButton = document.getElementById("closeChatButton");
    const roleSelect = document.getElementById("roleSelect");
    const toastEl = document.getElementById("toast");

    // üîπ TOAST helper
    function showToast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.remove("hidden");
      setTimeout(() => toastEl.classList.add("hidden"), 2500);
    }

    // üîπ Fetch works for this freelancer
    async function loadFreelancerWorks() {
      workListEl.innerHTML =
        "<div class='text-center text-slate-400 text-sm py-8'>Loading works...</div>";

      try {
        // NOTE: Agar tumne alag sheet banayi hai (e.g. FreelancerWorks) to yaha `sheet` ka naam change kar dena
        const res = await fetch(`${scriptURL}?sheet=freelancer_works`);
        const raw = await res.text();
        let data;
        try {
          data = JSON.parse(raw);
        } catch (err) {
          console.error("Works JSON parse error:", raw);
          workListEl.innerHTML =
            "<div class='text-center text-red-400 text-sm py-6'>Works data format error. Please check Apps Script JSON.</div>";
          return;
        }

        if (!Array.isArray(data) || !data.length) {
          allWorks = [];
          workListEl.innerHTML =
            "<div class='text-center text-slate-400 text-sm py-6'>No works assigned yet.</div>";
          return;
        }

        // Normalize rows -> objects
        allWorks = data.map((row, index) => ({
          id: row.WorkId || row.ID || `W${index + 1}`,
          title: row.Title || "Untitled Work",
          budget: row.Budget || "N/A",
          city: row.City || "",
          category: row.Category || "",
          status: row.Status || "Pending",  // Pending / Accepted / Completed
          clientName: row.ClientName || row.Owner || "",
        }));

        renderWorkList();
      } catch (e) {
        console.error("Error fetching freelancer works:", e);
        workListEl.innerHTML =
          "<div class='text-center text-red-400 text-sm py-6'>Error loading works. Please check Apps Script or network.</div>";
      }
    }

    // üîπ Render work cards according to activeStatusFilter
    function renderWorkList() {
      const filtered = allWorks.filter(w => (w.status || "Pending") === activeStatusFilter);

      if (!filtered.length) {
        workListEl.innerHTML =
          "<div class='text-center text-slate-400 text-sm py-6'>No " +
          activeStatusFilter.toLowerCase() +
          " works.</div>";
        return;
      }

      workListEl.innerHTML = "";
      filtered.forEach(work => {
        const card = document.createElement("div");
        card.className =
          "card-bg rounded-xl p-4 sm:p-5 flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-4 shadow-sm";

        const statusClass =
          work.status === "Accepted"
            ? "status-accepted"
            : work.status === "Completed"
            ? "status-completed"
            : "status-pending";

        card.innerHTML = `
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-1">
              <h3 class="font-semibold text-sm sm:text-base text-white truncate">${work.title}</h3>
              <span class="status-pill ${statusClass}">${work.status}</span>
            </div>
            <p class="text-[11px] text-slate-400 mb-1">
              ${work.category || "General"} ‚Ä¢ ${work.city || "Unknown"}
            </p>
            <p class="text-xs text-slate-300">
              Budget: <span class="text-emerald-400 font-semibold">‚Çπ${work.budget}</span>
            </p>
            ${work.clientName ? `<p class="text-[11px] text-slate-500 mt-1">Client: ${work.clientName}</p>` : ""}
          </div>
          <div class="flex flex-row sm:flex-col gap-2 justify-end sm:items-end">
            ${
              work.status === "Pending"
                ? `<button class="text-xs px-3 py-1.5 rounded-lg bg-amber-500/90 hover:bg-amber-500 text-black font-medium"
                           data-action="accept" data-id="${work.id}">
                     Accept
                   </button>`
                : ""
            }
            ${
              work.status === "Accepted"
                ? `<button class="text-xs px-3 py-1.5 rounded-lg bg-emerald-500/90 hover:bg-emerald-500 text-black font-medium"
                           data-action="submit" data-id="${work.id}">
                     Submit Work
                   </button>`
                : ""
            }
            <button class="text-xs px-3 py-1.5 rounded-lg border border-slate-600 hover:border-purple-500 text-slate-100"
                    data-action="chat" data-id="${work.id}">
              Open Chat
            </button>
          </div>
        `;

        workListEl.appendChild(card);
      });
    }

    // üîπ Handle tab switching (Pending / Accepted / Completed)
    workTabsEl.addEventListener("click", (e) => {
      if (e.target.tagName !== "BUTTON") return;
      const status = e.target.getAttribute("data-status");
      if (!status) return;

      activeStatusFilter = status;
      workTabsEl.querySelectorAll("button").forEach(btn => btn.classList.remove("active"));
      e.target.classList.add("active");
      renderWorkList();
    });

    // üîπ Handle work card actions
    workListEl.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");

      if (action === "accept") {
        handleAcceptWork(id);
      } else if (action === "submit") {
        handleSubmitWork(id);
      } else if (action === "chat") {
        openChatForWork(id);
      }
    });

    // üîπ Accept work (front-end only demo)
    function handleAcceptWork(id) {
      const work = allWorks.find(w => w.id === id);
      if (!work) return;
      work.status = "Accepted";
      showToast("Work accepted (front-end only). Backend update TODO.");
      renderWorkList();

      // TODO: Apps Script backend:
      // fetch(scriptURL, { method:'POST', body: JSON form / FormData with action='acceptWork', workId:id })
    }

    // üîπ Submit work (front-end only demo)
    function handleSubmitWork(id) {
      const url = prompt("Paste delivery link (Google Drive, Figma, Zip, etc.):");
      if (!url) return;
      showToast("Work submitted (demo). Backend integration pending.");
      const work = allWorks.find(w => w.id === id);
      if (work) work.status = "Completed";
      renderWorkList();

      // TODO: Apps Script backend for saving delivery URL + status = Completed
    }

    // ---------- CHAT LOGIC (local demo storage) ----------

    function openChatForWork(id) {
      const work = allWorks.find(w => w.id === id);
      if (!work) return;

      activeWorkId = id;

      chatWorkTitleEl.textContent = work.title;
      chatWorkMetaEl.textContent =
        `${work.city || "Unknown"} ‚Ä¢ Budget: ‚Çπ${work.budget} ‚Ä¢ Status: ${work.status}`;

      chatEmptyStateEl.classList.add("hidden");
      chatPanelEl.classList.remove("hidden");

      loadChatMessagesForWork(id);
    }

    closeChatButton.addEventListener("click", () => {
      activeWorkId = null;
      chatPanelEl.classList.add("hidden");
      chatEmptyStateEl.classList.remove("hidden");
    });

    // üîπ LocalStorage key for each work chat
    function chatStorageKey(id) {
      return `bizlink_chat_${id}`;
    }

    function loadChatMessagesForWork(id) {
      const key = chatStorageKey(id);
      let msgs = [];
      try {
        const raw = localStorage.getItem(key);
        msgs = raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error("Chat parse error:", e);
      }
      renderChatMessages(msgs);
    }

    function renderChatMessages(messages) {
      chatMessagesEl.innerHTML = "";
      if (!messages.length) {
        chatMessagesEl.innerHTML =
          "<p class='text-center text-slate-500 text-xs mt-4'>No messages yet. Start the conversation.</p>";
        return;
      }

      messages.forEach(msg => {
        const row = document.createElement("div");
        row.className = "flex " +
          (msg.sender === "Freelancer" ? "justify-end" : "justify-start");

        const bubble = document.createElement("div");
        bubble.className =
          "msg-bubble " +
          (msg.sender === "Freelancer" ? "msg-freelancer text-slate-50" : "msg-owner text-slate-100");

        const time = new Date(msg.timestamp || Date.now());
        bubble.innerHTML = `
          <div class="flex items-center justify-between gap-2 mb-0.5">
            <span class="text-[10px] uppercase tracking-wide text-slate-300">
              ${msg.sender === "Freelancer" ? "You (Freelancer)" : "Owner"}
            </span>
            <span class="text-[9px] text-slate-400">
              ${time.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}
            </span>
          </div>
          <div class="text-[11px] leading-snug">${msg.text}</div>
        `;

        row.appendChild(bubble);
        chatMessagesEl.appendChild(row);
      });

      // Scroll bottom
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    // üîπ Send chat message (local demo)
    chatFormEl.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!activeWorkId) {
        showToast("Select a work first.");
        return;
      }
      const text = chatInputEl.value.trim();
      if (!text) return;

      const key = chatStorageKey(activeWorkId);
      let msgs = [];
      try {
        const raw = localStorage.getItem(key);
        msgs = raw ? JSON.parse(raw) : [];
      } catch (e2) {}

      const message = {
        text,
        sender: currentRole, // "Freelancer" OR "Owner"
        timestamp: new Date().toISOString(),
      };
      msgs.push(message);
      localStorage.setItem(key, JSON.stringify(msgs));
      chatInputEl.value = "";
      renderChatMessages(msgs);

      // TODO: Backend me send karna:
      // fetch(scriptURL, { method:'POST', body: formData with action='sendChat', workId, text, senderRole })
    });

    // üîπ Role switch (Freelancer / Owner demo)
    roleSelect.addEventListener("change", () => {
      currentRole = roleSelect.value;
      chatRoleLabelEl.textContent = currentRole;
      showToast(`Now talking as ${currentRole} (demo mode).`);
    });

    // ---------- INIT ----------
    loadFreelancerWorks();
  </script>

  <!-- (Optional) Firebase Auth ‚Äì agar future me dashboard ko protect karna ho -->
  <!--
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script>
    // same config as index.html
  </script>
  -->
</body>
</html>
