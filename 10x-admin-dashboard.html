<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BizLink 10X – Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{font-family:Poppins;background:#050816;color:#e5e7eb}
.card{background:#0f172a;border:1px solid rgba(148,163,184,.2)}
.modal-bg{background:rgba(2,6,23,.9)}
.modal{background:#020617}
</style>
</head>

<body class="min-h-screen">

<!-- HEADER -->
<header class="sticky top-0 bg-slate-950 border-b border-slate-800 z-40">
  <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
    <h1 class="font-bold text-lg text-purple-400">BizLink 10X – ADMIN PANEL</h1>
    <div class="flex gap-4 items-center">
      <span class="text-sm text-slate-400">admin@bizlink.in</span>
      <button class="bg-red-600 px-4 py-1.5 rounded text-sm">Logout</button>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-8 space-y-10">

<!-- STATS -->
<section class="grid md:grid-cols-4 gap-4">
  <div class="card p-4 rounded">Active Clients<br><b id="statClients" class="text-2xl">—</b></div>
  <div class="card p-4 rounded">Freelancers<br><b id="statFreelancers" class="text-2xl">—</b></div>
  <div class="card p-4 rounded">Today Tasks<br><b id="statTasks" class="text-2xl">—</b></div>
  <div class="card p-4 rounded">Pending Proofs<br><b id="statPending" class="text-2xl text-yellow-400">—</b></div>
</section>

<!-- PLAN RULES -->
<section>
<h2 class="text-lg font-semibold mb-3">Plan Task Rules (Auto Assignment)</h2>
<div class="card rounded overflow-hidden">
<table class="w-full text-sm">
<thead class="bg-slate-800">
<tr>
<th class="p-3">Plan</th>
<th class="p-3">Task</th>
<th class="p-3">Frequency</th>
<th class="p-3">Freelancer</th>
<th class="p-3">Action</th>
</tr>
</thead>
<tbody id="planRulesBody"></tbody>
</table>
</div>

<div class="grid md:grid-cols-5 gap-3 mt-4">
<select id="rulePlan" class="p-2 bg-slate-900 rounded">
  <option>10X Grow Lab</option>
</select>
<select id="ruleTask" class="p-2 bg-slate-900 rounded">
  <option>Instagram Reel</option>
  <option>Google Business Post</option>
  <option>WhatsApp Follow-up</option>
  <option>Review Collection</option>
</select>
<select id="ruleFrequency" class="p-2 bg-slate-900 rounded">
  <option>Daily</option>
</select>
<select id="ruleFreelancer" class="p-2 bg-slate-900 rounded"></select>
<button onclick="savePlanRule()" class="bg-purple-600 rounded px-4 py-2 font-semibold">
Save Rule
</button>
</div>
</section>

<!-- CLIENT LIST -->
<section>
<h2 class="text-lg font-semibold mb-3">Client Master Control</h2>
<div class="card rounded overflow-hidden">
<table class="w-full text-sm">
<thead class="bg-slate-800">
<tr>
<th class="p-3">Client</th>
<th class="p-3">Plan</th>
<th class="p-3">Status</th>
<th class="p-3">Progress</th>
<th class="p-3">Action</th>
</tr>
</thead>
<tbody id="clientTableBody"></tbody>
</table>
</div>
</section>

</main>

<!-- CLIENT MODAL -->
<div id="clientModal" class="fixed inset-0 hidden modal-bg flex items-center justify-center z-50">
<div class="modal w-full max-w-3xl rounded-xl p-6 relative">

<button onclick="closeClient()" class="absolute top-3 right-4 text-xl">✕</button>

<h3 id="modalClientName" class="text-xl font-bold"></h3>
<p id="modalClientEmail" class="text-xs text-slate-400 mb-4"></p>

<div class="card rounded overflow-hidden">
<table class="w-full text-sm">
<thead class="bg-slate-800">
<tr>
<th class="p-3">Task</th>
<th class="p-3">Freelancer</th>
<th class="p-3">Status</th>
<th class="p-3">Action</th>
</tr>
</thead>
<tbody id="clientTaskBody"></tbody>
</table>
</div>

</div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyCKg6L51ayJOendAiK_FEWwC4v_Cm4oETucMJcApPj5qCFZuJPY4HOfDI0M3dD1bfOGg/exec";

/* ===============================
   1️⃣ LOAD ADMIN STATS
================================ */
async function loadStats() {
  const res = await fetch(`${API_URL}?action=getAdminStats`);
  const data = await res.json();

  document.getElementById("statClients").innerText = data.clients;
  document.getElementById("statFreelancers").innerText = data.freelancers;
  document.getElementById("statTasks").innerText = data.todayTasks;
  document.getElementById("statProofs").innerText = data.pendingProofs;
}

/* ===============================
   2️⃣ LOAD PLAN → TASK RULES
================================ */
async function loadPlanRules() {
  const res = await fetch(`${API_URL}?action=getPlanRules`);
  const data = await res.json();

  const tbody = document.getElementById("planRulesBody");
  tbody.innerHTML = "";

  data.rules.forEach(r => {
    tbody.innerHTML += `
      <tr>
        <td>${r.plan}</td>
        <td>${r.task}</td>
        <td>${r.frequency}</td>
        <td>${r.freelancer}</td>
        <td>
          <button onclick="editRule('${r.id}')" class="btn btn-sm">Edit</button>
        </td>
      </tr>`;
  });
}

/* ===============================
   3️⃣ SAVE / UPDATE PLAN RULE
================================ */
async function saveRule() {
  const payload = {
    action: "savePlanRule",
    plan: planSelect.value,
    task: taskSelect.value,
    frequency: freqSelect.value,
    freelancer: freelancerSelect.value
  };

  await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  });

  alert("Rule saved");
  loadPlanRules();
}

/* ===============================
   4️⃣ LOAD CLIENT LIST
================================ */
async function loadClients() {
  const res = await fetch(`${API_URL}?action=getClients`);
  const data = await res.json();

  const tbody = document.getElementById("clientTableBody");
  tbody.innerHTML = "";

  data.clients.forEach(c => {
    tbody.innerHTML += `
      <tr>
        <td>${c.name}<br><small>${c.email}</small></td>
        <td>${c.plan}</td>
        <td class="${c.status === 'ACTIVE' ? 'text-green' : 'text-red'}">${c.status}</td>
        <td>${c.completed}/${c.total}</td>
        <td>
          <button onclick="openClient('${c.clientId}')" class="btn btn-sm">
            View Control
          </button>
        </td>
      </tr>`;
  });
}

/* ===============================
   5️⃣ CLIENT TASKS + APPROVE / REJECT
================================ */
async function openClient(clientId) {
  const res = await fetch(`${API_URL}?action=getClientTasks&clientId=${clientId}`);
  const data = await res.json();

  const list = document.getElementById("clientTasks");
  list.innerHTML = "";

  data.tasks.forEach(t => {
    list.innerHTML += `
      <div class="task-row">
        <b>${t.task}</b> – ${t.freelancer}
        <span class="status">${t.status}</span>
        <button onclick="approveTask('${t.taskId}')">Approve</button>
        <button onclick="rejectTask('${t.taskId}')">Reject</button>
      </div>`;
  });

  document.getElementById("clientModal").classList.remove("hidden");
}

async function approveTask(taskId) {
  await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action:"approveTask", taskId })
  });
  alert("Approved");
}

async function rejectTask(taskId) {
  await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action:"rejectTask", taskId })
  });
  alert("Rejected");
}

/* ===============================
   INIT LOAD
================================ */
window.onload = () => {
  loadStats();
  loadPlanRules();
  loadClients();
};
</script>
</body>
</html>
