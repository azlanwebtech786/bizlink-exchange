<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>BizLink 10X – Client Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{font-family:Poppins;background:#050816;color:#e5e7eb}
.card{background:#0f172a;border:1px solid rgba(148,163,184,.2)}
.btn{padding:.4rem .8rem;border-radius:.4rem;font-size:.75rem;font-weight:600}
</style>
</head>

<body class="min-h-screen overflow-auto">

<!-- HEADER -->
<header class="sticky top-0 bg-slate-950 border-b border-slate-800 z-50">
  <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
    <a href="10x-admin-dashboard.html" class="text-sm text-slate-400">← Back</a>
    <h1 class="font-bold text-lg text-purple-400">Client Control</h1>
    <span class="text-sm text-slate-400">Admin</span>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

<!-- CLIENT INFO -->
<section class="grid sm:grid-cols-3 gap-4">
  <div class="card p-4 rounded">
    <div class="text-xs text-slate-400">Client</div>
    <div id="clientName" class="font-semibold">–</div>
    <div id="clientEmail" class="text-xs text-slate-400">–</div>
  </div>
  <div class="card p-4 rounded">
    <div class="text-xs text-slate-400">Plan</div>
    <div id="clientPlan" class="font-semibold">–</div>
    <div id="clientStatus" class="text-xs text-green-400">–</div>
  </div>
  <div class="card p-4 rounded">
    <div class="text-xs text-slate-400">Today Tasks</div>
    <div id="taskCount" class="text-2xl font-bold">0</div>
  </div>
</section>

<!-- TASK TABLE -->
<section>
<h2 class="font-semibold mb-2">Today Tasks & Proofs</h2>

<div class="card rounded overflow-x-auto">
<table class="w-full text-sm">
<thead class="bg-slate-800">
<tr>
  <th class="p-3 text-left">Task</th>
  <th class="p-3">Freelancer</th>
  <th class="p-3">Status</th>
  <th class="p-3">Proof</th>
  <th class="p-3">Action</th>
</tr>
</thead>
<tbody id="taskTable">
<tr>
  <td colspan="5" class="p-4 text-center text-slate-400">Loading...</td>
</tr>
</tbody>
</table>
</div>
</section>

</main>

<script>
/******** CONFIG ********/
const API =
"https://script.google.com/macros/s/AKfycbyCKg6L51ayJOendAiK_FEWwC4v_Cm4oETucMJcApPj5qCFZuJPY4HOfDI0M3dD1bfOGg/exec";

/******** HELPERS ********/
function qs(key){
  return new URLSearchParams(window.location.search).get(key);
}

/******** LOAD CLIENT ********/
async function loadClient(){
  const email = qs("email");
  if(!email){
    alert("Client not found");
    return;
  }

  const res = await fetch(`${API}?action=getClientDashboard&email=${encodeURIComponent(email)}`);
  const data = await res.json();

  if(!data.ok){
    alert(data.error || "Client not found");
    return;
  }

  document.getElementById("clientName").innerText = data.client.name;
  document.getElementById("clientEmail").innerText = email;
  document.getElementById("clientPlan").innerText = data.client.plan;
  document.getElementById("clientStatus").innerText = data.client.status;

  renderTasks(data.todayTasks || []);
}

/******** RENDER TASKS ********/
function renderTasks(tasks){
  const tbody = document.getElementById("taskTable");
  tbody.innerHTML = "";

  document.getElementById("taskCount").innerText = tasks.length;

  if(tasks.length === 0){
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="p-4 text-center text-slate-400">
          No tasks today
        </td>
      </tr>`;
    return;
  }

  tasks.forEach(t=>{
    const statusColor =
      t.status === "COMPLETED" ? "text-green-400" :
      t.status === "SUBMITTED" ? "text-yellow-400" :
      "text-slate-400";

    tbody.innerHTML += `
    <tr class="border-t border-slate-800">
      <td class="p-3">${t.task}</td>
      <td class="p-3">${t.assignedTo || "-"}</td>
      <td class="p-3 ${statusColor}">${t.status}</td>
      <td class="p-3">
        ${t.proof ? `<a href="${t.proof}" target="_blank" class="text-purple-400">View</a>` : "-"}
      </td>
      <td class="p-3 flex gap-2">
        <button onclick="approveTask('${t.taskId}')" class="btn bg-green-600">Approve</button>
        <button onclick="rejectTask('${t.taskId}')" class="btn bg-red-600">Reject</button>
      </td>
    </tr>`;
  });
}

/******** ACTIONS ********/
async function approveTask(taskId){
  await fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"submitTaskProof",
      taskId:taskId,
      proof:"APPROVED_BY_ADMIN"
    })
  });
  loadClient();
}

async function rejectTask(taskId){
  alert("Rejected – ask freelancer to resubmit");
}

/******** INIT ********/
loadClient();
</script>

</body>
</html>
