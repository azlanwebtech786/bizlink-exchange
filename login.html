<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BizLink | Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind & Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body{
      font-family:'Poppins',sans-serif;
      background:#050816;
      color:#e5e7eb;
    }
    .card-bg{
      background:#0f172a;
      border-radius:1.25rem;
      border:1px solid rgba(148,163,184,.35);
    }
    .button-gradient{
      background:linear-gradient(90deg,#a855f7 0%,#ec4899 100%);
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center px-4">

<main class="w-full max-w-md">
<section class="card-bg px-6 py-7">

<h1 class="text-center text-xl sm:text-2xl font-bold mb-1">
Login to <span class="text-purple-400">BizLink</span>
</h1>

<p class="text-center text-xs text-slate-400 mb-5">
Apne email aur password se login karein.
</p>

<p id="statusBox" class="text-xs text-slate-300 mb-3"></p>

<form id="loginForm" class="space-y-3">
<div>
<label class="block text-xs mb-1">Email</label>
<input id="email" type="email" required
class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700"/>
</div>

<div>
<label class="block text-xs mb-1">Password</label>
<input id="password" type="password" required
class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700"/>
</div>

<button id="loginBtn" type="submit"
class="w-full mt-2 button-gradient py-2.5 rounded text-sm font-semibold">
<span id="loginBtnText">Login</span>
<span id="loginSpinner" class="hidden">â€¦</span>
</button>
</form>

<p class="text-xs text-slate-400 mt-4 text-center">
Account nahi hai?
<a href="signup.html" class="text-purple-400 font-semibold">Sign up</a>
</p>

</section>
</main>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBtle51gX5kHufuWZ_YVOIQdDR05kbCE5I",
  authDomain: "bizlink-exchange.firebaseapp.com",
  projectId: "bizlink-exchange",
  storageBucket: "bizlink-exchange.firebasestorage.app",
  messagingSenderId: "116213651971",
  appId: "1:116213651971:web:fff60961af0c4da3448c36"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
</script>

<script>
const USERS_SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbztkBN5GcgZdPARgOSrvBvgJcfClCvXzIq0mEk64TpaShqQ4FzpFAjQ742Io70wyzNa/exec";

const statusBox = document.getElementById("statusBox");
const loginForm = document.getElementById("loginForm");

function setStatus(msg, type="info"){
statusBox.textContent = msg;
statusBox.className =
type==="error" ? "text-red-400 text-xs mb-3" :
"text-emerald-400 text-xs mb-3";
}

async function fetchProfile(email){
const r = await fetch(`${USERS_SCRIPT_URL}?action=getProfile&email=${encodeURIComponent(email)}`);
return r.json();
}

loginForm.addEventListener("submit", async (e)=>{
e.preventDefault();

const email = document.getElementById("email").value.trim().toLowerCase();
const password = document.getElementById("password").value;

try{
const cred = await auth.signInWithEmailAndPassword(email,password);
const authEmail = cred.user.email.toLowerCase();

/* ðŸ”¥ MOST IMPORTANT FIX */
localStorage.setItem("email", authEmail);
localStorage.setItem("bizlink_user_email", authEmail);

setStatus("Login successfulâ€¦");

const data = await fetchProfile(authEmail);

if(!data || !data.profile){
window.location.href="profile.html";
return;
}

const role = (data.profile.Role||"").toLowerCase();
const plan = data.profile.Plan || "Free";

localStorage.setItem("bizlinkPlan", plan);
localStorage.setItem("bizlinkBizID", data.profile.BizID || "");

if(role==="freelancer"){
window.location.href="freelancer-dashboard.html";
}else if(["owner","client","business"].includes(role)){
window.location.href="owner-dashboard.html";
}else{
window.location.href="profile.html";
}

}catch(err){
setStatus("Login failed","error");
}
});
</script>

</body>
</html>
