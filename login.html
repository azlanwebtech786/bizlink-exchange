<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BizLink | Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind & Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body{
      font-family:'Poppins',sans-serif;
      background:#050816;
      color:#e5e7eb;
    }
    .card-bg{
      background:#0f172a;
      border-radius:1.25rem;
      border:1px solid rgba(148,163,184,.35);
    }
    .button-gradient{
      background:linear-gradient(90deg,#a855f7 0%,#ec4899 100%);
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center px-4">

  <main class="w-full max-w-md">
    <section class="card-bg px-6 py-7">
      <h1 class="text-center text-xl sm:text-2xl font-bold mb-1">
        Login to <span class="text-purple-400">BizLink</span>
      </h1>
      <p class="text-center text-xs text-slate-400 mb-5">
        Apne email aur password se login karein. Role ke hisaab se aapko sahi dashboard par bhej diya jayega.
      </p>

      <p id="statusBox" class="text-xs text-slate-300 mb-3"></p>

      <form id="loginForm" class="space-y-3">
        <div>
          <label class="block text-xs text-slate-300 mb-1" for="email">Email</label>
          <input
            id="email"
            type="email"
            required
            class="w-full px-3 py-2 text-sm rounded-lg bg-slate-900 border border-slate-700
                   focus:outline-none focus:ring-2 focus:ring-purple-500"
            placeholder="you@example.com"
          />
        </div>

        <div>
          <label class="block text-xs text-slate-300 mb-1" for="password">Password</label>
          <input
            id="password"
            type="password"
            required
            class="w-full px-3 py-2 text-sm rounded-lg bg-slate-900 border border-slate-700
                   focus:outline-none focus:ring-2 focus:ring-purple-500"
            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
          />
        </div>

        <button
          id="loginBtn"
          type="submit"
          class="w-full mt-2 button-gradient text-white text-sm font-semibold py-2.5 rounded-lg
                 flex items-center justify-center gap-2 disabled:opacity-60"
        >
          <span id="loginBtnText">Login</span>
          <span id="loginSpinner" class="hidden text-xs">â€¦</span>
        </button>
      </form>

      <p class="text-[11px] text-slate-400 mt-4 text-center leading-relaxed">
        Login ke baad hum aapka profile
        <span class="font-semibold text-slate-100">BizLink_Users â†’ Users</span> sheet se check karte hain.
        <br/>
        â€¢ Agar role <span class="text-emerald-300 font-semibold">freelancer</span> hua to
        <span class="font-semibold">Freelancer Dashboard</span>  
        â€¢ Agar role <span class="text-sky-300 font-semibold">owner / business / client</span> hua to
        <span class="font-semibold">Owner Dashboard</span>  
        â€¢ Warna aapko <span class="font-semibold">My Profile</span> page par bhej diya jayega.
      </p>

      <p class="text-[11px] text-slate-500 mt-4 text-center">
        Abhi tak account nahi hai?
        <a href="signup.html" class="text-purple-400 hover:text-purple-300 font-semibold">
          Sign up karein
        </a>
      </p>
    </section>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script>
    // ---- Firebase config (same as baaki pages) ----
    const firebaseConfig = {
      apiKey: "AIzaSyBtle51gX5kHufuWZ_YVOIQdDR05kbCE5I",
      authDomain: "bizlink-exchange.firebaseapp.com",
      projectId: "bizlink-exchange",
      storageBucket: "bizlink-exchange.firebasestorage.app",
      messagingSenderId: "116213651971",
      appId: "1:116213651971:web:fff60961af0c4da3448c36",
      measurementId: "G-VQ3JM82D1N"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
  </script>

  <!-- Login + Role Routing Logic -->
  <script>
    // Users Apps Script (BizLink_Users project)
    const USERS_SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbztkBN5GcgZdPARgOSrvBvgJcfClCvXzIq0mEk64TpaShqQ4FzpFAjQ742Io70wyzNa/exec";

    const statusBox   = document.getElementById("statusBox");
    const loginForm   = document.getElementById("loginForm");
    const loginBtn    = document.getElementById("loginBtn");
    const loginText   = document.getElementById("loginBtnText");
    const loginSpin   = document.getElementById("loginSpinner");

    function setStatus(msg, type="info") {
      statusBox.textContent = msg || "";
      if (!msg) {
        statusBox.className = "text-xs text-slate-300 mb-3";
      } else if (type === "error") {
        statusBox.className = "text-xs text-red-300 mb-3";
      } else {
        statusBox.className = "text-xs text-emerald-300 mb-3";
      }
    }

    function setLoading(isLoading) {
      loginBtn.disabled = isLoading;
      if (isLoading) {
        loginText.textContent = "Logging in...";
        loginSpin.classList.remove("hidden");
      } else {
        loginText.textContent = "Login";
        loginSpin.classList.add("hidden");
      }
    }

    async function fetchProfileByEmail(email) {
      try {
        const url = `${USERS_SCRIPT_URL}?action=getProfile&email=${encodeURIComponent(email)}`;
        const res = await fetch(url);
        return await res.json();
      } catch (err) {
        console.error("getProfile error:", err);
        return null;
      }
    }

    function routeByRole(role) {
      const r = (role || "").toLowerCase().trim();

      // Save for future pages
      try {
        if (r) localStorage.setItem("bizlink_user_role", r);
      } catch (e) {}

      if (r === "freelancer") {
        window.location.href = "freelancer-dashboard.html";
      } else if (["owner","business","client","business_owner","work owner"].includes(r)) {
        window.location.href = "owner-dashboard.html";
      } else {
        // Fallback: profile page
        window.location.href = "profile.html";
      }
    }

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = document.getElementById("email").value.trim().toLowerCase();
      const password = document.getElementById("password").value;

      if (!email || !password) {
        setStatus("Email aur password required hai.", "error");
        return;
      }

      setLoading(true);
      setStatus("Logging inâ€¦");

      try {
        const cred = await auth.signInWithEmailAndPassword(email, password);
        const user = cred.user;

       const authEmail = (user.email || "").toLowerCase();

// ðŸ”¥ FIX â€“ DONO KEYS ME SAVE
localStorage.setItem("email", authEmail);
localStorage.setItem("bizlink_user_email", authEmail);

        } catch (e) {}

        setStatus("Login successful. Profile check ho raha haiâ€¦");

        // ---- Fetch profile from Users sheet ----
        const data = await fetchProfileByEmail(authEmail);

        let role = null;
        let plan = null;

        if (data && data.profile) {
          const p = data.profile;
          role = (p.Role || "").toLowerCase();
          plan = p.Plan || "Free";

          try {
            if (plan) localStorage.setItem("bizlinkPlan", plan);
            if (p.BizID) localStorage.setItem("bizlinkBizID", p.BizID);
          } catch (e) {}
        }

        // Agar profile nahi mila, phir bhi login ho chuka hai â†’ profile page pe bhej do
        if (!role) {
          setStatus("Profile sheet me entry nahi mili, aapko profile page par le ja rahe hainâ€¦");
          window.location.href = "profile.html";
          return;
        }

        setStatus(`Role detected: ${role}. Redirectingâ€¦`);
        routeByRole(role);

      } catch (err) {
        console.error(err);
        let msg = "Login failed. Email/password check karein.";
        if (err.code === "auth/user-not-found") msg = "User nahi mila. Pehle signup karein.";
        if (err.code === "auth/wrong-password") msg = "Galat password. Dobara try karein.";
        if (err.code === "auth/too-many-requests") msg = "Too many attempts. Thodi der baad try karein.";
        setStatus(msg, "error");
      } finally {
        setLoading(false);
      }
    });

    // Agar user already logged in hai to direct route kar do
    auth.onAuthStateChanged(async (user) => {
      if (!user) return;
      const email = (user.email || "").toLowerCase();
      try {
        localStorage.setItem("bizlink_user_email", email);
      } catch (e) {}

      setStatus("Already logged in. Profile check ho raha haiâ€¦");

      const data = await fetchProfileByEmail(email);
      let role = null;
      let plan = null;

      if (data && data.profile) {
        const p = data.profile;
        role = (p.Role || "").toLowerCase();
        plan = p.Plan || "Free";
        try {
          if (plan) localStorage.setItem("bizlinkPlan", plan);
          if (p.BizID) localStorage.setItem("bizlinkBizID", p.BizID);
        } catch (e) {}
      }

      routeByRole(role);
    });
  </script>
</body>
</html>
